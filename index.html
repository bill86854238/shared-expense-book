<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <!-- viewport ç”± Code.gs çš„ addMetaTag è¨­å®š -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>å…±åŒè¨˜å¸³ v2.15</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {'packages':['corechart', 'line']});
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      font-size: 16px; /* åŸºç¤å­—é«”å¤§å°ï¼Œç¢ºä¿ç§»å‹•ç«¯å¯è®€æ€§ */
      -webkit-text-size-adjust: 100%; /* é˜²æ­¢ iOS è‡ªå‹•èª¿æ•´å­—é«” */
    }

    .container {
      width: 100%; /* æ‰‹æ©Ÿä¸Šä½”æ»¿å¯¬åº¦ */
      max-width: 800px; /* æ¡Œé¢æœ€å¤§å¯¬åº¦ */
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2em;
    }

    .subtitle {
      text-align: center;
      color: #999;
      font-size: 0.9em;
      margin-bottom: 30px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .stat-card.you {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }

    .stat-card.partner {
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
    }

    .stat-card.balance {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }

    .stat-icon {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 1.6em;
      font-weight: bold;
      color: #333;
    }

    @media (max-width: 600px) {
      .stat-value {
        font-size: 1.4em;
      }
    }

    .form-section {
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }

    .form-section:focus-within {
      border-color: #667eea;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #374151;
      font-weight: 500;
      font-size: 0.9em;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    input::placeholder {
      color: #9ca3af;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-loading {
      position: relative;
      color: transparent;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .expenses-list {
      margin-top: 16px;
    }

    .date-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin: 16px 0 8px 0;
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border-radius: 6px;
      border-left: 3px solid #667eea;
      font-weight: 600;
    }

    .date-header:first-child {
      margin-top: 0;
    }

    .date-text {
      color: #334155;
      font-size: 0.88em;
      font-weight: 600;
    }

    .date-total {
      color: #667eea;
      font-size: 0.92em;
      font-weight: 700;
    }

    .expense-item {
      padding: 10px 14px;
      border-radius: 8px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease-out;
      border: 2px solid transparent;
      gap: 12px;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .expense-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12);
    }

    .expense-item.you {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-left: 3px solid #3b82f6;
    }

    .expense-item.partner {
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      border-left: 3px solid #ec4899;
    }

    .expense-item.both {
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      border-left: 3px solid #a855f7;
    }

    .expense-info {
      flex: 1;
      min-width: 0;
      line-height: 1.5;
    }

    .expense-info strong {
      font-size: 0.95em;
      display: block;
      margin-bottom: 3px;
    }

    .expense-info > div {
      margin-bottom: 0;
    }

    .expense-amount {
      font-size: 1.2em;
      font-weight: 700;
      color: #1f2937;
      white-space: nowrap;
      letter-spacing: -0.5px;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 4em;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      animation: slideInRight 0.3s ease-out;
      max-width: 300px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .toast-icon {
      font-size: 1.5em;
    }

    .toast-message {
      flex: 1;
      color: #333;
      font-weight: 500;
    }

    .hidden {
      display: none !important;
    }

    h2 {
      color: #374151;
      font-size: 1.3em;
      margin-bottom: 15px;
    }

    .filter-section {
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease-out;
    }

    .modal.hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideIn 0.3s ease-out;
    }

    .chart-container {
      margin: 20px 0;
    }

    .chart-tab {
      padding: 10px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.95em;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .chart-tab:hover {
      color: #667eea;
    }

    .chart-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }

    .chart-tab-content {
      animation: fadeIn 0.3s ease-in;
    }

    .chart-tab-content.hidden {
      display: none;
    }

    .chart-bar {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .chart-label {
      width: 100px;
      font-size: 0.9em;
      color: #666;
    }

    .chart-bar-bg {
      flex: 1;
      height: 30px;
      background: #e5e7eb;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .chart-bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease-out;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: bold;
      font-size: 0.85em;
    }

    .expense-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    .edit-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .edit-btn:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(16, 185, 129, 0.25);
    }

    .edit-btn:active {
      transform: translateY(0);
    }

    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.8em;
      font-weight: 500;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .delete-btn:hover {
      background: #dc2626;
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(239, 68, 68, 0.25);
    }

    .delete-btn:active {
      transform: translateY(0);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #667eea;
      object-fit: cover;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .user-name {
      font-size: 0.9em;
      color: #667eea;
      font-weight: 600;
    }

    .user-email {
      font-size: 0.75em;
      color: #999;
    }

    .logout-btn {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .members-btn {
      padding: 6px 12px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .members-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }

    .member-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .member-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }

    .member-card.owner {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #3b82f6;
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .member-badge {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: 600;
    }

    .remove-member-btn {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .remove-member-btn:hover {
      background: #dc2626;
    }

    .quick-btn {
      padding: 8px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .quick-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .split-method-btn {
      flex: 1;
      padding: 10px 12px;
      background: #f3f4f6;
      color: #6b7280;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .split-method-btn:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
    }

    .split-method-btn.active {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #10b981;
    }

    .quick-btn:active {
      transform: translateY(0);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .dashboard-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f3f4f6;
    }

    .dashboard-icon {
      font-size: 1.3em;
    }

    .dashboard-title {
      font-weight: 600;
      color: #374151;
      font-size: 1em;
    }

    .dashboard-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .dashboard-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-label {
      font-size: 0.9em;
      color: #6b7280;
    }

    .dashboard-value {
      font-size: 1.1em;
      font-weight: 600;
      color: #667eea;
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85em;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }

    .trend-up {
      background: #fee2e2;
      color: #dc2626;
    }

    .trend-down {
      background: #dcfce7;
      color: #16a34a;
    }

    .trend-neutral {
      background: #e5e7eb;
      color: #6b7280;
    }

    /* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ (RWD) ==================== */

    /* å¤§è¢å¹• (æ¡Œæ©Ÿ) - 1200px ä»¥ä¸Š */
    @media (min-width: 1200px) {
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .stats {
        grid-template-columns: repeat(3, 1fr);
      }

      .dashboard {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ä¸­ç­‰è¢å¹• (å¹³æ¿æ©«å‘) - 768px åˆ° 1199px */
    @media (min-width: 768px) and (max-width: 1199px) {
      .container {
        padding: 30px;
      }

      .stats {
        grid-template-columns: repeat(3, 1fr);
      }

      .dashboard {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-section {
        padding: 25px;
      }
    }

    /* å°è¢å¹• (å¹³æ¿ç›´å‘) - 600px åˆ° 767px */
    @media (min-width: 600px) and (max-width: 767px) {
      .container {
        padding: 25px;
      }

      h1 {
        font-size: 1.8em;
      }

      .stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-card:last-child {
        grid-column: 1 / -1;
      }

      .dashboard {
        grid-template-columns: 1fr;
      }

      .quick-btn {
        flex: 1 1 calc(33.333% - 8px);
        min-width: 100px;
      }
    }

    /* æ‰‹æ©Ÿ - 600px ä»¥ä¸‹ */
    @media (max-width: 599px) {
      body {
        padding: 10px;
        font-size: 16px; /* ç¢ºä¿åŸºç¤å­—é«”ä¸æœƒå¤ªå° */
      }

      .container {
        width: 100%; /* å¼·åˆ¶ä½”æ»¿å¯¬åº¦ */
        max-width: none; /* ç§»é™¤æœ€å¤§å¯¬åº¦é™åˆ¶ */
        padding: 15px;
        margin: 0; /* ç§»é™¤è‡ªå‹•ç½®ä¸­ */
        border-radius: 15px; /* ç¨å¾®ç¸®å°åœ“è§’ */
      }

      h1 {
        font-size: 1.5em; /* å¢å¤§æ¨™é¡Œ */
      }

      h2 {
        font-size: 1.2em; /* å¢å¤§å‰¯æ¨™é¡Œ */
      }

      .subtitle {
        font-size: 0.9em;
      }

      /* çµ±è¨ˆå¡ç‰‡ - å‚ç›´æ’åˆ— */
      .stats {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .stat-card {
        padding: 20px; /* å¢åŠ å…§è· */
      }

      .stat-label {
        font-size: 0.95em;
      }

      .stat-value {
        font-size: 1.8em; /* å¢å¤§æ•¸å­— */
      }

      /* å„€è¡¨æ¿ - å‚ç›´æ’åˆ— */
      .dashboard {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .dashboard-card {
        padding: 20px; /* å¢åŠ å…§è· */
      }

      .dashboard-label {
        font-size: 0.95em;
      }

      .dashboard-value {
        font-size: 1.1em;
      }

      /* è¡¨å–® */
      .form-section {
        padding: 20px;
      }

      .form-group {
        margin-bottom: 20px; /* å¢åŠ é–“è· */
      }

      .form-group label {
        font-size: 1em; /* å¢å¤§æ¨™ç±¤å­—é«” */
        margin-bottom: 10px;
      }

      .form-group input,
      .form-group select {
        font-size: 16px; /* é‡è¦ï¼šiOS æœƒåœ¨ <16px æ™‚è‡ªå‹•ç¸®æ”¾ */
        padding: 14px; /* å¢å¤§é»æ“Šå€åŸŸ */
        min-height: 48px; /* iOS å»ºè­°æœ€å°é»æ“Šå€åŸŸ */
      }

      /* å¿«é€Ÿè¨˜å¸³æŒ‰éˆ• - æ¯è¡Œ 2 å€‹ */
      .quick-btn {
        flex: 1 1 calc(50% - 4px);
        min-width: 0;
        font-size: 0.95em; /* å¢å¤§å­—é«” */
        padding: 12px 8px; /* å¢å¤§é»æ“Šå€åŸŸ */
        min-height: 44px; /* iOS å»ºè­°æœ€å°é»æ“Šå€åŸŸ */
      }

      /* æ—¥æœŸæ¨™é¡Œ */
      .date-header {
        padding: 8px 10px;
        margin: 15px 0 8px 0;
        font-size: 0.9em;
      }

      .date-text {
        font-size: 0.9em;
      }

      .date-total {
        font-size: 0.95em;
      }

      /* æ”¯å‡ºè¨˜éŒ„ */
      .expense-item {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
        padding: 12px; /* ç·Šæ¹Šä¸€é» */
      }

      .expense-item > div:last-child {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: nowrap;
        gap: 10px;
      }

      .expense-info {
        margin-bottom: 4px;
      }

      .expense-info strong {
        font-size: 1em;
        display: block;
        margin-bottom: 4px;
      }

      .expense-amount {
        font-size: 1.1em;
        margin-left: 0;
        flex: 0 0 auto;
        min-width: 80px;
      }

      .expense-actions {
        display: flex;
        gap: 6px;
        flex: 0 0 auto;
      }

      .edit-btn,
      .delete-btn {
        padding: 10px 12px;
        font-size: 0.85em;
        flex: 0 0 auto;
        min-height: 40px;
        min-width: 60px;
      }

      /* Toast é€šçŸ¥ */
      .toast {
        left: 15px;
        right: 15px;
        max-width: none;
        font-size: 1em; /* å¢å¤§æç¤ºå­—é«” */
        padding: 16px;
      }

      /* ä½¿ç”¨è€…è³‡è¨Š */
      .user-name {
        display: none;
      }

      .user-email {
        font-size: 0.8em;
      }

      .user-avatar {
        width: 36px; /* å¢å¤§é ­åƒ */
        height: 36px;
      }

      /* Modal */
      .modal-content {
        width: 95%;
        max-width: none;
        padding: 20px;
      }

      /* æŒ‰éˆ• */
      .btn {
        font-size: 1em; /* å¢å¤§æŒ‰éˆ•å­—é«” */
        padding: 14px 24px; /* å¢å¤§æŒ‰éˆ• */
        min-height: 48px; /* iOS å»ºè­°æœ€å°é»æ“Šå€åŸŸ */
      }

      .members-btn,
      .logout-btn {
        padding: 10px 14px; /* å¢å¤§æŒ‰éˆ• */
        font-size: 0.9em;
        min-height: 40px; /* ç¢ºä¿å¯é»æ“Š */
      }

      /* ä¸‹æ‹‰é¸å–®å„ªåŒ– */
      #dashboardPeriod {
        font-size: 0.95em;
        padding: 10px 12px;
        min-height: 44px;
      }

      /* æ—¥æœŸç¯„åœç¯©é¸ - æ‰‹æ©Ÿç‰ˆå‚ç›´ä½ˆå±€ */
      .date-filter-section {
        flex-direction: column !important;
        align-items: stretch !important;
      }

      .date-filter-section > div {
        width: 100% !important;
        min-width: auto !important;
      }

      .date-filter-section input[type="date"] {
        min-width: auto !important;
        font-size: 14px;
        padding: 12px;
      }

      .date-filter-section button {
        flex: 1;
        font-size: 0.95em;
      }

      /* ç§»é™¤æ—¥æœŸå’Œæ™‚é–“è¼¸å…¥æ¡†çš„ icon */
      input[type="date"]::-webkit-calendar-picker-indicator,
      input[type="time"]::-webkit-calendar-picker-indicator {
        display: none;
        -webkit-appearance: none;
      }

      input[type="date"],
      input[type="time"] {
        -webkit-appearance: none;
        -moz-appearance: textfield;
      }
    }

    /* æ¥µå°è¢å¹• - 400px ä»¥ä¸‹ */
    @media (max-width: 400px) {
      .container {
        width: 100%;
        max-width: none;
        padding: 10px;
        margin: 0;
        border-radius: 12px;
      }

      h1 {
        font-size: 1.2em;
      }

      .quick-btn {
        font-size: 0.8em;
        padding: 8px;
      }

      .stat-icon {
        font-size: 1.5em;
      }

      .stat-label {
        font-size: 0.8em;
      }

      .stat-value {
        font-size: 1.3em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; gap: 12px; flex-wrap: wrap;">
      <div style="display: flex; align-items: center; gap: 12px; position: relative;">
        <div style="position: relative;">
          <h1 id="modeTitle" onclick="toggleModeMenu()" style="margin: 0; flex-shrink: 0; cursor: pointer; user-select: none; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ’‘ å…±åŒè¨˜å¸³</span>
            <span style="font-size: 0.5em; opacity: 0.6;">â–¼</span>
          </h1>
          <!-- æ¨¡å¼é¸å–® -->
          <div id="modeMenu" class="hidden" style="position: absolute; top: 100%; left: 0; margin-top: 8px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 8px; min-width: 200px; z-index: 1000;">
            <div onclick="selectMode('å…±åŒè¨˜å¸³')" style="padding: 12px 16px; cursor: pointer; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 10px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
              <span style="font-size: 1.5em;">ğŸ’‘</span>
              <div>
                <div style="font-weight: 500;">å…±åŒè¨˜å¸³</div>
                <div style="font-size: 0.85em; color: #666;">å…©äººåˆ†å¸³ã€é¤˜é¡çµç®—</div>
              </div>
            </div>
            <div onclick="selectMode('å€‹äººè¨˜å¸³')" style="padding: 12px 16px; cursor: pointer; border-radius: 8px; transition: background 0.2s; display: flex; align-items: center; gap: 10px;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='white'">
              <span style="font-size: 1.5em;">ğŸ‘¤</span>
              <div>
                <div style="font-weight: 500;">å€‹äººè¨˜å¸³</div>
                <div style="font-size: 0.85em; color: #666;">è¨˜éŒ„å€‹äººé–‹éŠ·</div>
              </div>
            </div>
          </div>
        </div>
        <button onclick="openSettingsModal()" style="background: none; border: none; font-size: 1.3em; cursor: pointer; padding: 5px; opacity: 0.6; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'" title="é…è‰²è¨­å®š">âš™ï¸</button>
      </div>
      <div id="userInfo" style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
        <div style="font-size: 0.9em; color: #999;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    <div class="subtitle">è®“éŒ¢çš„äº‹è®Šç°¡å–®</div>

    <!-- çµç®—å¡ç‰‡ - æœ€é‡è¦çš„è³‡è¨Š -->
    <div class="settlement-section" style="margin-bottom: 20px;">
      <div class="stat-card balance" style="width: 100%; max-width: 100%;">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-label">çµç®—</div>
        <div class="stat-value" id="balance" style="color: #999;">çµç®—ä¸­...</div>
      </div>
    </div>


    <!-- æ–°å¢æ”¯å‡ºè¡¨å–® -->
    <div class="form-section">
      <h2 style="margin-bottom: 15px;">ğŸ’° æ–°å¢æ”¯å‡º</h2>

      <!-- å¿«é€Ÿè¨˜è´¦æŒ‰é’® -->
      <div style="margin-bottom: 20px;">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px; font-weight: 500;">âš¡ å¿«é€Ÿè¨˜å¸³</div>
        <div id="quickExpenseButtons" style="display: flex; flex-wrap: wrap; gap: 8px;">
          <!-- æŒ‰éˆ•å°‡å¾è©¦ç®—è¡¨å‹•æ…‹è¼‰å…¥ -->
          <div style="color: #999; font-size: 0.9em;">è¼‰å…¥ä¸­...</div>
        </div>
      </div>

      <div class="form-group">
        <label>æ—¥æœŸæ™‚é–“</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <input type="date" id="expenseDate" style="width: 100%; min-width: 0; cursor: pointer;">
          <input type="time" id="expenseTime" style="width: 100%; min-width: 0; cursor: pointer;">
        </div>
      </div>

      <div class="form-group">
        <label>é …ç›®</label>
        <input type="text" id="item" placeholder="ä¾‹å¦‚ï¼šè²·èœã€å¤–é£Ÿ">
      </div>

      <div class="form-group">
        <label>é‡‘é¡</label>
        <input type="number" id="amount" placeholder="0">
      </div>

      <div class="form-group payer-field">
        <label>èª°ä»˜éŒ¢</label>
        <select id="actualPayer" onchange="updatePaymentMethod()">
          <option value="you">æˆ‘</option>
          <option value="partner">å°æ–¹</option>
          <option value="each">å„ä»˜å„çš„</option>
          <option value="unequal">ä¸ç­‰é¡å¢Šä»˜</option>
        </select>
      </div>

      <!-- ä¸ç­‰é¡å¢Šä»˜çš„é‡‘é¡è¼¸å…¥ -->
      <div class="form-group payer-field hidden" id="unequalPaymentFields">
        <label>å¯¦éš›ä»˜æ¬¾é‡‘é¡</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <label style="font-size: 0.9em; color: #666; font-weight: normal;">ä½ ä»˜äº†</label>
            <input type="number" id="yourActualPaid" placeholder="0" min="0" step="0.01" oninput="updateUnequalPaymentHint()">
          </div>
          <div>
            <label style="font-size: 0.9em; color: #666; font-weight: normal;">å°æ–¹ä»˜äº†</label>
            <input type="number" id="partnerActualPaid" placeholder="0" min="0" step="0.01" oninput="updateUnequalPaymentHint()">
          </div>
        </div>
        <div id="unequalPaymentHint" style="margin-top: 8px; font-size: 0.85em; color: #666;">
          ğŸ’¡ æç¤ºï¼šå…©è€…ç¸½å’Œå¿…é ˆç­‰æ–¼ä¸Šæ–¹é‡‘é¡
        </div>
      </div>

      <div class="form-group split-field">
        <label>å¹«èª°ä»˜æ¬¾ï¼ˆå¯è¤‡é¸ï¼‰</label>
        <div style="display: flex; gap: 20px; align-items: center;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="payForYou" onchange="updatePaymentMethod()" checked>
            <span>æˆ‘</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="payForPartner" onchange="updatePaymentMethod()">
            <span>å°æ–¹</span>
          </label>
        </div>
      </div>

      <div class="form-group split-field hidden" id="splitMethodGroup">
        <label>åˆ†å¸³æ–¹å¼</label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <button type="button" id="autoSplitBtn" class="split-method-btn active" onclick="setSplitMethod('auto')">è‡ªå‹•å‡åˆ†</button>
          <button type="button" id="amountSplitBtn" class="split-method-btn" onclick="setSplitMethod('amount')">é‡‘é¡åˆ†å¸³</button>
          <button type="button" id="ratioSplitBtn" class="split-method-btn" onclick="setSplitMethod('ratio')">æ¯”ä¾‹åˆ†å¸³</button>
        </div>
      </div>

      <div class="form-group split-field hidden" id="amountSplitGroup">
        <label>è‡ªè¨‚åˆ†å¸³é‡‘é¡</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <input type="number" id="yourPartAmount" placeholder="ä½ çš„éƒ¨åˆ†" onchange="updatePaymentMethod()">
          </div>
          <div>
            <input type="number" id="partnerPartAmount" placeholder="å°æ–¹çš„éƒ¨åˆ†" onchange="updatePaymentMethod()">
          </div>
        </div>
        <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
          æç¤ºï¼šç¸½å’Œå¿…é ˆç­‰æ–¼ä¸Šæ–¹é‡‘é¡
        </div>
      </div>

      <div class="form-group split-field hidden" id="ratioSplitGroup">
        <label>è‡ªè¨‚åˆ†å¸³æ¯”ä¾‹</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <input type="number" id="yourPartRatio" placeholder="ä½ çš„æ¯”ä¾‹ %" min="0" max="100" onchange="updatePaymentMethod()">
          </div>
          <div>
            <input type="number" id="partnerPartRatio" placeholder="å°æ–¹çš„æ¯”ä¾‹ %" min="0" max="100" onchange="updatePaymentMethod()">
          </div>
        </div>
        <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
          æç¤ºï¼šç¸½å’Œå¿…é ˆç­‰æ–¼ 100%
        </div>
      </div>

      <div class="form-group">
        <label>åˆ†é¡</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <select id="mainCategory" onchange="updateSubCategories()">
            <option value="">è¼‰å…¥ä¸­...</option>
          </select>
          <select id="subCategory" style="display: none;">
            <option value="">ï¼ˆé¸å¡«å­åˆ†é¡ï¼‰</option>
          </select>
        </div>
      </div>

      <!-- é€±æœŸæ”¯å‡ºè¨­å®š -->
      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="isRecurring" onchange="toggleRecurringDay()" style="width: auto; cursor: pointer;">
          <span>ğŸ”„ è¨­ç‚ºé€±æœŸæ”¯å‡ºï¼ˆæ¯æœˆå›ºå®šæ—¥æœŸè‡ªå‹•è¨˜å¸³ï¼‰</span>
        </label>
      </div>

      <div class="form-group hidden" id="recurringDayGroup">
        <label>æ¯æœˆåŸ·è¡Œæ—¥ï¼ˆ1-31ï¼‰</label>
        <input type="number" id="recurringDay" placeholder="ä¾‹å¦‚ï¼š1ï¼ˆæ¯æœˆ 1 è™Ÿï¼‰" min="1" max="31">
        <small style="color: #666; font-size: 0.85em; margin-top: 5px; display: block;">
          ğŸ’¡ ç³»çµ±æœƒåœ¨æ¯æœˆæŒ‡å®šæ—¥æœŸçš„æ—©ä¸Š 9:00 è‡ªå‹•æ–°å¢æ­¤ç­†æ”¯å‡º
        </small>
      </div>

      <div style="display: flex; gap: 10px;">
        <button class="btn btn-primary" onclick="addExpense()" style="flex: 1;">æ–°å¢æ”¯å‡º</button>
        <button class="btn settlement-section" onclick="openSettlementModal()" style="flex: 1; background: #10b981; color: white;">ğŸ’° è¨˜éŒ„çµç®—</button>
      </div>
    </div>

    <!-- å„€è¡¨æ¿ -->
    <div style="margin-bottom: 10px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0; font-size: 1.1em; color: #374151;">ğŸ“Š æ•¸æ“šåˆ†æ</h2>
        <select id="dashboardPeriod" onchange="changeDashboardPeriod()" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9em; cursor: pointer; background: white; color: #374151; font-weight: 500;">
          <option value="currentMonth">æœ¬æœˆ</option>
          <option value="lastMonth">ä¸Šæœˆ</option>
          <option value="last7days">æœ€è¿‘ 7 å¤©</option>
          <option value="last30days">æœ€è¿‘ 30 å¤©</option>
          <option value="currentYear">ä»Šå¹´</option>
          <option value="all">å…¨éƒ¨</option>
          <option value="custom">è‡ªè¨‚ç¯„åœ</option>
          <option value="comparison">æœ¬æœˆ vs ä¸Šæœˆ</option>
        </select>
      </div>

      <!-- è‡ªè¨‚ç¯„åœé¸æ“‡å™¨ -->
      <div id="customRangeSelector" class="hidden" style="margin-bottom: 15px; padding: 15px; background: #f9fafb; border-radius: 8px;">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <label style="font-size: 0.9em; color: #374151; font-weight: 500;">é–‹å§‹æ—¥æœŸï¼š</label>
          <input type="date" id="customStartDate" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9em;">
          <label style="font-size: 0.9em; color: #374151; font-weight: 500;">çµæŸæ—¥æœŸï¼š</label>
          <input type="date" id="customEndDate" style="padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9em;">
          <button onclick="applyCustomRange()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 500;">å¥—ç”¨</button>
        </div>
      </div>
    </div>

    <div class="dashboard">
      <div class="dashboard-card">
        <div class="dashboard-header">
          <span class="dashboard-icon" id="dashboardIcon1">ğŸ“…</span>
          <span class="dashboard-title" id="dashboardTitle1">æœ¬æœˆæ¦‚æ³</span>
        </div>
        <div class="dashboard-content">
          <div class="dashboard-row">
            <span class="dashboard-label" id="label1">ç¸½æ”¯å‡º</span>
            <span class="dashboard-value" id="value1">$0</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label" id="label2">è¨˜éŒ„æ•¸</span>
            <span class="dashboard-value" id="value2">0 ç­†</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label" id="label3">åˆ†é¡å æ¯”</span>
            <span class="dashboard-value" id="value3" style="font-size: 0.85em; line-height: 1.4;">-</span>
          </div>
        </div>
      </div>

      <div class="dashboard-card">
        <div class="dashboard-header">
          <span class="dashboard-icon">ğŸ‘¥</span>
          <span class="dashboard-title" id="dashboardTitle2">ä»˜æ¬¾çµ±è¨ˆ</span>
        </div>
        <div class="dashboard-content">
          <div class="dashboard-row settlement-section">
            <span class="dashboard-label">ğŸ‘¤ ä½ æ‡‰è² æ“”</span>
            <span class="dashboard-value" id="yourTotal">$0</span>
          </div>
          <div class="dashboard-row settlement-section">
            <span class="dashboard-label">ğŸ‘¤ å°æ–¹æ‡‰è² æ“”</span>
            <span class="dashboard-value" id="partnerTotal">$0</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label">ğŸ“Š ç¸½æ”¯å‡º</span>
            <span class="dashboard-value" id="totalExpense">$0</span>
          </div>
        </div>
      </div>

      <div class="dashboard-card" id="comparisonCard">
        <div class="dashboard-header">
          <span class="dashboard-icon">ğŸ“ˆ</span>
          <span class="dashboard-title" id="dashboardTitle3">è¶¨å‹¢</span>
        </div>
        <div class="dashboard-content" id="dashboardContent3">
          <div class="dashboard-row">
            <span class="dashboard-label" id="label4">ç¸½æ”¯å‡º</span>
            <span class="dashboard-value" id="value4">$0</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label" id="label5">æ—¥å‡æ”¯å‡º</span>
            <span class="dashboard-value" id="value5">$0</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label" id="label6">è¨˜å¸³æ¬¡æ•¸</span>
            <span class="dashboard-value" id="value6">0 ç­†</span>
          </div>
        </div>
      </div>
    </div>

    <div class="filter-section">
      <h2 style="margin-bottom: 15px;">ğŸ“‹ æ”¯å‡ºè¨˜éŒ„</h2>

      <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹é …ç›®..." style="width: 100%;">
        </div>
        <div style="flex: 1; min-width: 150px;">
          <select id="filterCategory" style="width: 100%;">
            <option value="">å…¨éƒ¨åˆ†é¡</option>
            <option value="é£²é£Ÿ">ğŸœ é£²é£Ÿ</option>
            <option value="å±…ä½">ğŸ  å±…ä½</option>
            <option value="äº¤é€š">ğŸš— äº¤é€š</option>
            <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
            <option value="æœé£¾">ğŸ‘” æœé£¾</option>
            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
          </select>
        </div>
        <div style="flex: 1; min-width: 150px;">
          <select id="filterPayer" style="width: 100%;">
            <option value="">å…¨éƒ¨ä»˜æ¬¾äºº</option>
            <option value="ä½ ">ä½ ä»˜çš„</option>
            <option value="å°æ–¹">å°æ–¹ä»˜çš„</option>
            <option value="å…©äºº">å…±åŒä»˜çš„</option>
          </select>
        </div>
      </div>

      <div class="date-filter-section" style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap;">
        <label style="margin: 0; white-space: nowrap; width: 100%;">ğŸ“… æ—¥æœŸç¯„åœï¼š</label>
        <div style="display: flex; gap: 8px; align-items: center; flex: 1; min-width: 200px;">
          <input type="date" id="startDate" style="flex: 1; min-width: 120px;">
          <span>ï½</span>
          <input type="date" id="endDate" style="flex: 1; min-width: 120px;">
        </div>
        <div style="display: flex; gap: 8px;">
          <button onclick="applyFilters()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">ç¯©é¸</button>
          <button onclick="clearFilters()" style="padding: 10px 20px; background: #e5e7eb; color: #333; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">æ¸…é™¤</button>
        </div>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="color: #999; font-size: 0.9em;" id="recordCount">å…± 0 ç­†è¨˜éŒ„</span>
        <div style="display: flex; gap: 8px;">
          <button onclick="showCharts()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">ğŸ“Š åœ–è¡¨</button>
        </div>
      </div>
    </div>

    <div class="expenses-list">
      <div id="expensesList" class="loading">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- åœ–è¡¨ Modal -->
    <div id="chartModal" class="modal hidden">
      <div class="modal-content" style="max-width: 900px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">ğŸ“Š æ”¯å‡ºåˆ†æ</h2>
          <button onclick="closeChartModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">Ã—</button>
        </div>

        <!-- åœ–è¡¨æ¨™ç±¤åˆ‡æ› -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0;">
          <button id="chartTab1" class="chart-tab active" onclick="switchChartTab(1)">ğŸ“Š åˆ†é¡åˆ†æ</button>
          <button id="chartTab2" class="chart-tab" onclick="switchChartTab(2)">ğŸ“ˆ è¶¨å‹¢åœ–è¡¨</button>
          <button id="chartTab3" class="chart-tab" onclick="switchChartTab(3)">ğŸ‘¥ ä»˜æ¬¾åˆ†æ</button>
        </div>

        <!-- åœ–è¡¨å…§å®¹å®¹å™¨ -->
        <div id="chartTabContent1" class="chart-tab-content">
          <div id="categoryPieChart" style="width: 100%; height: 400px;"></div>
          <div id="categoryBarChart" style="margin-top: 20px;"></div>
        </div>

        <div id="chartTabContent2" class="chart-tab-content hidden">
          <div id="trendLineChart" style="width: 100%; height: 400px;"></div>
          <div id="monthlyBarChart" style="width: 100%; height: 300px; margin-top: 20px;"></div>
        </div>

        <div id="chartTabContent3" class="chart-tab-content hidden">
          <div id="payerPieChart" style="width: 100%; height: 400px;"></div>
          <div id="payerBarChart" style="margin-top: 20px;"></div>
        </div>
      </div>
    </div>

    <!-- çµç®— Modal -->
    <div id="settlementModal" class="modal hidden">
      <div class="modal-content" style="max-width: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">ğŸ’° è¨˜éŒ„çµç®—</h2>
          <button onclick="closeSettlementModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">Ã—</button>
        </div>

        <div class="form-group">
          <label>çµç®—æ–¹å‘</label>
          <select id="settlementDirection" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
            <option value="partner_pay_me">âœ… å°æ–¹é‚„æˆ‘éŒ¢</option>
            <option value="i_pay_partner">âœ… æˆ‘é‚„å°æ–¹éŒ¢</option>
          </select>
        </div>

        <div class="form-group">
          <label>çµç®—é‡‘é¡</label>
          <input type="number" id="settlementAmount" placeholder="è¼¸å…¥é‡‘é¡" min="0.01" step="0.01" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>

        <div class="form-group">
          <label>æ—¥æœŸï¼ˆé¸å¡«ï¼‰</label>
          <input type="date" id="settlementDate" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>

        <div class="form-group">
          <label>å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="settlementNote" placeholder="ä¾‹å¦‚ï¼šç¾é‡‘é‚„æ¬¾" maxlength="50" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>

        <button class="btn btn-primary" onclick="addSettlementRecord()" style="width: 100%;">ç¢ºèªè¨˜éŒ„</button>
      </div>
    </div>

    <!-- ç·¨è¼¯æ”¯å‡º Modal -->
    <div id="editExpenseModal" class="modal hidden">
      <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">âœï¸ ç·¨è¼¯æ”¯å‡º</h2>
          <button onclick="closeEditExpenseModal()" style="background: none; border: none; font-size: 1.8em; cursor: pointer; color: #999; padding: 5px 10px; line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#999'">Ã—</button>
        </div>

        <div class="form-group">
          <label>æ—¥æœŸæ™‚é–“</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="date" id="editExpenseDate" style="width: 100%; min-width: 0; cursor: pointer;">
            <input type="time" id="editExpenseTime" style="width: 100%; min-width: 0; cursor: pointer;">
          </div>
        </div>

        <div class="form-group">
          <label>é …ç›®</label>
          <input type="text" id="editItem" placeholder="ä¾‹å¦‚ï¼šè²·èœã€å¤–é£Ÿ">
        </div>

        <div class="form-group">
          <label>é‡‘é¡</label>
          <input type="number" id="editAmount" placeholder="0">
        </div>

        <div class="form-group">
          <label>ä»˜æ¬¾æ–¹å¼</label>
          <select id="editSplitType" onchange="updateEditPayerOptions()">
            <option value="single">å–®äººä»˜æ¬¾</option>
            <option value="equal">å¹³åˆ†</option>
            <option value="custom">è‡ªè¨‚åˆ†å¸³</option>
          </select>
        </div>

        <div class="form-group" id="editPayerGroup">
          <label>èª°ä»˜çš„</label>
          <select id="editPayer">
            <option value="ä½ ">ä½ </option>
            <option value="å°æ–¹">å°æ–¹</option>
          </select>
        </div>

        <div class="form-group hidden" id="editCustomSplit">
          <label>è‡ªè¨‚åˆ†å¸³é‡‘é¡</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div>
              <input type="number" id="editYourPart" placeholder="ä½ çš„éƒ¨åˆ†">
            </div>
            <div>
              <input type="number" id="editPartnerPart" placeholder="å°æ–¹çš„éƒ¨åˆ†">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>åˆ†é¡</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <select id="editMainCategory" onchange="updateEditSubCategories()">
              <option value="">è¼‰å…¥ä¸­...</option>
            </select>
            <select id="editSubCategory" style="display: none;">
              <option value="">ï¼ˆé¸å¡«å­åˆ†é¡ï¼‰</option>
            </select>
          </div>
        </div>

        <input type="hidden" id="editExpenseId">

        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button class="btn btn-primary" onclick="updateExpense()" style="flex: 1;">ğŸ’¾ å„²å­˜è®Šæ›´</button>
          <button class="btn" onclick="closeEditExpenseModal()" style="flex: 1; background: #e5e7eb; color: #333;">å–æ¶ˆ</button>
        </div>
      </div>
    </div>

    <!-- æˆå“¡ç®¡ç† Modal -->
    <div id="membersModal" class="modal hidden">
      <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">ğŸ‘¥ æˆå“¡ç®¡ç†</h2>
          <button id="closeMembersBtn" class="close-modal-btn" onclick="closeMembersModal(); return false;" style="background: none; border: none; font-size: 1.8em; cursor: pointer; color: #999; padding: 5px 10px; line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#999'">Ã—</button>
        </div>

        <!-- é‚€è«‹æ–°æˆå“¡ -->
        <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 15px; color: #667eea;">âœ‰ï¸ é‚€è«‹æ–°æˆå“¡</h3>
          <div style="display: flex; gap: 10px;">
            <input type="email" id="inviteEmail" placeholder="è¼¸å…¥ Email åœ°å€" style="flex: 1; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px;">
            <button onclick="inviteMemberAction()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; font-weight: 600;">ç™¼é€é‚€è«‹</button>
          </div>
          <p style="font-size: 0.85em; color: #999; margin-top: 10px;">
            ğŸ’¡ å—é‚€è€…å°‡æ”¶åˆ°é‚€è«‹éƒµä»¶ï¼Œä¸¦å¯ä½¿ç”¨è©² Email ç™»å…¥ç³»çµ±
          </p>
        </div>

        <!-- æˆå“¡åˆ—è¡¨ -->
        <div>
          <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ“‹ ç›®å‰æˆå“¡</h3>
          <div id="membersList" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="text-align: center; padding: 20px; color: #999;">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
  <div id="settingsModal" class="modal hidden">
    <div class="modal-content" style="max-width: 400px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">ğŸ¨ ä»‹é¢é…è‰²</h2>
        <button onclick="closeSettingsModal()" style="background: none; border: none; font-size: 1.8em; cursor: pointer; color: #999; padding: 5px 10px; line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#999'">Ã—</button>
      </div>

      <div class="form-group">
        <label>é¸æ“‡é…è‰²ä¸»é¡Œ</label>
        <select id="settingTheme">
          <option value="ç´«è‰²">ğŸ’œ ç´«è‰²</option>
          <option value="è—è‰²">ğŸ’™ è—è‰²</option>
          <option value="ç¶ è‰²">ğŸ’š ç¶ è‰²</option>
          <option value="ç²‰è‰²">ğŸ’— ç²‰è‰²</option>
        </select>
      </div>

      <div style="margin-top: 20px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 0.85em; color: #666;">
        ğŸ’¡ æç¤ºï¼šé…è‰²è¨­å®šåªå½±éŸ¿ä½ çš„å€‹äººè£ç½®<br>
        è¦åˆ‡æ›è¨˜å¸³æ¨¡å¼è«‹é»æ“Šä¸Šæ–¹æ¨™é¡Œ
      </div>

      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" onclick="closeSettingsModal()" style="flex: 1; background: #e5e7eb; color: #374151;">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveTheme()" style="flex: 1;">å¥—ç”¨</button>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€è®Šæ•¸
    let allExpenses = []; // å„²å­˜æ‰€æœ‰è¨˜éŒ„ï¼ˆç”¨æ–¼å„€è¡¨æ¿å’Œçµ±è¨ˆï¼‰
    let displayedExpenses = []; // ç›®å‰é¡¯ç¤ºçš„è¨˜éŒ„ï¼ˆåˆ†é è¼‰å…¥ï¼‰
    let currentOffset = 0; // ç›®å‰è¼‰å…¥çš„ offset
    let totalCount = 0; // ç¸½è¨˜éŒ„æ•¸
    let hasMoreData = false; // æ˜¯å¦é‚„æœ‰æ›´å¤šè³‡æ–™
    let isLoading = false; // æ˜¯å¦æ­£åœ¨è¼‰å…¥
    let allExpensesLoaded = false; // allExpenses æ˜¯å¦å·²è¼‰å…¥å®Œæˆ
    const PAGE_SIZE = 50; // æ¯æ¬¡è¼‰å…¥ 50 ç­†
    let yourName = 'ä½ '; // ç•¶å‰ä½¿ç”¨è€…çš„åç¨±ï¼ˆå¾ Google å¸³è™Ÿå–å¾—ï¼‰
    let partnerName = 'å°æ–¹'; // å°æ–¹çš„åç¨±ï¼ˆå¾è¨­å®šè®€å–ï¼‰
    let categoriesData = {}; // å„²å­˜åˆ†é¡è³‡æ–™çµæ§‹ {ä¸»åˆ†é¡: [å­åˆ†é¡...]}
    let appSettings = {mode: 'å…±åŒè¨˜å¸³', theme: 'ç´«è‰²'}; // æ‡‰ç”¨ç¨‹å¼è¨­å®š

    // ==================== å·¥å…·å‡½æ•¸ ====================

    /**
     * é‡‘é¡æ ¼å¼åŒ– - è¶…é 10000 ä½¿ç”¨ K å–®ä½
     */
    function formatMoney(amount) {
      const num = Number(amount);
      if (isNaN(num)) return '$0';

      if (num >= 10000) {
        const k = (num / 1000).toFixed(1);
        return '$' + k + 'K';
      }
      return '$' + num.toLocaleString();
    }

    /**
     * è¼‰å…¥åˆ†é¡åˆ—è¡¨ï¼ˆå…©å€‹ä¸‹æ‹‰é¸å–®ï¼‰
     */
    function loadCategories() {
      google.script.run
        .withSuccessHandler(function(categories) {
          // åˆ†é¡è¡¨æƒ…ç¬¦è™Ÿå°æ‡‰
          const categoryIcons = {
            'é£²é£Ÿ': 'ğŸœ',
            'å±…ä½': 'ğŸ ',
            'äº¤é€š': 'ğŸš—',
            'å¨›æ¨‚': 'ğŸ®',
            'å¯µç‰©': 'ğŸ¾',
            'æœé£¾': 'ğŸ‘”',
            'å…¶ä»–': 'ğŸ“¦'
          };

          // å°‡åˆ†é¡åˆ†çµ„è™•ç†
          categoriesData = {}; // æ¸…ç©ºä¸¦é‡å»º

          categories.forEach(function(cat) {
            if (cat.includes('>')) {
              // å­åˆ†é¡
              const parts = cat.split('>');
              const parent = parts[0].trim();
              const child = parts[1].trim();

              if (!categoriesData[parent]) {
                categoriesData[parent] = [];
              }
              categoriesData[parent].push(child);
            } else {
              // ä¸»åˆ†é¡ï¼ˆå¦‚æœé‚„æ²’æœ‰ï¼Œåˆå§‹åŒ–ç‚ºç©ºé™£åˆ—ï¼‰
              if (!categoriesData[cat]) {
                categoriesData[cat] = [];
              }
            }
          });

          // å¡«å…¥ä¸»åˆ†é¡ä¸‹æ‹‰é¸å–®ï¼ˆæ–°å¢æ”¯å‡ºï¼‰
          const mainCategorySelect = document.getElementById('mainCategory');
          mainCategorySelect.innerHTML = '';

          Object.keys(categoriesData).forEach(function(mainCat) {
            const icon = categoryIcons[mainCat] || 'ğŸ“¦';
            const option = document.createElement('option');
            option.value = mainCat;
            option.textContent = icon + ' ' + mainCat;
            mainCategorySelect.appendChild(option);
          });

          // å¡«å…¥ä¸»åˆ†é¡ä¸‹æ‹‰é¸å–®ï¼ˆç·¨è¼¯æ”¯å‡ºï¼‰
          const editMainCategorySelect = document.getElementById('editMainCategory');
          if (editMainCategorySelect) {
            editMainCategorySelect.innerHTML = '';
            Object.keys(categoriesData).forEach(function(mainCat) {
              const icon = categoryIcons[mainCat] || 'ğŸ“¦';
              const option = document.createElement('option');
              option.value = mainCat;
              option.textContent = icon + ' ' + mainCat;
              editMainCategorySelect.appendChild(option);
            });
          }

          // åˆå§‹åŒ–å­åˆ†é¡ï¼ˆç¬¬ä¸€å€‹ä¸»åˆ†é¡ï¼‰
          if (Object.keys(categoriesData).length > 0) {
            updateSubCategories();
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥åˆ†é¡å¤±æ•—:', error);
          showToast('è¼‰å…¥åˆ†é¡å¤±æ•—', 'error');
        })
        .getCategories();
    }

    /**
     * æ›´æ–°å­åˆ†é¡ä¸‹æ‹‰é¸å–®ï¼ˆæ–°å¢æ”¯å‡ºï¼‰
     */
    function updateSubCategories() {
      const mainCategory = document.getElementById('mainCategory').value;
      const subCategorySelect = document.getElementById('subCategory');

      if (!mainCategory || !categoriesData[mainCategory] || categoriesData[mainCategory].length === 0) {
        // æ²’æœ‰å­åˆ†é¡ï¼Œéš±è—å­åˆ†é¡é¸å–®
        subCategorySelect.style.display = 'none';
        return;
      }

      // æœ‰å­åˆ†é¡ï¼Œé¡¯ç¤ºä¸¦å¡«å…¥é¸é …
      subCategorySelect.style.display = 'block';
      subCategorySelect.innerHTML = '<option value="">ï¼ˆé¸å¡«å­åˆ†é¡ï¼‰</option>';

      categoriesData[mainCategory].forEach(function(subCat) {
        const option = document.createElement('option');
        option.value = subCat;
        option.textContent = subCat;
        subCategorySelect.appendChild(option);
      });
    }

    /**
     * æ›´æ–°å­åˆ†é¡ä¸‹æ‹‰é¸å–®ï¼ˆç·¨è¼¯æ”¯å‡ºï¼‰
     */
    function updateEditSubCategories() {
      const mainCategory = document.getElementById('editMainCategory').value;
      const subCategorySelect = document.getElementById('editSubCategory');

      if (!mainCategory || !categoriesData[mainCategory] || categoriesData[mainCategory].length === 0) {
        // æ²’æœ‰å­åˆ†é¡ï¼Œéš±è—å­åˆ†é¡é¸å–®
        subCategorySelect.style.display = 'none';
        return;
      }

      // æœ‰å­åˆ†é¡ï¼Œé¡¯ç¤ºä¸¦å¡«å…¥é¸é …
      subCategorySelect.style.display = 'block';
      subCategorySelect.innerHTML = '<option value="">ï¼ˆé¸å¡«å­åˆ†é¡ï¼‰</option>';

      categoriesData[mainCategory].forEach(function(subCat) {
        const option = document.createElement('option');
        option.value = subCat;
        option.textContent = subCat;
        subCategorySelect.appendChild(option);
      });
    }

    /**
     * è¼‰å…¥æ‡‰ç”¨ç¨‹å¼è¨­å®šï¼ˆè¨˜å¸³æ¨¡å¼ã€ä»‹é¢é…è‰²ï¼‰
     */
    function loadAppSettings() {
      // å…ˆæª¢æŸ¥ localStorage æ˜¯å¦æœ‰ä½¿ç”¨è€…åå¥½è¨­å®š
      const savedMode = localStorage.getItem('accountingMode');
      const savedTheme = localStorage.getItem('accountingTheme');

      if (savedMode && savedTheme) {
        // ä½¿ç”¨ localStorage çš„è¨­å®š
        appSettings = {mode: savedMode, theme: savedTheme};
        applyTheme(savedTheme);
        applyMode(savedMode);
        console.log('ä½¿ç”¨ localStorage è¨­å®š:', appSettings);
      } else {
        // ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œå¾è©¦ç®—è¡¨è®€å–é è¨­å€¼
        google.script.run
          .withSuccessHandler(function(settings) {
            appSettings = settings;
            // å„²å­˜åˆ° localStorage
            localStorage.setItem('accountingMode', settings.mode);
            localStorage.setItem('accountingTheme', settings.theme);
            applyTheme(settings.theme);
            applyMode(settings.mode);
            console.log('å¾è©¦ç®—è¡¨è®€å–é è¨­è¨­å®š:', appSettings);
          })
          .withFailureHandler(function(error) {
            console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', error);
            // ä½¿ç”¨ç¡¬ç·¨ç¢¼é è¨­å€¼
            appSettings = {mode: 'å…±åŒè¨˜å¸³', theme: 'ç´«è‰²'};
            localStorage.setItem('accountingMode', 'å…±åŒè¨˜å¸³');
            localStorage.setItem('accountingTheme', 'ç´«è‰²');
            applyTheme('ç´«è‰²');
            applyMode('å…±åŒè¨˜å¸³');
          })
          .getAppSettings();
      }
    }

    /**
     * å¥—ç”¨ä¸»é¡Œé…è‰²
     */
    function applyTheme(theme) {
      const themes = {
        'ç´«è‰²': {primary: '#667eea', secondary: '#764ba2'},
        'è—è‰²': {primary: '#3b82f6', secondary: '#1e40af'},
        'ç¶ è‰²': {primary: '#10b981', secondary: '#059669'},
        'ç²‰è‰²': {primary: '#ec4899', secondary: '#db2777'}
      };

      const colors = themes[theme] || themes['ç´«è‰²'];

      // æ›´æ–° CSS è®Šæ•¸
      document.documentElement.style.setProperty('--primary-color', colors.primary);
      document.documentElement.style.setProperty('--secondary-color', colors.secondary);

      // æ›´æ–°èƒŒæ™¯æ¼¸å±¤
      document.body.style.background = `linear-gradient(135deg, ${colors.primary} 0%, ${colors.secondary} 100%)`;
    }

    /**
     * å¥—ç”¨è¨˜å¸³æ¨¡å¼
     */
    function applyMode(mode) {
      const isPersonalMode = (mode === 'å€‹äººè¨˜å¸³');

      // æ›´æ–°æ¨™é¡Œæ–‡å­—ï¼ˆä¿ç•™ä¸‹æ‹‰ç®­é ­ï¼‰
      const titleEl = document.getElementById('modeTitle');
      if (titleEl) {
        const icon = isPersonalMode ? 'ğŸ‘¤' : 'ğŸ’‘';
        const text = isPersonalMode ? 'å€‹äººè¨˜å¸³' : 'å…±åŒè¨˜å¸³';
        titleEl.innerHTML = '<span>' + icon + ' ' + text + '</span><span style="font-size: 0.5em; opacity: 0.6;">â–¼</span>';
      }

      // å€‹äººæ¨¡å¼éš±è—ä»˜æ¬¾äººå’Œåˆ†å¸³æ¬„ä½
      const payerFields = document.querySelectorAll('.payer-field, .split-field');
      payerFields.forEach(field => {
        field.style.display = isPersonalMode ? 'none' : 'block';
      });

      // å€‹äººæ¨¡å¼éš±è—çµç®—ç›¸é—œå…ƒç´ 
      const settlementSections = document.querySelectorAll('.settlement-section');
      settlementSections.forEach(section => {
        section.style.display = isPersonalMode ? 'none' : '';
      });

      // å€‹äººæ¨¡å¼æ™‚ï¼Œè‡ªå‹•è¨­å®šä»˜æ¬¾äººç‚ºã€Œä½ ã€ï¼Œåˆ†å¸³ç‚º100%/0%
      if (isPersonalMode) {
        const payerRadios = document.querySelectorAll('input[name="payer"]');
        payerRadios.forEach(radio => {
          if (radio.value === 'ä½ ') radio.checked = true;
        });
      }
    }

    /**
     * åˆ‡æ›æ¨¡å¼é¸å–®é¡¯ç¤º/éš±è—
     */
    function toggleModeMenu() {
      const menu = document.getElementById('modeMenu');
      menu.classList.toggle('hidden');
    }

    /**
     * é¸æ“‡è¨˜å¸³æ¨¡å¼
     */
    function selectMode(mode) {
      // é—œé–‰é¸å–®
      document.getElementById('modeMenu').classList.add('hidden');

      // å¦‚æœæ˜¯åŒä¸€å€‹æ¨¡å¼ï¼Œä¸åšä»»ä½•äº‹
      if (appSettings.mode === mode) return;

      // å„²å­˜åˆ° localStorage
      localStorage.setItem('accountingMode', mode);
      appSettings.mode = mode;

      // å¥—ç”¨æ–°æ¨¡å¼
      applyMode(mode);

      // é¡¯ç¤ºæç¤º
      const modeText = mode === 'å€‹äººè¨˜å¸³' ? 'ğŸ‘¤ å€‹äººè¨˜å¸³' : 'ğŸ’‘ å…±åŒè¨˜å¸³';
      showToast('å·²åˆ‡æ›è‡³ ' + modeText, 'success');

      // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥æ›´æ–°é¡¯ç¤º
      loadData();
    }

    // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('modeMenu');
      const title = document.getElementById('modeTitle');
      if (menu && title && !menu.contains(event.target) && !title.contains(event.target)) {
        menu.classList.add('hidden');
      }
    });

    // ==================== å®‰å…¨æ€§å‡½æ•¸ ====================

    /**
     * HTML è½‰ç¾©é˜²æ­¢ XSS
     */
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * é©—è­‰è¼¸å…¥
     */
    function validateInput(value, type, min, max) {
      if (type === 'text') {
        return value && value.trim().length > 0 && value.length <= (max || 100);
      }
      if (type === 'number') {
        const num = parseFloat(value);
        return !isNaN(num) && num >= (min || 0) && num <= (max || 9999999);
      }
      if (type === 'email') {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
      }
      return false;
    }

    /**
     * é©—è­‰åœ–ç‰‡ URLï¼ˆé˜²æ­¢ javascript: å”è­°ï¼‰
     */
    function validateImageUrl(url) {
      if (!url) return '';
      // åªå…è¨± http å’Œ https å”è­°
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return escapeHtml(url);
      }
      // æ‹’çµ• javascript:, data: ç­‰å±éšªå”è­°
      return '';
    }

    // Toast é€šçŸ¥ç³»çµ±
    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = 'toast ' + type;

      const icon = type === 'success' ? 'âœ“' : 'âœ•';
      // ä½¿ç”¨ textContent é˜²æ­¢ XSS
      const iconDiv = document.createElement('div');
      iconDiv.className = 'toast-icon';
      iconDiv.textContent = icon;

      const messageDiv = document.createElement('div');
      messageDiv.className = 'toast-message';
      messageDiv.textContent = message; // å®‰å…¨çš„æ–‡æœ¬æ’å…¥

      toast.appendChild(iconDiv);
      toast.appendChild(messageDiv);

      document.body.appendChild(toast);

      setTimeout(function() {
        toast.style.animation = 'slideInRight 0.3s ease-out reverse';
        setTimeout(function() {
          toast.remove();
        }, 300);
      }, 3000);
    }

    function loadData() {
      // æ¨™è¨˜ allExpenses å°šæœªè¼‰å…¥å®Œæˆ
      allExpensesLoaded = false;

      // è¼‰å…¥ç¬¬ä¸€é è³‡æ–™ï¼ˆæ”¯å‡ºè¨˜éŒ„é é¢ï¼‰
      loadPagedExpenses(0);

      // è¼‰å…¥æ‰€æœ‰è³‡æ–™ï¼ˆç”¨æ–¼å„€è¡¨æ¿å’Œçµ±è¨ˆï¼‰
      google.script.run
        .withSuccessHandler(function(expenses) {
          allExpenses = expenses;
          allExpensesLoaded = true;
          updateDashboard(allExpenses);
          // é‡æ–°æ›´æ–° UI ä»¥é¡¯ç¤ºæ­£ç¢ºçš„çµç®—
          updateUI(displayedExpenses);
        })
        .withFailureHandler(showError)
        .getAllExpenses();
    }

    /**
     * è¼‰å…¥åˆ†é è³‡æ–™
     */
    function loadPagedExpenses(offset) {
      if (isLoading) return;
      isLoading = true;

      google.script.run
        .withSuccessHandler(function(result) {
          isLoading = false;

          if (offset === 0) {
            // ç¬¬ä¸€é ï¼šæ¸…ç©ºä¸¦é¡¯ç¤º
            displayedExpenses = result.expenses;
          } else {
            // å¾ŒçºŒé ï¼šç´¯åŠ 
            displayedExpenses = displayedExpenses.concat(result.expenses);
          }

          totalCount = result.total;
          hasMoreData = result.hasMore;
          currentOffset = offset + result.expenses.length;

          updateUI(displayedExpenses);
        })
        .withFailureHandler(function(error) {
          isLoading = false;
          showError(error);
        })
        .getExpenses({ offset: offset, limit: PAGE_SIZE });
    }

    // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(user) {
          displayUserInfo(user);
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', error);
          document.getElementById('userInfo').innerHTML = '<div style="font-size: 0.9em; color: #999;">æœªç™»å…¥</div>';
        })
        .getCurrentUser();
    }

    // è¼‰å…¥å¿«é€Ÿè¨˜å¸³æŒ‰éˆ•
    function loadQuickExpenseButtons() {
      google.script.run
        .withSuccessHandler(function(buttons) {
          const container = document.getElementById('quickExpenseButtons');

          if (!buttons || buttons.length === 0) {
            container.innerHTML = '<div style="color: #999; font-size: 0.9em;">å°šæœªè¨­å®šå¿«é€Ÿè¨˜å¸³æŒ‰éˆ•</div>';
            return;
          }

          // æ¸…ç©ºå®¹å™¨ä¸¦å‹•æ…‹ç”ŸæˆæŒ‰éˆ•
          container.innerHTML = '';
          buttons.forEach(function(btn) {
            const button = document.createElement('button');
            button.className = 'quick-btn';
            button.onclick = function() {
              quickExpense(btn.item, btn.amount, btn.category);
            };
            button.textContent = btn.emoji + ' ' + btn.item + ' $' + btn.amount;
            container.appendChild(button);
          });
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥å¿«é€Ÿè¨˜å¸³æŒ‰éˆ•å¤±æ•—:', error);
          document.getElementById('quickExpenseButtons').innerHTML = '<div style="color: #999; font-size: 0.9em;">è¼‰å…¥å¤±æ•—</div>';
        })
        .getQuickExpenseButtons();
    }

    // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
    function displayUserInfo(user) {
      const userInfoEl = document.getElementById('userInfo');

      // å„²å­˜ä½¿ç”¨è€…è³‡è¨Šåˆ°å…¨å±€è®Šæ•¸
      window.currentUser = user;
      yourName = user.name || 'ä½ ';
      partnerName = user.partnerName || 'å°æ–¹';

      // é©—è­‰ä¸¦è½‰ç¾©æ‰€æœ‰ç”¨æˆ¶æ•¸æ“š
      const safePhotoUrl = validateImageUrl(user.photoUrl);
      const safeName = escapeHtml(user.name);
      const safeEmail = escapeHtml(user.email);

      userInfoEl.innerHTML =
        '<img src="' + safePhotoUrl + '" alt="ç”¨æˆ¶é ­åƒ" class="user-avatar" title="' + safeEmail + '">' +
        '<div style="text-align: right;">' +
          '<div class="user-name">' + safeName + '</div>' +
          '<div class="user-email">' + safeEmail + '</div>' +
        '</div>' +
        '<button class="members-btn" onclick="openMembersModal()">æˆå“¡</button>' +
        '<button class="logout-btn" onclick="logout()">ç™»å‡º</button>';

      // æ›´æ–° UI ä¸Šçš„åç¨±æ¨™ç±¤
      updateNameLabels();
    }

    // æ›´æ–° UI ä¸Šçš„åç¨±æ¨™ç±¤
    function updateNameLabels() {
      // æ›´æ–°å„€è¡¨æ¿çš„æ¨™ç±¤
      const yourTotalLabel = document.querySelector('#yourTotal').previousElementSibling;
      const partnerTotalLabel = document.querySelector('#partnerTotal').previousElementSibling;

      if (yourTotalLabel && yourTotalLabel.classList.contains('dashboard-label')) {
        yourTotalLabel.textContent = 'ğŸ‘¤ ' + yourName + 'æ‡‰è² æ“”';
      }
      if (partnerTotalLabel && partnerTotalLabel.classList.contains('dashboard-label')) {
        partnerTotalLabel.textContent = 'ğŸ‘¤ ' + partnerName + 'æ‡‰è² æ“”';
      }
    }

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        // æ¸…é™¤æœ¬åœ°æ•¸æ“š
        allExpenses = [];
        allExpensesLoaded = false;
        filteredExpenses = [];
        window.currentUser = null;

        // æ¸…é™¤ç·©å­˜
        if (typeof(Storage) !== "undefined") {
          try {
            sessionStorage.clear();
            localStorage.clear();
          } catch (e) {
            console.log('æ¸…é™¤ç·©å­˜å¤±æ•—:', e);
          }
        }

        // è·³è½‰åˆ° Google ç™»å‡º
        window.location.href = 'https://accounts.google.com/Logout';
      }
    }

    // ç¯©é¸åŠŸèƒ½ï¼ˆåœ¨é¡¯ç¤ºçš„è¨˜éŒ„ä¸­ç¯©é¸ï¼‰
    function applyFilters() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const filterCategory = document.getElementById('filterCategory').value;
      const filterPayer = document.getElementById('filterPayer').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      const filtered = displayedExpenses.filter(function(exp) {
        // æœå°‹æ–‡å­—
        if (searchText && !exp.item.toLowerCase().includes(searchText)) {
          return false;
        }

        // åˆ†é¡ç¯©é¸
        if (filterCategory && exp.category !== filterCategory) {
          return false;
        }

        // ä»˜æ¬¾äººç¯©é¸
        if (filterPayer && exp.payer !== filterPayer) {
          return false;
        }

        // æ—¥æœŸç¯©é¸
        if (startDate && exp.date < startDate) {
          return false;
        }
        if (endDate && exp.date > endDate) {
          return false;
        }

        return true;
      });

      renderExpenseList(filtered);
      showToast('å·²å¥—ç”¨ç¯©é¸æ¢ä»¶', 'success');
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterPayer').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';

      renderExpenseList(displayedExpenses);
      showToast('å·²æ¸…é™¤ç¯©é¸', 'success');
    }

    // å³æ™‚æœå°‹
    document.addEventListener('DOMContentLoaded', function() {
      // ç‰ˆæœ¬æª¢æŸ¥
      const VERSION = 'v2.15.70';

      // è¨­å®šæ—¥æœŸå’Œæ™‚é–“çš„é è¨­å€¼ç‚ºç•¶ä¸‹
      const now = new Date();
      const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
      const timeStr = now.toTimeString().substring(0, 5); // HH:MM
      document.getElementById('expenseDate').value = dateStr;
      document.getElementById('expenseTime').value = timeStr;

      // è¼‰å…¥åˆ†é¡åˆ—è¡¨
      loadCategories();

      document.getElementById('searchInput').addEventListener('input', function() {
        applyFilters();
      });
      document.getElementById('filterCategory').addEventListener('change', applyFilters);
      document.getElementById('filterPayer').addEventListener('change', applyFilters);
    });

    function updateUI(expenses) {
      let yourShouldPay = 0;    // ä½ æ‡‰è©²è² æ“”çš„ç¸½é‡‘é¡
      let partnerShouldPay = 0; // å°æ–¹æ‡‰è©²è² æ“”çš„ç¸½é‡‘é¡
      let yourActualPaid = 0;   // ä½ å¯¦éš›ä»˜å‡ºçš„ç¸½é‡‘é¡
      let partnerActualPaid = 0; // å°æ–¹å¯¦éš›ä»˜å‡ºçš„ç¸½é‡‘é¡
      let settlementAdjustment = 0; // çµç®—èª¿æ•´ï¼šå°æ–¹é‚„æˆ‘çš„éŒ¢ - æˆ‘é‚„å°æ–¹çš„éŒ¢
      let settlementCount = 0; // çµç®—è¨˜éŒ„æ•¸é‡
      let settlementDetails = []; // çµç®—è¨˜éŒ„æ˜ç´°
      let expenseCount = 0; // æ”¯å‡ºè¨˜éŒ„æ•¸é‡

      // è¨ˆç®—ç¸½è¨ˆï¼ˆä½¿ç”¨å…¨éƒ¨è³‡æ–™ï¼‰
      // ç¢ºä¿ allExpenses å­˜åœ¨ä¸”ç‚ºé™£åˆ—
      if (allExpenses && Array.isArray(allExpenses)) {
        allExpenses.forEach(function(exp) {
        // æª¢æŸ¥æ˜¯å¦ç‚ºçµç®—è¨˜éŒ„
        if (exp.recordType === 'settlement' || exp.category === 'çµç®—') {
          // çµç®—è¨˜éŒ„ï¼šç›´æ¥èª¿æ•´é¤˜é¡
          const amount = Number(exp.amount) || 0;
          settlementCount++;
          settlementDetails.push(exp.payer + 'ä»˜' + amount + ' (' + exp.item + ')');

          if (exp.payer === 'å°æ–¹') {
            // å°æ–¹å¢Šä»˜çµ¦æˆ‘ â†’ æˆ‘æ¬ å°æ–¹ â†’ settlementAdjustment æ¸›å°‘
            settlementAdjustment -= amount;
          } else if (exp.payer === 'ä½ ') {
            // æˆ‘å¢Šä»˜çµ¦å°æ–¹ â†’ å°æ–¹æ¬ æˆ‘ â†’ settlementAdjustment å¢åŠ 
            settlementAdjustment += amount;
          }
        } else {
          // ä¸€èˆ¬æ”¯å‡ºè¨˜éŒ„ï¼šåŸæœ‰é‚è¼¯
          expenseCount++;

          // æ‡‰è©²è² æ“”çš„é‡‘é¡
          // å¦‚æœæ˜¯è‡ªå‹•å‡åˆ†ä¸” yourPart æ˜¯ç©ºå­—ä¸²ï¼Œä½¿ç”¨ç¸½é‡‘é¡çš„ä¸€åŠ
          if (exp.splitType === 'è‡ªå‹•å‡åˆ†' && (exp.yourPart === '' || exp.yourPart === null || exp.yourPart === undefined)) {
            const halfAmount = (Number(exp.amount) || 0) / 2;
            yourShouldPay += halfAmount;
            partnerShouldPay += halfAmount;
          } else {
            yourShouldPay += Number(exp.yourPart) || 0;
            partnerShouldPay += Number(exp.partnerPart) || 0;
          }

          // å¯¦éš›ä»˜å‡ºçš„é‡‘é¡
          // å„ªå…ˆä½¿ç”¨è³‡æ–™åº«ä¸­è¨˜éŒ„çš„å¯¦éš›ä»˜æ¬¾é‡‘é¡ï¼ˆæ–°åŠŸèƒ½ï¼‰
          if (exp.yourActualPaid !== null && exp.yourActualPaid !== undefined &&
              exp.partnerActualPaid !== null && exp.partnerActualPaid !== undefined) {
            // ä½¿ç”¨è³‡æ–™åº«ä¸­çš„å¯¦éš›ä»˜æ¬¾é‡‘é¡ï¼ˆæ”¯æ´ä¸ç­‰é¡å¢Šä»˜ï¼‰
            yourActualPaid += Number(exp.yourActualPaid) || 0;
            partnerActualPaid += Number(exp.partnerActualPaid) || 0;
          } else {
            // å‘ä¸‹ç›¸å®¹ï¼šèˆŠè³‡æ–™æ ¹æ“š actualPayer æ¨ç®—
            const amount = Number(exp.amount) || 0;
            const actualPayer = exp.actualPayer || exp.payer;

            if (actualPayer === 'ä½ ') {
              // æˆ‘å…ˆä»˜äº†å…¨é¡
              yourActualPaid += amount;
            } else if (actualPayer === 'å°æ–¹') {
              // å°æ–¹å…ˆä»˜äº†å…¨é¡
              partnerActualPaid += amount;
            } else if (actualPayer === 'å„è‡ª') {
              // å„ä»˜å„çš„ï¼šæŒ‰ç…§æ‡‰è² æ“”é‡‘é¡ä»˜
              yourActualPaid += Number(exp.yourPart) || 0;
              partnerActualPaid += Number(exp.partnerPart) || 0;
            }
            // å…¶ä»–æƒ…æ³ï¼ˆä¸ç­‰é¡ç­‰ï¼‰ï¼šä¸è¨ˆå…¥
          }
        }
        });
      }

      // èª¿è©¦è³‡è¨Š
      console.log('=== é¤˜é¡è¨ˆç®—èª¿è©¦ ===');
      console.log('ä½ å¯¦ä»˜:', yourActualPaid);
      console.log('ä½ æ‡‰ä»˜:', yourShouldPay);
      console.log('å°æ–¹å¯¦ä»˜:', partnerActualPaid);
      console.log('å°æ–¹æ‡‰ä»˜:', partnerShouldPay);
      console.log('çµç®—èª¿æ•´:', settlementAdjustment);
      console.log('æ”¯å‡ºç”¢ç”Ÿçš„é¤˜é¡:', yourActualPaid - yourShouldPay);

      // çµç®—é‚è¼¯ï¼š(æˆ‘å¯¦éš›ä»˜çš„ - æˆ‘æ‡‰è©²ä»˜çš„) + çµç®—èª¿æ•´ = å°æ–¹æ¬ æˆ‘çš„
      // settlementAdjustment æ­£å€¼è¡¨ç¤ºæˆ‘é‚„å°æ–¹çš„éŒ¢ï¼Œæœƒå¢åŠ é¤˜é¡ï¼ˆæ¸›å°‘æˆ‘çš„å‚µå‹™ï¼‰
      // settlementAdjustment è² å€¼è¡¨ç¤ºå°æ–¹é‚„æˆ‘çš„éŒ¢ï¼Œæœƒæ¸›å°‘é¤˜é¡ï¼ˆæ¸›å°‘å°æ–¹æ¬ æˆ‘çš„ï¼‰
      const yourBalance = (yourActualPaid - yourShouldPay) + settlementAdjustment;
      const partnerBalance = (partnerActualPaid - partnerShouldPay) - settlementAdjustment;

      console.log('æœ€çµ‚é¤˜é¡:', yourBalance);
      console.log('==================');

      const total = yourShouldPay + partnerShouldPay;

      document.getElementById('yourTotal').textContent = formatMoney(yourShouldPay);
      document.getElementById('partnerTotal').textContent = formatMoney(partnerShouldPay);
      document.getElementById('totalExpense').textContent = formatMoney(total);

      const balanceEl = document.getElementById('balance');

      // å€‹äººæ¨¡å¼ï¼šé¡¯ç¤ºç¸½æ”¯å‡º
      if (appSettings.mode === 'å€‹äººè¨˜å¸³') {
        if (!allExpensesLoaded) {
          balanceEl.textContent = 'è¨ˆç®—ä¸­...';
          balanceEl.style.color = '#999';
        } else if (!allExpenses || allExpenses.length === 0) {
          balanceEl.textContent = 'å°šç„¡è¨˜éŒ„';
          balanceEl.style.color = '#999';
        } else {
          balanceEl.textContent = 'ç¸½æ”¯å‡º ' + formatMoney(total);
          balanceEl.style.color = '';
        }
      } else {
        // å…±åŒè¨˜å¸³æ¨¡å¼ï¼šé¡¯ç¤ºé¤˜é¡
        if (!allExpensesLoaded) {
          // è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆ
          balanceEl.textContent = 'çµç®—ä¸­...';
          balanceEl.style.color = '#999';
        } else if (!allExpenses || allExpenses.length === 0) {
          balanceEl.textContent = 'å°šç„¡è¨˜éŒ„';
          balanceEl.style.color = '#999';
        } else if (Math.abs(yourBalance) < 0.01) {
          // å·²çµæ¸…ï¼ˆèª¤å·®åœ¨ 0.01 ä»¥å…§è¦–ç‚ºçµæ¸…ï¼‰
          balanceEl.textContent = 'å·²çµæ¸… âœ¨';
          balanceEl.style.color = '';
        } else if (yourBalance > 0) {
          // æˆ‘ä»˜å¾—æ¯”æˆ‘è©²ä»˜çš„å¤š â†’ å°æ–¹æ‡‰ä»˜çµ¦æˆ‘
          balanceEl.textContent = partnerName + ' æ‡‰ä»˜ä½  ' + formatMoney(Math.abs(yourBalance));
          balanceEl.style.color = '';
        } else {
          // æˆ‘ä»˜å¾—æ¯”æˆ‘è©²ä»˜çš„å°‘ â†’ æˆ‘æ‡‰ä»˜çµ¦å°æ–¹
          balanceEl.textContent = 'ä½ æ‡‰ä»˜ ' + partnerName + ' ' + formatMoney(Math.abs(yourBalance));
          balanceEl.style.color = '';
        }
      }


      // æ›´æ–°è¨˜éŒ„æ•¸é‡ï¼ˆé¡¯ç¤ºç¸½æ•¸ï¼‰
      document.getElementById('recordCount').textContent = 'å…± ' + totalCount + ' ç­†è¨˜éŒ„ï¼ˆå·²è¼‰å…¥ ' + displayedExpenses.length + ' ç­†ï¼‰';

      // æ¸²æŸ“è¨˜éŒ„åˆ—è¡¨
      renderExpenseList(expenses);
    }

    /**
     * è¼‰å…¥æ›´å¤šè¨˜éŒ„
     */
    function loadMoreExpenses() {
      if (isLoading || !hasMoreData) return;
      loadPagedExpenses(currentOffset);
    }

    function renderExpenseList(expenses) {
      const listEl = document.getElementById('expensesList');
      if (expenses.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p><p style="font-size: 0.9em; margin-top: 8px;">è©¦è©¦èª¿æ•´ç¯©é¸æ¢ä»¶</p></div>';
        return;
      }

      // æŒ‰æ—¥æœŸåˆ†çµ„
      const groupedByDate = {};
      expenses.forEach(function(exp) {
        if (!groupedByDate[exp.date]) {
          groupedByDate[exp.date] = [];
        }
        groupedByDate[exp.date].push(exp);
      });

      const categoryIcons = {
        'é£²é£Ÿ': 'ğŸœ',
        'å±…ä½': 'ğŸ ',
        'äº¤é€š': 'ğŸš—',
        'å¨›æ¨‚': 'ğŸ®',
        'æœé£¾': 'ğŸ‘”',
        'å…¶ä»–': 'ğŸ“¦'
      };

      let html = '';
      Object.keys(groupedByDate).forEach(function(date) {
        const exps = groupedByDate[date];
        const dayTotal = exps.reduce(function(sum, exp) { return sum + Number(exp.amount); }, 0);

        // æ—¥æœŸæ¨™é¡Œ
        const dateObj = new Date(date);
        const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const weekday = weekdays[dateObj.getDay()];

        html += '<div class="date-header">' +
          '<span class="date-text">' + date + ' (é€±' + weekday + ')</span>' +
          '<span class="date-total">å°è¨ˆ ' + formatMoney(dayTotal) + '</span>' +
        '</div>';

        exps.forEach(function(exp) {
          const className = exp.payer === 'ä½ ' ? 'you' : exp.payer === 'å°æ–¹' ? 'partner' : 'both';
          const splitInfo = exp.payer === 'å…©äºº' ? '<br><small>(ä½ : ' + formatMoney(Number(exp.yourPart)) + ' / å°æ–¹: ' + formatMoney(Number(exp.partnerPart)) + ')</small>' : '';
          const icon = categoryIcons[exp.category] || 'ğŸ“¦';

          // ä½¿ç”¨å®‰å…¨çš„ HTML è½‰ç¾©
          const safeItem = escapeHtml(exp.item);
          const safeCategory = escapeHtml(exp.category);
          const safePayer = escapeHtml(exp.payer);

          // æå–æ™‚é–“éƒ¨åˆ†ï¼ˆå¦‚æœæ—¥æœŸåŒ…å«æ™‚é–“ï¼‰
          const timeStr = exp.date.includes(':') ? exp.date.split(' ')[1].substring(0, 5) : '';
          const timeDisplay = timeStr ? ' Â· ' + timeStr : '';

          html += '<div class="expense-item ' + className + '">' +
            '<div class="expense-info">' +
              '<strong>' + icon + ' ' + safeItem + '</strong>' +
              '<div style="font-size: 0.82em; color: #6b7280; margin-top: 2px;">' +
                safeCategory + ' Â· ' + safePayer + timeDisplay +
                splitInfo +
              '</div>' +
            '</div>' +
            '<div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">' +
              '<div class="expense-amount">' + formatMoney(Number(exp.amount)) + '</div>' +
              '<div class="expense-actions">' +
                '<button class="edit-btn" onclick="editExpense(\'' + exp.id + '\')">ç·¨è¼¯</button>' +
                '<button class="delete-btn" onclick="deleteExpense(\'' + exp.id + '\')">åˆªé™¤</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        });
      });

      listEl.innerHTML = html;

      // æ·»åŠ ã€Œè¼‰å…¥æ›´å¤šã€æŒ‰éˆ•ï¼ˆä½¿ç”¨å¾Œç«¯åˆ†é ï¼‰
      if (hasMoreData) {
        const loadMoreBtn = document.createElement('div');
        loadMoreBtn.id = 'loadMoreBtn';
        loadMoreBtn.style.cssText = 'text-align: center; padding: 20px;';
        const remainingCount = totalCount - displayedExpenses.length;
        loadMoreBtn.innerHTML = '<button class="btn" style="background: #667eea; color: white;" onclick="loadMoreExpenses()">' +
          (isLoading ? 'è¼‰å…¥ä¸­...' : 'è¼‰å…¥æ›´å¤š (' + remainingCount + ' ç­†æœªé¡¯ç¤º)') +
          '</button>';
        listEl.appendChild(loadMoreBtn);

        // ä½¿ç”¨ IntersectionObserver å¯¦ç¾æ»¾å‹•è‡ªå‹•è¼‰å…¥
        setupAutoLoad();
      }
    }

    /**
     * è¨­ç½®æ»¾å‹•è‡ªå‹•è¼‰å…¥
     */
    function setupAutoLoad() {
      // ç§»é™¤èˆŠçš„ observer
      if (window.loadMoreObserver) {
        window.loadMoreObserver.disconnect();
      }

      const loadMoreBtn = document.getElementById('loadMoreBtn');
      if (!loadMoreBtn) return;

      // å»ºç«‹æ–°çš„ IntersectionObserver
      window.loadMoreObserver = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
          // ç•¶æŒ‰éˆ•é€²å…¥è¦–çª—ä¸”æ²’æœ‰åœ¨è¼‰å…¥ä¸­
          if (entry.isIntersecting && !isLoading && hasMoreData) {
            loadMoreExpenses();
          }
        });
      }, {
        root: null, // ä½¿ç”¨ç€è¦½å™¨è¦–çª—
        rootMargin: '100px', // æå‰ 100px é–‹å§‹è¼‰å…¥
        threshold: 0.1
      });

      window.loadMoreObserver.observe(loadMoreBtn);
    }

    // ç·¨è¼¯è¨˜éŒ„
    function editExpense(id) {
      // å¾ displayedExpenses æ‰¾åˆ°è©²ç­†è¨˜éŒ„
      const expense = displayedExpenses.find(function(exp) {
        return String(exp.id) === String(id);
      });

      if (!expense) {
        showToast('æ‰¾ä¸åˆ°è©²ç­†è¨˜éŒ„', 'error');
        return;
      }

      // å¡«å…¥ç·¨è¼¯è¡¨å–®
      document.getElementById('editExpenseId').value = expense.id;

      // è™•ç†æ—¥æœŸæ™‚é–“
      if (expense.date.includes(':')) {
        // æœ‰æ™‚é–“
        const parts = expense.date.split(' ');
        document.getElementById('editExpenseDate').value = parts[0];
        document.getElementById('editExpenseTime').value = parts[1].substring(0, 5);
      } else {
        // åªæœ‰æ—¥æœŸ
        document.getElementById('editExpenseDate').value = expense.date;
        document.getElementById('editExpenseTime').value = '00:00';
      }

      document.getElementById('editItem').value = expense.item;
      document.getElementById('editAmount').value = expense.amount;

      // è™•ç†åˆ†é¡ï¼ˆä¸»åˆ†é¡å’Œå­åˆ†é¡ï¼‰
      if (expense.category.includes('>')) {
        const parts = expense.category.split('>');
        document.getElementById('editMainCategory').value = parts[0].trim();
        updateEditSubCategories();
        document.getElementById('editSubCategory').value = parts[1].trim();
      } else {
        document.getElementById('editMainCategory').value = expense.category;
        updateEditSubCategories();
      }

      // åˆ¤æ–·ä»˜æ¬¾æ–¹å¼
      if (expense.payer === 'å…©äºº') {
        // æª¢æŸ¥æ˜¯å¦ç‚ºå¹³åˆ†
        if (Math.abs(expense.yourPart - expense.partnerPart) < 0.01) {
          document.getElementById('editSplitType').value = 'equal';
          document.getElementById('editPayerGroup').classList.add('hidden');
          document.getElementById('editCustomSplit').classList.add('hidden');
        } else {
          // è‡ªè¨‚åˆ†å¸³
          document.getElementById('editSplitType').value = 'custom';
          document.getElementById('editYourPart').value = expense.yourPart;
          document.getElementById('editPartnerPart').value = expense.partnerPart;
          document.getElementById('editPayerGroup').classList.add('hidden');
          document.getElementById('editCustomSplit').classList.remove('hidden');
        }
      } else {
        // å–®äººä»˜æ¬¾
        document.getElementById('editSplitType').value = 'single';
        document.getElementById('editPayer').value = expense.payer;
        document.getElementById('editPayerGroup').classList.remove('hidden');
        document.getElementById('editCustomSplit').classList.add('hidden');
      }

      // é–‹å•Ÿ Modal
      document.getElementById('editExpenseModal').classList.remove('hidden');
    }

    function closeEditExpenseModal() {
      document.getElementById('editExpenseModal').classList.add('hidden');
    }

    /**
     * é–‹å•Ÿè¨­å®šæ¨¡æ…‹æ¡†
     */
    function openSettingsModal() {
      // è¼‰å…¥ç›®å‰é…è‰²
      document.getElementById('settingTheme').value = appSettings.theme;
      document.getElementById('settingsModal').classList.remove('hidden');
    }

    /**
     * é—œé–‰è¨­å®šæ¨¡æ…‹æ¡†
     */
    function closeSettingsModal() {
      document.getElementById('settingsModal').classList.add('hidden');
    }

    /**
     * å„²å­˜é…è‰²ä¸»é¡Œ
     */
    function saveTheme() {
      const theme = document.getElementById('settingTheme').value;

      // å„²å­˜åˆ° localStorage
      localStorage.setItem('accountingTheme', theme);
      appSettings.theme = theme;

      // å¥—ç”¨é…è‰²
      applyTheme(theme);

      // é—œé–‰æ¨¡æ…‹æ¡†
      closeSettingsModal();

      // é¡¯ç¤ºæç¤º
      showToast('é…è‰²å·²æ›´æ–°ï¼', 'success');
    }

    function updateEditPayerOptions() {
      const splitType = document.getElementById('editSplitType').value;
      const payerGroup = document.getElementById('editPayerGroup');
      const customSplit = document.getElementById('editCustomSplit');

      if (splitType === 'single') {
        payerGroup.classList.remove('hidden');
        customSplit.classList.add('hidden');
      } else if (splitType === 'equal') {
        payerGroup.classList.add('hidden');
        customSplit.classList.add('hidden');
      } else {
        payerGroup.classList.add('hidden');
        customSplit.classList.remove('hidden');
      }
    }

    function updateExpense() {
      const id = document.getElementById('editExpenseId').value;
      const item = document.getElementById('editItem').value.trim();
      const amount = parseFloat(document.getElementById('editAmount').value);
      const splitType = document.getElementById('editSplitType').value;
      const payer = document.getElementById('editPayer').value;

      // çµ„åˆä¸»åˆ†é¡å’Œå­åˆ†é¡
      const mainCategory = document.getElementById('editMainCategory').value;
      const subCategory = document.getElementById('editSubCategory').value;
      const category = subCategory ? (mainCategory + '>' + subCategory) : mainCategory;

      // å‰ç«¯é©—è­‰
      if (!validateInput(item, 'text', 1, 100)) {
        showToast('é …ç›®åç¨±å¿…é ˆæ˜¯ 1-100 å­—å…ƒ', 'error');
        return;
      }

      if (!validateInput(amount, 'number', 0.01, 9999999)) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ï¼ˆ0.01 åˆ° 9,999,999ï¼‰', 'error');
        return;
      }

      let yourPart = 0, partnerPart = 0, displayPayer = '';

      if (splitType === 'single') {
        if (payer === 'ä½ ') {
          yourPart = amount;
          displayPayer = 'ä½ ';
        } else {
          partnerPart = amount;
          displayPayer = 'å°æ–¹';
        }
      } else if (splitType === 'equal') {
        yourPart = partnerPart = amount / 2;
        displayPayer = 'å…©äºº';
      } else {
        yourPart = parseFloat(document.getElementById('editYourPart').value) || 0;
        partnerPart = parseFloat(document.getElementById('editPartnerPart').value) || 0;
        if (Math.abs(yourPart + partnerPart - amount) > 0.01) {
          showToast('è‡ªè¨‚åˆ†å¸³é‡‘é¡ç¸½å’Œå¿…é ˆç­‰æ–¼ç¸½é‡‘é¡', 'error');
          return;
        }
        displayPayer = 'å…©äºº';
      }

      // å–å¾—æ—¥æœŸæ™‚é–“
      const expenseDate = document.getElementById('editExpenseDate').value;
      const expenseTime = document.getElementById('editExpenseTime').value;

      const updatedData = {
        id: id,
        item: item,
        amount: amount,
        payer: displayPayer,
        yourPart: yourPart,
        partnerPart: partnerPart,
        category: category,
        date: expenseDate + ' ' + expenseTime  // çµ„åˆæ—¥æœŸå’Œæ™‚é–“
      };

      google.script.run
        .withSuccessHandler(function() {
          showToast('æ›´æ–°æˆåŠŸï¼ âœ¨', 'success');
          closeEditExpenseModal();
          loadData();
        })
        .withFailureHandler(function(error) {
          showError(error);
        })
        .updateExpenseById(updatedData);
    }

    // åˆªé™¤è¨˜éŒ„
    function deleteExpense(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          showToast('åˆªé™¤æˆåŠŸï¼', 'success');
          loadData();
        })
        .withFailureHandler(showError)
        .deleteExpenseById(id);
    }

    // ==================== å„€è¡¨æ¿åŠŸèƒ½ ====================

    let currentDashboardPeriod = 'currentMonth';

    function changeDashboardPeriod() {
      currentDashboardPeriod = document.getElementById('dashboardPeriod').value;
      const customRangeSelector = document.getElementById('customRangeSelector');

      if (currentDashboardPeriod === 'custom') {
        customRangeSelector.classList.remove('hidden');
        // è¨­å®šé è¨­æ—¥æœŸ
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        document.getElementById('customStartDate').value = firstDayOfMonth.toISOString().split('T')[0];
        document.getElementById('customEndDate').value = now.toISOString().split('T')[0];
      } else {
        customRangeSelector.classList.add('hidden');
        updateDashboard(allExpenses);
      }
    }

    function applyCustomRange() {
      const startDate = document.getElementById('customStartDate').value;
      const endDate = document.getElementById('customEndDate').value;

      if (!startDate || !endDate) {
        showToast('è«‹é¸æ“‡é–‹å§‹å’ŒçµæŸæ—¥æœŸ', 'error');
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        showToast('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ', 'error');
        return;
      }

      updateDashboard(allExpenses);
    }

    function updateDashboard(expenses) {
      const period = currentDashboardPeriod;

      if (period === 'comparison') {
        updateComparisonDashboard(expenses);
      } else {
        updateSinglePeriodDashboard(expenses, period);
      }
    }

    function updateSinglePeriodDashboard(expenses, period) {
      const now = new Date();
      let periodExpenses, periodName, icon, daysCount;

      // æ ¹æ“šé¸æ“‡çš„æ™‚é–“ç¯„åœç¯©é¸æ•¸æ“š
      if (period === 'currentMonth') {
        periodName = 'æœ¬æœˆ';
        icon = 'ğŸ“…';
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
        });
        daysCount = now.getDate();
      } else if (period === 'lastMonth') {
        periodName = 'ä¸Šæœˆ';
        icon = 'ğŸ“…';
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate.getMonth() === lastMonth.getMonth() && expDate.getFullYear() === lastMonth.getFullYear();
        });
        daysCount = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0).getDate();
      } else if (period === 'last7days') {
        periodName = 'æœ€è¿‘ 7 å¤©';
        icon = 'ğŸ“Š';
        const sevenDaysAgo = new Date(now);
        sevenDaysAgo.setDate(now.getDate() - 7);
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate >= sevenDaysAgo;
        });
        daysCount = 7;
      } else if (period === 'last30days') {
        periodName = 'æœ€è¿‘ 30 å¤©';
        icon = 'ğŸ“Š';
        const thirtyDaysAgo = new Date(now);
        thirtyDaysAgo.setDate(now.getDate() - 30);
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate >= thirtyDaysAgo;
        });
        daysCount = 30;
      } else if (period === 'currentYear') {
        periodName = 'ä»Šå¹´';
        icon = 'ğŸ“†';
        const currentYear = now.getFullYear();
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate.getFullYear() === currentYear;
        });
        const yearStart = new Date(currentYear, 0, 1);
        daysCount = Math.floor((now - yearStart) / (1000 * 60 * 60 * 24)) + 1;
      } else if (period === 'all') {
        periodName = 'å…¨éƒ¨';
        icon = 'ğŸ“š';
        periodExpenses = expenses;
        if (expenses.length > 0) {
          const dates = expenses.map(exp => new Date(exp.date));
          const minDate = new Date(Math.min(...dates));
          const maxDate = new Date(Math.max(...dates));
          daysCount = Math.floor((maxDate - minDate) / (1000 * 60 * 60 * 24)) + 1;
        } else {
          daysCount = 1;
        }
      } else if (period === 'custom') {
        periodName = 'è‡ªè¨‚ç¯„åœ';
        icon = 'ğŸ”';
        const startDate = new Date(document.getElementById('customStartDate').value);
        const endDate = new Date(document.getElementById('customEndDate').value);
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate >= startDate && expDate <= endDate;
        });
        daysCount = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
      }

      // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
      const total = periodExpenses.reduce(function(sum, exp) {
        return sum + Number(exp.amount);
      }, 0);
      const count = periodExpenses.length;
      const dailyAvg = daysCount > 0 ? total / daysCount : 0;

      // è¨ˆç®—åˆ†é¡çµ±è¨ˆ
      const categoryStats = {};
      periodExpenses.forEach(function(exp) {
        if (!categoryStats[exp.category]) {
          categoryStats[exp.category] = 0;
        }
        categoryStats[exp.category] += Number(exp.amount);
      });

      // ç”Ÿæˆåˆ†é¡å æ¯”æ–‡å­—
      const categoryIcons = {
        'é£²é£Ÿ': 'ğŸœ',
        'å±…ä½': 'ğŸ ',
        'äº¤é€š': 'ğŸš—',
        'å¨›æ¨‚': 'ğŸ®',
        'æœé£¾': 'ğŸ‘”',
        'å…¶ä»–': 'ğŸ“¦'
      };

      let categoryText = '';
      if (total > 0) {
        const sortedCategories = Object.entries(categoryStats).sort((a, b) => b[1] - a[1]);
        categoryText = sortedCategories.slice(0, 3).map(function([cat, amount]) {
          const percentage = ((amount / total) * 100).toFixed(0);
          const icon = categoryIcons[cat] || 'ğŸ“¦';
          return icon + cat + ' ' + percentage + '%';
        }).join('<br>');
      } else {
        categoryText = '-';
      }

      // æ›´æ–°ç¬¬ä¸€å¼µå¡ç‰‡
      document.getElementById('dashboardIcon1').textContent = icon;
      document.getElementById('dashboardTitle1').textContent = periodName + 'æ¦‚æ³';
      document.getElementById('label1').textContent = 'ç¸½æ”¯å‡º';
      document.getElementById('value1').textContent = formatMoney(total);
      document.getElementById('label2').textContent = 'è¨˜éŒ„æ•¸';
      document.getElementById('value2').textContent = count + ' ç­†';
      document.getElementById('label3').textContent = 'åˆ†é¡å æ¯”';
      document.getElementById('value3').innerHTML = categoryText;

      let topCategory = 'é£²é£Ÿ';
      let maxCategoryAmount = 0;
      for (const cat in categoryStats) {
        if (categoryStats[cat] > maxCategoryAmount) {
          maxCategoryAmount = categoryStats[cat];
          topCategory = cat;
        }
      }

      const maxExpense = periodExpenses.length > 0 ? Math.max(...periodExpenses.map(function(exp) {
        return Number(exp.amount);
      })) : 0;

      const payerStats = {};
      periodExpenses.forEach(function(exp) {
        if (!payerStats[exp.payer]) {
          payerStats[exp.payer] = 0;
        }
        payerStats[exp.payer]++;
      });

      let topPayer = 'ä½ ';
      let maxPayerCount = 0;
      for (const payer in payerStats) {
        if (payerStats[payer] > maxPayerCount) {
          maxPayerCount = payerStats[payer];
          topPayer = payer;
        }
      }

      // ç¬¬äºŒå¼µå¡ç‰‡æ˜¯ã€Œä»˜æ¬¾çµ±è¨ˆã€ï¼Œå·²ç¶“åœ¨ updateUI ä¸­æ›´æ–°äº†
      // é€™è£¡ä¸éœ€è¦é¡å¤–æ›´æ–°

      // æ›´æ–°ç¬¬ä¸‰å¼µå¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨çš„è©±ï¼Œå·²åˆä½µåˆ°æ¯”è¼ƒæ¨¡å¼ï¼‰
      const card3 = document.getElementById('dashboardTitle3');
      if (card3) {
        document.getElementById('dashboardTitle3').textContent = periodName + 'è¶¨å‹¢';
        const label4 = document.getElementById('label4');
        const label5 = document.getElementById('label5');
        const label6 = document.getElementById('label6');
        if (label4) document.getElementById('label4').textContent = 'ç¸½æ”¯å‡º';
        if (label4) document.getElementById('value4').textContent = formatMoney(total);
        if (label5) document.getElementById('label5').textContent = 'æ—¥å‡æ”¯å‡º';
        if (label5) document.getElementById('value5').textContent = formatMoney(Math.round(dailyAvg));
        if (label6) document.getElementById('label6').textContent = 'è¨˜å¸³æ¬¡æ•¸';
        if (label6) document.getElementById('value6').textContent = count + ' ç­†';
      }
    }

    function updateComparisonDashboard(expenses) {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      // æœ¬æœˆæ•¸æ“š
      const currentMonthExpenses = expenses.filter(function(exp) {
        const expDate = new Date(exp.date);
        return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
      });

      // ä¸Šæœˆæ•¸æ“š
      const lastMonth = new Date(currentYear, currentMonth - 1, 1);
      const lastMonthExpenses = expenses.filter(function(exp) {
        const expDate = new Date(exp.date);
        return expDate.getMonth() === lastMonth.getMonth() && expDate.getFullYear() === lastMonth.getFullYear();
      });

      // è¨ˆç®—æœ¬æœˆçµ±è¨ˆ
      const currentTotal = currentMonthExpenses.reduce(function(sum, exp) {
        return sum + Number(exp.amount);
      }, 0);
      const currentCount = currentMonthExpenses.length;
      const currentDays = now.getDate();
      const currentDailyAvg = currentDays > 0 ? currentTotal / currentDays : 0;

      // è¨ˆç®—ä¸Šæœˆçµ±è¨ˆ
      const lastTotal = lastMonthExpenses.reduce(function(sum, exp) {
        return sum + Number(exp.amount);
      }, 0);
      const lastCount = lastMonthExpenses.length;
      const lastMonthDays = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0).getDate();
      const lastDailyAvg = lastMonthDays > 0 ? lastTotal / lastMonthDays : 0;

      // è¨ˆç®—å¢æ¸›ç™¾åˆ†æ¯”
      function calculateChange(current, last) {
        if (last === 0) return current > 0 ? 100 : 0;
        return ((current - last) / last * 100).toFixed(1);
      }

      function getTrendHTML(change) {
        const changeNum = parseFloat(change);
        if (changeNum > 0) {
          return '<span class="trend-indicator trend-up">â†‘ ' + Math.abs(changeNum) + '%</span>';
        } else if (changeNum < 0) {
          return '<span class="trend-indicator trend-down">â†“ ' + Math.abs(changeNum) + '%</span>';
        } else {
          return '<span class="trend-indicator trend-neutral">â”€ 0%</span>';
        }
      }

      const totalChange = calculateChange(currentTotal, lastTotal);
      const countChange = calculateChange(currentCount, lastCount);
      const avgChange = calculateChange(currentDailyAvg, lastDailyAvg);

      // è¨ˆç®—æœ¬æœˆåˆ†é¡å æ¯”
      const currentCategoryStats = {};
      currentMonthExpenses.forEach(function(exp) {
        if (!currentCategoryStats[exp.category]) {
          currentCategoryStats[exp.category] = 0;
        }
        currentCategoryStats[exp.category] += Number(exp.amount);
      });

      const categoryIcons = {
        'é£²é£Ÿ': 'ğŸœ',
        'å±…ä½': 'ğŸ ',
        'äº¤é€š': 'ğŸš—',
        'å¨›æ¨‚': 'ğŸ®',
        'æœé£¾': 'ğŸ‘”',
        'å…¶ä»–': 'ğŸ“¦'
      };

      let categoryText = '';
      if (currentTotal > 0) {
        const sortedCategories = Object.entries(currentCategoryStats).sort((a, b) => b[1] - a[1]);
        categoryText = sortedCategories.slice(0, 3).map(function([cat, amount]) {
          const percentage = ((amount / currentTotal) * 100).toFixed(0);
          const icon = categoryIcons[cat] || 'ğŸ“¦';
          return icon + cat + ' ' + percentage + '%';
        }).join('<br>');
      } else {
        categoryText = '-';
      }

      // æ›´æ–°ç¬¬ä¸€å¼µå¡ç‰‡ï¼ˆæœ¬æœˆï¼‰
      document.getElementById('dashboardIcon1').textContent = 'ğŸ“…';
      document.getElementById('dashboardTitle1').textContent = 'æœ¬æœˆæ•¸æ“š';
      document.getElementById('label1').textContent = 'ç¸½æ”¯å‡º';
      document.getElementById('value1').innerHTML = formatMoney(currentTotal) + getTrendHTML(totalChange);
      document.getElementById('label2').textContent = 'è¨˜éŒ„æ•¸';
      document.getElementById('value2').innerHTML = currentCount + ' ç­†' + getTrendHTML(countChange);
      document.getElementById('label3').textContent = 'åˆ†é¡å æ¯”';
      document.getElementById('value3').innerHTML = categoryText;

      // æ›´æ–°ç¬¬äºŒå¼µå¡ç‰‡ï¼ˆä¸Šæœˆï¼‰
      document.getElementById('dashboardTitle2').textContent = 'ä¸Šæœˆæ•¸æ“š';
      document.getElementById('topCategory').textContent = 'ç¸½æ”¯å‡º $' + lastTotal.toLocaleString();
      document.getElementById('maxExpense').textContent = 'è¨˜éŒ„æ•¸ ' + lastCount + ' ç­†';
      document.getElementById('topPayer').textContent = 'æ—¥å‡ $' + Math.round(lastDailyAvg).toLocaleString();

      // è¨ˆç®—æ’è¡Œï¼ˆä½¿ç”¨æœ¬æœˆæ•¸æ“šï¼‰
      const categoryStats = {};
      currentMonthExpenses.forEach(function(exp) {
        if (!categoryStats[exp.category]) {
          categoryStats[exp.category] = 0;
        }
        categoryStats[exp.category] += Number(exp.amount);
      });

      let topCategory = 'é£²é£Ÿ';
      let maxCategoryAmount = 0;
      for (const cat in categoryStats) {
        if (categoryStats[cat] > maxCategoryAmount) {
          maxCategoryAmount = categoryStats[cat];
          topCategory = cat;
        }
      }

      // æ›´æ–°ç¬¬ä¸‰å¼µå¡ç‰‡ï¼ˆè¶¨å‹¢åˆ†æï¼‰
      document.getElementById('dashboardTitle3').textContent = 'è¶¨å‹¢åˆ†æ';

      let analysis = '';
      if (parseFloat(totalChange) > 10) {
        analysis = 'âš ï¸ æ”¯å‡ºæ˜é¡¯å¢åŠ ';
      } else if (parseFloat(totalChange) < -10) {
        analysis = 'âœ… æ”¯å‡ºæ˜é¡¯æ¸›å°‘';
      } else {
        analysis = 'ğŸ“Š æ”¯å‡ºç›¸å°ç©©å®š';
      }

      document.getElementById('label4').textContent = 'æœˆåº¦è®ŠåŒ–';
      document.getElementById('value4').textContent = analysis;
      document.getElementById('label5').textContent = 'æœ¬æœˆæœ€å¤š';
      document.getElementById('value5').textContent = topCategory + ' $' + maxCategoryAmount.toLocaleString();
      document.getElementById('label6').textContent = 'è¨˜å¸³æ¬¡æ•¸';
      document.getElementById('value6').textContent = currentCount + ' vs ' + lastCount;
    }

    // ==================== å¿«é€Ÿè¨˜å¸³åŠŸèƒ½ ====================

    function quickExpense(item, amount, category) {
      // è‡ªå‹•å¡«å…¥è¡¨å–®
      document.getElementById('item').value = item;
      document.getElementById('amount').value = amount;
      document.getElementById('category').value = category;

      // æ»¾å‹•åˆ°é‡‘é¡è¼¸å…¥æ¡†
      document.getElementById('amount').focus();
      document.getElementById('amount').select();

      // é¡¯ç¤ºæç¤º
      showToast('å·²å¡«å…¥ã€Œ' + item + ' $' + amount + 'ã€ï¼Œå¯ä¿®æ”¹é‡‘é¡å¾Œé€å‡º', 'success');
    }

    function addExpense() {
      const item = document.getElementById('item').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);

      // çµ„åˆä¸»åˆ†é¡å’Œå­åˆ†é¡
      const mainCategory = document.getElementById('mainCategory').value;
      const subCategory = document.getElementById('subCategory').value;
      const category = subCategory ? (mainCategory + '>' + subCategory) : mainCategory;

      // å€‹äººæ¨¡å¼ï¼šè‡ªå‹•è¨­å®šä»˜æ¬¾äººç‚ºã€Œä½ ã€ï¼Œåˆ†å¸³ç‚º 100%/0%
      if (appSettings.mode === 'å€‹äººè¨˜å¸³') {
        document.getElementById('actualPayer').value = 'you';
        document.getElementById('payForYou').checked = true;
        document.getElementById('payForPartner').checked = false;
      }

      // å‰ç«¯é©—è­‰
      if (!validateInput(item, 'text', 1, 100)) {
        showToast('é …ç›®åç¨±å¿…é ˆæ˜¯ 1-100 å­—å…ƒ', 'error');
        return;
      }

      if (!validateInput(amount, 'number', 0.01, 9999999)) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ï¼ˆ0.01 åˆ° 9,999,999ï¼‰', 'error');
        return;
      }

      // å–å¾—èª°ä»˜éŒ¢å’Œå¯¦éš›ä»˜æ¬¾é‡‘é¡
      const actualPayerValue = document.getElementById('actualPayer').value;
      let actualPayer = '';
      let yourActualPaidAmount = 0;
      let partnerActualPaidAmount = 0;

      if (actualPayerValue === 'you') {
        actualPayer = 'ä½ ';
        yourActualPaidAmount = amount;
        partnerActualPaidAmount = 0;
      } else if (actualPayerValue === 'partner') {
        actualPayer = 'å°æ–¹';
        yourActualPaidAmount = 0;
        partnerActualPaidAmount = amount;
      } else if (actualPayerValue === 'each') {
        actualPayer = 'å„è‡ª';
        // å„è‡ªä»˜çš„é‡‘é¡ç¨å¾Œæ ¹æ“šè² æ“”é‡‘é¡è¨­å®š
      } else if (actualPayerValue === 'unequal') {
        // ä¸ç­‰é¡å¢Šä»˜
        actualPayer = 'ä¸ç­‰é¡';
        yourActualPaidAmount = parseFloat(document.getElementById('yourActualPaid').value) || 0;
        partnerActualPaidAmount = parseFloat(document.getElementById('partnerActualPaid').value) || 0;

        // é©—è­‰
        if (yourActualPaidAmount < 0 || partnerActualPaidAmount < 0) {
          showToast('å¯¦éš›ä»˜æ¬¾é‡‘é¡ä¸èƒ½ç‚ºè² æ•¸', 'error');
          return;
        }

        const totalPaid = yourActualPaidAmount + partnerActualPaidAmount;
        if (Math.abs(totalPaid - amount) > 0.01) {
          showToast('å¯¦éš›ä»˜æ¬¾ç¸½å’Œï¼ˆ' + totalPaid + 'ï¼‰å¿…é ˆç­‰æ–¼ç¸½é‡‘é¡ï¼ˆ' + amount + 'ï¼‰', 'error');
          return;
        }

        if (yourActualPaidAmount === 0 && partnerActualPaidAmount === 0) {
          showToast('è«‹å¡«å…¥å¯¦éš›ä»˜æ¬¾é‡‘é¡', 'error');
          return;
        }
      }

      // å–å¾—å¹«èª°ä»˜æ¬¾
      const payForYou = document.getElementById('payForYou').checked;
      const payForPartner = document.getElementById('payForPartner').checked;

      // æª¢æŸ¥è‡³å°‘è¦å‹¾é¸ä¸€å€‹
      if (!payForYou && !payForPartner) {
        showToast('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹æˆå“¡', 'error');
        return;
      }

      let yourPart = 0, partnerPart = 0, displayPayer = '';

      // åˆ¤æ–·ç•¶å‰ä½¿ç”¨çš„åˆ†å¸³æ–¹å¼
      const autoSplitActive = document.getElementById('autoSplitBtn').classList.contains('active');
      const amountSplitActive = document.getElementById('amountSplitBtn').classList.contains('active');
      const ratioSplitActive = document.getElementById('ratioSplitBtn').classList.contains('active');

      if (payForYou && payForPartner) {
        // å…©å€‹éƒ½å‹¾é¸ï¼šä½¿ç”¨é¸å®šçš„åˆ†å¸³æ–¹å¼
        if (amountSplitActive) {
          // é‡‘é¡åˆ†å¸³
          const yourPartAmount = parseFloat(document.getElementById('yourPartAmount').value) || 0;
          const partnerPartAmount = parseFloat(document.getElementById('partnerPartAmount').value) || 0;

          if (yourPartAmount <= 0 || partnerPartAmount <= 0) {
            showToast('è«‹å¡«å…¥å…©äººçš„åˆ†å¸³é‡‘é¡', 'error');
            return;
          }

          if (Math.abs(yourPartAmount + partnerPartAmount - amount) > 0.01) {
            showToast('åˆ†å¸³é‡‘é¡ç¸½å’Œå¿…é ˆç­‰æ–¼ç¸½é‡‘é¡ $' + amount, 'error');
            return;
          }

          yourPart = yourPartAmount;
          partnerPart = partnerPartAmount;

        } else if (ratioSplitActive) {
          // æ¯”ä¾‹åˆ†å¸³
          const yourPartRatio = parseFloat(document.getElementById('yourPartRatio').value) || 0;
          const partnerPartRatio = parseFloat(document.getElementById('partnerPartRatio').value) || 0;

          if (yourPartRatio <= 0 || partnerPartRatio <= 0) {
            showToast('è«‹å¡«å…¥å…©äººçš„åˆ†å¸³æ¯”ä¾‹', 'error');
            return;
          }

          if (Math.abs(yourPartRatio + partnerPartRatio - 100) > 0.01) {
            showToast('åˆ†å¸³æ¯”ä¾‹ç¸½å’Œå¿…é ˆç­‰æ–¼ 100%', 'error');
            return;
          }

          yourPart = Math.round(amount * yourPartRatio / 100 * 100) / 100;
          partnerPart = Math.round(amount * partnerPartRatio / 100 * 100) / 100;

          // ä¿®æ­£æµ®é»æ•¸èª¤å·®
          const diff = amount - (yourPart + partnerPart);
          if (Math.abs(diff) > 0) {
            yourPart += diff;
          }

        } else {
          // è‡ªå‹•å‡åˆ†ï¼ˆé è¨­ï¼‰
          yourPart = partnerPart = Math.round(amount / 2 * 100) / 100;

          // ä¿®æ­£æµ®é»æ•¸èª¤å·®ï¼ˆå¦‚æœæœ‰å¥‡æ•¸åˆ†ï¼‰
          const diff = amount - (yourPart + partnerPart);
          if (Math.abs(diff) > 0) {
            yourPart += diff;
          }
        }
      } else if (payForYou) {
        // åªå‹¾ã€Œæˆ‘ã€â†’ æˆ‘å…¨é¡
        yourPart = amount;
        partnerPart = 0;
      } else if (payForPartner) {
        // åªå‹¾ã€Œå°æ–¹ã€â†’ å°æ–¹å…¨é¡
        yourPart = 0;
        partnerPart = amount;
      }

      // å¦‚æœæ˜¯ã€Œå„è‡ªã€ä»˜æ¬¾ï¼Œå¯¦éš›ä»˜æ¬¾é‡‘é¡ç­‰æ–¼è² æ“”é‡‘é¡
      if (actualPayerValue === 'each') {
        yourActualPaidAmount = yourPart;
        partnerActualPaidAmount = partnerPart;
      }

      // è¨­å®š displayPayer
      if (payForYou && payForPartner) {
        displayPayer = 'å…©äºº';
      } else if (payForYou) {
        displayPayer = 'ä½ ';
      } else {
        displayPayer = 'å°æ–¹';
      }

      // é€±æœŸæ”¯å‡ºè¨­å®š
      const isRecurring = document.getElementById('isRecurring').checked;
      const recurringDay = isRecurring ? parseInt(document.getElementById('recurringDay').value) || 0 : 0;

      // é©—è­‰é€±æœŸæ—¥æœŸ
      if (isRecurring && (recurringDay < 1 || recurringDay > 31)) {
        showToast('æ¯æœˆåŸ·è¡Œæ—¥å¿…é ˆåœ¨ 1-31 ä¹‹é–“', 'error');
        return;
      }

      // å–å¾—æ—¥æœŸå’Œæ™‚é–“
      const expenseDate = document.getElementById('expenseDate').value;
      const expenseTime = document.getElementById('expenseTime').value;

      const expenseData = {
        item: item,
        amount: amount,
        payer: displayPayer,
        actualPayer: actualPayer,  // èª°å…ˆä»˜éŒ¢
        yourPart: yourPart,  // ä½ æ‡‰è©²è² æ“”çš„é‡‘é¡
        partnerPart: partnerPart,  // å°æ–¹æ‡‰è©²è² æ“”çš„é‡‘é¡
        yourActualPaid: yourActualPaidAmount,  // ä½ å¯¦éš›ä»˜å‡ºçš„é‡‘é¡
        partnerActualPaid: partnerActualPaidAmount,  // å°æ–¹å¯¦éš›ä»˜å‡ºçš„é‡‘é¡
        category: category,
        isRecurring: isRecurring,
        recurringDay: recurringDay,
        expenseDate: expenseDate,  // æ”¯å‡ºæ—¥æœŸ
        expenseTime: expenseTime   // æ”¯å‡ºæ™‚é–“
      };

      // æŒ‰éˆ• Loading ç‹€æ…‹
      const btn = document.querySelector('.btn-primary');
      btn.disabled = true;
      btn.classList.add('btn-loading');

      google.script.run
        .withSuccessHandler(function() {
          showToast('æ–°å¢æˆåŠŸï¼ ğŸ‰', 'success');

          // æ¸…ç©ºè¡¨å–®
          document.getElementById('item').value = '';
          document.getElementById('amount').value = '';
          document.getElementById('isRecurring').checked = false;
          document.getElementById('recurringDay').value = '';
          document.getElementById('recurringDayGroup').classList.add('hidden');

          // æ¸…ç©ºåˆ†å¸³æ¬„ä½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          const yourPartAmount = document.getElementById('yourPartAmount');
          const partnerPartAmount = document.getElementById('partnerPartAmount');
          const yourPartRatio = document.getElementById('yourPartRatio');
          const partnerPartRatio = document.getElementById('partnerPartRatio');
          const yourActualPaid = document.getElementById('yourActualPaid');
          const partnerActualPaid = document.getElementById('partnerActualPaid');

          if (yourPartAmount) yourPartAmount.value = '';
          if (partnerPartAmount) partnerPartAmount.value = '';
          if (yourPartRatio) yourPartRatio.value = '';
          if (partnerPartRatio) partnerPartRatio.value = '';
          if (yourActualPaid) yourActualPaid.value = '';
          if (partnerActualPaid) partnerActualPaid.value = '';

          // é‡ç½®æ—¥æœŸæ™‚é–“ç‚ºç•¶ä¸‹
          const now = new Date();
          const dateStr = now.toISOString().split('T')[0];
          const timeStr = now.toTimeString().substring(0, 5);
          document.getElementById('expenseDate').value = dateStr;
          document.getElementById('expenseTime').value = timeStr;

          btn.disabled = false;
          btn.classList.remove('btn-loading');
          loadData();
        })
        .withFailureHandler(function(error) {
          showError(error);
          btn.disabled = false;
          btn.classList.remove('btn-loading');
        })
        .addExpenseFromWeb(expenseData);
    }

    function updatePaymentMethod() {
      const actualPayerValue = document.getElementById('actualPayer').value;
      const unequalPaymentFields = document.getElementById('unequalPaymentFields');
      const payForYou = document.getElementById('payForYou').checked;
      const payForPartner = document.getElementById('payForPartner').checked;
      const splitMethodGroup = document.getElementById('splitMethodGroup');

      // é¡¯ç¤º/éš±è—ä¸ç­‰é¡å¢Šä»˜æ¬„ä½
      if (actualPayerValue === 'unequal') {
        unequalPaymentFields.classList.remove('hidden');
      } else {
        unequalPaymentFields.classList.add('hidden');
      }

      // é¡¯ç¤º/éš±è—åˆ†å¸³æ–¹å¼é¸æ“‡ï¼ˆç•¶å‹¾é¸å¤šå€‹æˆå“¡æ™‚ï¼‰
      if ((payForYou && payForPartner) || (payForYou || payForPartner)) {
        // åªè¦æœ‰å‹¾é¸æˆå“¡å°±é¡¯ç¤ºåˆ†å¸³æ–¹å¼
        if (payForYou && payForPartner) {
          splitMethodGroup.classList.remove('hidden');
        } else {
          // åªå‹¾é¸ä¸€å€‹äººæ™‚ï¼Œéš±è—åˆ†å¸³æ–¹å¼ï¼ˆé è¨­å…¨é¡ï¼‰
          splitMethodGroup.classList.add('hidden');
          document.getElementById('amountSplitGroup').classList.add('hidden');
          document.getElementById('ratioSplitGroup').classList.add('hidden');
        }
      } else {
        splitMethodGroup.classList.add('hidden');
      }

      // è‡³å°‘è¦å‹¾é¸ä¸€å€‹
      if (!payForYou && !payForPartner) {
        showToast('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹æˆå“¡', 'error');
        document.getElementById('payForYou').checked = true;
        updatePaymentMethod(); // é‡æ–°è§¸ç™¼
      }
    }

    // å³æ™‚æ›´æ–°ä¸ç­‰é¡å¢Šä»˜çš„æç¤º
    function updateUnequalPaymentHint() {
      const amount = parseFloat(document.getElementById('amount').value) || 0;
      const yourPaid = parseFloat(document.getElementById('yourActualPaid').value) || 0;
      const partnerPaid = parseFloat(document.getElementById('partnerActualPaid').value) || 0;
      const total = yourPaid + partnerPaid;
      const hintEl = document.getElementById('unequalPaymentHint');

      if (amount === 0) {
        hintEl.innerHTML = 'ğŸ’¡ æç¤ºï¼šè«‹å…ˆå¡«å¯«ä¸Šæ–¹é‡‘é¡';
        hintEl.style.color = '#666';
      } else if (yourPaid === 0 && partnerPaid === 0) {
        hintEl.innerHTML = 'ğŸ’¡ æç¤ºï¼šå…©è€…ç¸½å’Œå¿…é ˆç­‰æ–¼ $' + amount;
        hintEl.style.color = '#666';
      } else if (Math.abs(total - amount) < 0.01) {
        hintEl.innerHTML = 'âœ… æ­£ç¢ºï¼šç¸½å’Œ $' + total.toFixed(2) + ' = é‡‘é¡ $' + amount;
        hintEl.style.color = '#10b981';
      } else {
        hintEl.innerHTML = 'âŒ éŒ¯èª¤ï¼šç¸½å’Œ $' + total.toFixed(2) + ' â‰  é‡‘é¡ $' + amount + 'ï¼ˆå·® $' + Math.abs(total - amount).toFixed(2) + 'ï¼‰';
        hintEl.style.color = '#ef4444';
      }
    }

    function setSplitMethod(method) {
      const amountSplitGroup = document.getElementById('amountSplitGroup');
      const ratioSplitGroup = document.getElementById('ratioSplitGroup');
      const autoBtn = document.getElementById('autoSplitBtn');
      const amountBtn = document.getElementById('amountSplitBtn');
      const ratioBtn = document.getElementById('ratioSplitBtn');

      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      autoBtn.classList.remove('active');
      amountBtn.classList.remove('active');
      ratioBtn.classList.remove('active');

      // éš±è—æ‰€æœ‰è¼¸å…¥æ¬„ä½
      amountSplitGroup.classList.add('hidden');
      ratioSplitGroup.classList.add('hidden');

      // æ ¹æ“šé¸æ“‡é¡¯ç¤ºå°æ‡‰æ¬„ä½
      if (method === 'auto') {
        autoBtn.classList.add('active');
      } else if (method === 'amount') {
        amountBtn.classList.add('active');
        amountSplitGroup.classList.remove('hidden');
      } else if (method === 'ratio') {
        ratioBtn.classList.add('active');
        ratioSplitGroup.classList.remove('hidden');
      }
    }

    function toggleRecurringDay() {
      const isRecurring = document.getElementById('isRecurring').checked;
      const recurringDayGroup = document.getElementById('recurringDayGroup');

      if (isRecurring) {
        recurringDayGroup.classList.remove('hidden');
      } else {
        recurringDayGroup.classList.add('hidden');
        document.getElementById('recurringDay').value = '';
      }
    }

    function showError(error) {
      showToast('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message, 'error');
      console.error(error);
    }

    // åœ–è¡¨åŠŸèƒ½
    // ==================== åœ–è¡¨åŠŸèƒ½å¢å¼· ====================

    let currentChartData = null;

    function showCharts() {
      // æº–å‚™æ•¸æ“šï¼ˆä½¿ç”¨æ‰€æœ‰è¨˜éŒ„ï¼‰
      currentChartData = prepareChartData(allExpenses || []);

      // æ‰“é–‹ Modal
      document.getElementById('chartModal').classList.remove('hidden');

      // ç¹ªè£½é»˜èªæ¨™ç±¤é çš„åœ–è¡¨
      switchChartTab(1);
    }

    function prepareChartData(expenses) {
      const categoryStats = {};
      const payerStats = { 'ä½ ': 0, 'å°æ–¹': 0 };
      const monthlyStats = {};
      const dailyStats = {};

      expenses.forEach(function(exp) {
        const amount = Number(exp.amount);

        // åˆ†é¡çµ±è¨ˆ
        if (!categoryStats[exp.category]) {
          categoryStats[exp.category] = 0;
        }
        categoryStats[exp.category] += amount;

        // ä»˜æ¬¾äººçµ±è¨ˆï¼ˆåˆä½µå…©äººåˆ°å„è‡ªï¼‰
        if (exp.payer === 'ä½ ') {
          payerStats['ä½ '] += amount;
        } else if (exp.payer === 'å°æ–¹') {
          payerStats['å°æ–¹'] += amount;
        } else if (exp.payer === 'å…©äºº') {
          payerStats['ä½ '] += Number(exp.yourPart || 0);
          payerStats['å°æ–¹'] += Number(exp.partnerPart || 0);
        }

        // æœˆåº¦çµ±è¨ˆ
        const expDate = new Date(exp.date);
        const monthKey = expDate.getFullYear() + '-' + String(expDate.getMonth() + 1).padStart(2, '0');
        if (!monthlyStats[monthKey]) {
          monthlyStats[monthKey] = 0;
        }
        monthlyStats[monthKey] += amount;

        // æ¯æ—¥çµ±è¨ˆï¼ˆæœ€è¿‘ 30 å¤©ï¼‰
        const dayKey = exp.date;
        if (!dailyStats[dayKey]) {
          dailyStats[dayKey] = 0;
        }
        dailyStats[dayKey] += amount;
      });

      return {
        categoryStats: categoryStats,
        payerStats: payerStats,
        monthlyStats: monthlyStats,
        dailyStats: dailyStats
      };
    }

    function switchChartTab(tabNum) {
      // æ›´æ–°æ¨™ç±¤æ¨£å¼
      for (let i = 1; i <= 3; i++) {
        const tab = document.getElementById('chartTab' + i);
        const content = document.getElementById('chartTabContent' + i);
        if (i === tabNum) {
          tab.classList.add('active');
          content.classList.remove('hidden');
        } else {
          tab.classList.remove('active');
          content.classList.add('hidden');
        }
      }

      // ç¹ªè£½å°æ‡‰çš„åœ–è¡¨
      if (!currentChartData) return;

      if (tabNum === 1) {
        drawCategoryCharts(currentChartData.categoryStats);
      } else if (tabNum === 2) {
        drawTrendCharts(currentChartData.dailyStats, currentChartData.monthlyStats);
      } else if (tabNum === 3) {
        drawPayerCharts(currentChartData.payerStats);
      }
    }

    function drawCategoryCharts(categoryStats) {
      google.charts.setOnLoadCallback(function() {
        // åœ“é¤…åœ–
        const pieData = new google.visualization.DataTable();
        pieData.addColumn('string', 'åˆ†é¡');
        pieData.addColumn('number', 'é‡‘é¡');

        const categoryIcons = {
          'é£²é£Ÿ': 'ğŸœ',
          'å±…ä½': 'ğŸ ',
          'äº¤é€š': 'ğŸš—',
          'å¨›æ¨‚': 'ğŸ®',
          'æœé£¾': 'ğŸ‘”',
          'å…¶ä»–': 'ğŸ“¦'
        };

        for (const [category, amount] of Object.entries(categoryStats)) {
          const icon = categoryIcons[category] || 'ğŸ“¦';
          pieData.addRow([icon + ' ' + category, amount]);
        }

        const pieOptions = {
          title: 'æ”¯å‡ºåˆ†é¡ä½”æ¯”',
          pieHole: 0.4,
          colors: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'],
          chartArea: { width: '90%', height: '80%' },
          legend: { position: 'right', textStyle: { fontSize: 13 } },
          pieSliceText: 'percentage',
          tooltip: { text: 'both' }
        };

        const pieChart = new google.visualization.PieChart(document.getElementById('categoryPieChart'));
        pieChart.draw(pieData, pieOptions);

        // é•·æ¢åœ–ï¼ˆä½¿ç”¨å‚³çµ±æ¨£å¼ï¼‰
        const maxAmount = Math.max(...Object.values(categoryStats));
        let barHTML = '<div class="chart-container">';
        barHTML += '<h3 style="margin-bottom: 20px;">ğŸ“Š åˆ†é¡è©³ç´°é‡‘é¡</h3>';

        for (const [category, amount] of Object.entries(categoryStats)) {
          const percentage = (amount / maxAmount) * 100;
          const icon = categoryIcons[category] || 'ğŸ“¦';
          barHTML += '<div class="chart-bar">' +
            '<div class="chart-label">' + icon + ' ' + category + '</div>' +
            '<div class="chart-bar-bg">' +
              '<div class="chart-bar-fill" style="width: ' + percentage + '%">$' + amount.toLocaleString() + '</div>' +
            '</div>' +
          '</div>';
        }
        barHTML += '</div>';
        document.getElementById('categoryBarChart').innerHTML = barHTML;
      });
    }

    function drawTrendCharts(dailyStats, monthlyStats) {
      google.charts.setOnLoadCallback(function() {
        // æ¯æ—¥è¶¨å‹¢ç·šåœ–ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰
        const lineData = new google.visualization.DataTable();
        lineData.addColumn('string', 'æ—¥æœŸ');
        lineData.addColumn('number', 'æ”¯å‡º');

        const sortedDays = Object.keys(dailyStats).sort().slice(-30);
        sortedDays.forEach(function(day) {
          const shortDate = day.substring(5); // MM-DD
          lineData.addRow([shortDate, dailyStats[day]]);
        });

        const lineOptions = {
          title: 'æ¯æ—¥æ”¯å‡ºè¶¨å‹¢ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰',
          curveType: 'function',
          colors: ['#667eea'],
          chartArea: { width: '85%', height: '70%' },
          legend: { position: 'none' },
          hAxis: {
            title: 'æ—¥æœŸ',
            slantedText: true,
            slantedTextAngle: 45
          },
          vAxis: {
            title: 'é‡‘é¡ (NT$)',
            format: '$#,###'
          }
        };

        const lineChart = new google.visualization.LineChart(document.getElementById('trendLineChart'));
        lineChart.draw(lineData, lineOptions);

        // æœˆåº¦æŸ±ç‹€åœ–
        const barData = new google.visualization.DataTable();
        barData.addColumn('string', 'æœˆä»½');
        barData.addColumn('number', 'æ”¯å‡º');

        const sortedMonths = Object.keys(monthlyStats).sort().slice(-6);
        sortedMonths.forEach(function(month) {
          const monthLabel = month.substring(5) + 'æœˆ'; // MMæœˆ
          barData.addRow([monthLabel, monthlyStats[month]]);
        });

        const barOptions = {
          title: 'æœˆåº¦æ”¯å‡ºæ¯”è¼ƒï¼ˆæœ€è¿‘ 6 å€‹æœˆï¼‰',
          colors: ['#764ba2'],
          chartArea: { width: '80%', height: '70%' },
          legend: { position: 'none' },
          hAxis: { title: 'æœˆä»½' },
          vAxis: {
            title: 'é‡‘é¡ (NT$)',
            format: '$#,###'
          },
          bar: { groupWidth: '70%' }
        };

        const barChart = new google.visualization.ColumnChart(document.getElementById('monthlyBarChart'));
        barChart.draw(barData, barOptions);
      });
    }

    function drawPayerCharts(payerStats) {
      google.charts.setOnLoadCallback(function() {
        // åœ“é¤…åœ–
        const pieData = new google.visualization.DataTable();
        pieData.addColumn('string', 'ä»˜æ¬¾äºº');
        pieData.addColumn('number', 'é‡‘é¡');

        for (const [payer, amount] of Object.entries(payerStats)) {
          if (amount > 0) {
            pieData.addRow([payer, amount]);
          }
        }

        const pieOptions = {
          title: 'ä»˜æ¬¾äººä½”æ¯”',
          pieHole: 0.4,
          colors: ['#667eea', '#764ba2'],
          chartArea: { width: '90%', height: '80%' },
          legend: { position: 'right', textStyle: { fontSize: 14 } },
          pieSliceText: 'percentage',
          tooltip: { text: 'both' }
        };

        const pieChart = new google.visualization.PieChart(document.getElementById('payerPieChart'));
        pieChart.draw(pieData, pieOptions);

        // é•·æ¢åœ–
        const maxPayer = Math.max(...Object.values(payerStats));
        let barHTML = '<div class="chart-container">';
        barHTML += '<h3 style="margin-bottom: 20px;">ğŸ‘¥ ä»˜æ¬¾è©³ç´°é‡‘é¡</h3>';

        for (const [payer, amount] of Object.entries(payerStats)) {
          if (amount === 0) continue;
          const percentage = (amount / maxPayer) * 100;
          barHTML += '<div class="chart-bar">' +
            '<div class="chart-label">' + payer + '</div>' +
            '<div class="chart-bar-bg">' +
              '<div class="chart-bar-fill" style="width: ' + percentage + '%">$' + amount.toLocaleString() + '</div>' +
            '</div>' +
          '</div>';
        }
        barHTML += '</div>';
        document.getElementById('payerBarChart').innerHTML = barHTML;
      });
    }

    function closeChartModal() {
      document.getElementById('chartModal').classList.add('hidden');
    }

    // ==================== æˆå“¡ç®¡ç†åŠŸèƒ½ ====================

    // é–‹å•Ÿæˆå“¡ç®¡ç† Modal
    function openMembersModal() {
      document.getElementById('membersModal').classList.remove('hidden');
      loadMembers();
    }

    // é—œé–‰æˆå“¡ç®¡ç† Modal
    function closeMembersModal() {
      const modal = document.getElementById('membersModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // è¼‰å…¥æˆå“¡åˆ—è¡¨
    function loadMembers() {
      document.getElementById('membersList').innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">è¼‰å…¥ä¸­...</div>';

      google.script.run
        .withSuccessHandler(function(members) {
          displayMembers(members);
        })
        .withFailureHandler(function(error) {
          showToast('è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—ï¼š' + error.message, 'error');
          document.getElementById('membersList').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">è¼‰å…¥å¤±æ•—</div>';
        })
        .getMembers();
    }

    // é¡¯ç¤ºæˆå“¡åˆ—è¡¨
    function displayMembers(members) {
      const membersListEl = document.getElementById('membersList');

      if (members.length === 0) {
        membersListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ç›®å‰æ²’æœ‰æˆå“¡</div>';
        return;
      }

      const html = members.map(function(member) {
        const ownerClass = member.isOwner ? 'owner' : '';
        const ownerBadge = member.isOwner ? '<span class="member-badge">ç®¡ç†å“¡</span>' : '';
        const removeBtn = !member.isOwner ? '<button class="remove-member-btn" onclick="removeMemberAction(\'' + escapeHtml(member.email) + '\')">ç§»é™¤</button>' : '';

        // ä½¿ç”¨å®‰å…¨çš„ HTML è½‰ç¾©
        const safeName = escapeHtml(member.name);
        const safeEmail = escapeHtml(member.email);

        return '<div class="member-card ' + ownerClass + '">' +
          '<div class="member-info">' +
            '<div>' +
              '<div style="font-weight: 600; color: #333;">' + safeName + '</div>' +
              '<div style="font-size: 0.85em; color: #999;">' + safeEmail + '</div>' +
            '</div>' +
            ownerBadge +
          '</div>' +
          removeBtn +
        '</div>';
      }).join('');

      membersListEl.innerHTML = html;
    }

    // é‚€è«‹æˆå“¡
    function inviteMemberAction() {
      const emailInput = document.getElementById('inviteEmail');
      const email = emailInput.value.trim();

      // å‰ç«¯é©—è­‰
      if (!validateInput(email, 'email')) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€', 'error');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          showToast(result.message, 'success');
          emailInput.value = '';
          loadMembers();
        })
        .withFailureHandler(function(error) {
          showToast('é‚€è«‹å¤±æ•—ï¼š' + error.message, 'error');
        })
        .inviteMember(email);
    }

    // ç§»é™¤æˆå“¡
    function removeMemberAction(email) {
      if (!confirm('ç¢ºå®šè¦ç§»é™¤ ' + email + ' å—ï¼Ÿ')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          showToast(result.message, 'success');
          loadMembers();
        })
        .withFailureHandler(function(error) {
          showToast('ç§»é™¤å¤±æ•—ï¼š' + error.message, 'error');
        })
        .removeMember(email);
    }

    // éµç›¤å¿«æ·éµå’Œäº‹ä»¶ç›£è½
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('item').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('amount').focus();
        }
      });

      document.getElementById('amount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          addExpense();
        }
      });

      // Modal é»æ“Šå¤–éƒ¨é—œé–‰
      document.getElementById('chartModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeChartModal();
        }
      });

      document.getElementById('membersModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeMembersModal();
        }
      });

      // æˆå“¡ç®¡ç† Modal é—œé–‰æŒ‰éˆ•
      const closeMembersBtn = document.getElementById('closeMembersBtn');
      if (closeMembersBtn) {
        closeMembersBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          closeMembersModal();
        });
      }

      // ESC éµé—œé–‰æ‰€æœ‰ Modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeChartModal();
          closeMembersModal();
        }
      });

      // Enter éµç™¼é€é‚€è«‹
      document.getElementById('inviteEmail').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          inviteMemberAction();
        }
      });
    });

    // ==================== çµç®—åŠŸèƒ½ ====================

    function openSettlementModal() {
      // è¨­å®šä»Šå¤©ç‚ºé è¨­æ—¥æœŸ
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('settlementDate').value = today;

      document.getElementById('settlementModal').classList.remove('hidden');
    }

    function closeSettlementModal() {
      document.getElementById('settlementModal').classList.add('hidden');

      // æ¸…ç©ºè¡¨å–®
      document.getElementById('settlementDirection').value = 'partner_pay_me';
      document.getElementById('settlementAmount').value = '';
      document.getElementById('settlementDate').value = '';
      document.getElementById('settlementNote').value = '';
    }

    function addSettlementRecord() {
      const direction = document.getElementById('settlementDirection').value;
      const amount = parseFloat(document.getElementById('settlementAmount').value);
      const date = document.getElementById('settlementDate').value;
      const note = document.getElementById('settlementNote').value.trim();

      // é©—è­‰
      if (!amount || amount <= 0) {
        showNotification('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡', 'error');
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      const button = event.target;
      button.disabled = true;
      button.textContent = 'è™•ç†ä¸­...';

      google.script.run
        .withSuccessHandler(function(result) {
          showNotification('çµç®—è¨˜éŒ„å·²æ–°å¢ï¼', 'success');
          closeSettlementModal();
          loadData();  // é‡æ–°è¼‰å…¥è³‡æ–™
          button.disabled = false;
          button.textContent = 'ç¢ºèªè¨˜éŒ„';
        })
        .withFailureHandler(function(error) {
          showNotification('æ–°å¢å¤±æ•—ï¼š' + error.message, 'error');
          button.disabled = false;
          button.textContent = 'ç¢ºèªè¨˜éŒ„';
        })
        .addSettlement(direction, amount, date, note);
    }

    // Modal é»æ“Šå¤–éƒ¨é—œé–‰ - çµç®—
    document.getElementById('settlementModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeSettlementModal();
      }
    });

    window.onload = function() {
      loadAppSettings();  // å…ˆè¼‰å…¥è¨­å®šï¼ˆé…è‰²å’Œæ¨¡å¼ï¼‰
      loadData();
      loadUserInfo();
      loadQuickExpenseButtons();
    };
  </script>
</body>
</html>
