<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å…±åŒè¨˜å¸³</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    google.charts.load('current', {'packages':['corechart', 'line']});
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1 {
      color: #667eea;
      text-align: center;
      margin-bottom: 10px;
      font-size: 2em;
    }

    .subtitle {
      text-align: center;
      color: #999;
      font-size: 0.9em;
      margin-bottom: 30px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    .stat-card.you {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    }

    .stat-card.partner {
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
    }

    .stat-card.balance {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    }

    .stat-icon {
      font-size: 2em;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 1.6em;
      font-weight: bold;
      color: #333;
    }

    @media (max-width: 600px) {
      .stat-value {
        font-size: 1.4em;
      }
    }

    .form-section {
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }

    .form-section:focus-within {
      border-color: #667eea;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #374151;
      font-weight: 500;
      font-size: 0.9em;
    }

    input, select {
      width: 100%;
      padding: 12px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    input::placeholder {
      color: #9ca3af;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-loading {
      position: relative;
      color: transparent;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin-left: -10px;
      margin-top: -10px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .expenses-list {
      margin-top: 20px;
    }

    .expense-item {
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      animation: fadeIn 0.5s ease-out;
      border: 2px solid transparent;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .expense-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .expense-item.you {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-left: 4px solid #3b82f6;
    }

    .expense-item.partner {
      background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
      border-left: 4px solid #ec4899;
    }

    .expense-item.both {
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      border-left: 4px solid #a855f7;
    }

    .expense-info {
      flex: 1;
    }

    .expense-amount {
      font-size: 1.5em;
      font-weight: bold;
      color: #333;
      white-space: nowrap;
      margin-left: 15px;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 4em;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 12px;
      z-index: 10000;
      animation: slideInRight 0.3s ease-out;
      max-width: 300px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast.success {
      border-left: 4px solid #10b981;
    }

    .toast.error {
      border-left: 4px solid #ef4444;
    }

    .toast-icon {
      font-size: 1.5em;
    }

    .toast-message {
      flex: 1;
      color: #333;
      font-weight: 500;
    }

    .hidden {
      display: none !important;
    }

    h2 {
      color: #374151;
      font-size: 1.3em;
      margin-bottom: 15px;
    }

    .filter-section {
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease-out;
    }

    .modal.hidden {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 900px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideIn 0.3s ease-out;
    }

    .chart-container {
      margin: 20px 0;
    }

    .chart-tab {
      padding: 10px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.95em;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .chart-tab:hover {
      color: #667eea;
    }

    .chart-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }

    .chart-tab-content {
      animation: fadeIn 0.3s ease-in;
    }

    .chart-tab-content.hidden {
      display: none;
    }

    .chart-bar {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .chart-label {
      width: 100px;
      font-size: 0.9em;
      color: #666;
    }

    .chart-bar-bg {
      flex: 1;
      height: 30px;
      background: #e5e7eb;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .chart-bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: width 0.5s ease-out;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: white;
      font-weight: bold;
      font-size: 0.85em;
    }

    .delete-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .delete-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #667eea;
      object-fit: cover;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .user-name {
      font-size: 0.9em;
      color: #667eea;
      font-weight: 600;
    }

    .user-email {
      font-size: 0.75em;
      color: #999;
    }

    .logout-btn {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .members-btn {
      padding: 6px 12px;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .members-btn:hover {
      background: #059669;
      transform: scale(1.05);
    }

    .member-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      transition: all 0.3s ease;
    }

    .member-card:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }

    .member-card.owner {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border-color: #3b82f6;
    }

    .member-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .member-badge {
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75em;
      font-weight: 600;
    }

    .remove-member-btn {
      padding: 6px 12px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .remove-member-btn:hover {
      background: #dc2626;
    }

    .quick-btn {
      padding: 8px 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.85em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .quick-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .quick-btn:active {
      transform: translateY(0);
    }

    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .dashboard-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .dashboard-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .dashboard-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f3f4f6;
    }

    .dashboard-icon {
      font-size: 1.3em;
    }

    .dashboard-title {
      font-weight: 600;
      color: #374151;
      font-size: 1em;
    }

    .dashboard-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .dashboard-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dashboard-label {
      font-size: 0.9em;
      color: #6b7280;
    }

    .dashboard-value {
      font-size: 1.1em;
      font-weight: 600;
      color: #667eea;
    }

    .trend-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.85em;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
    }

    .trend-up {
      background: #fee2e2;
      color: #dc2626;
    }

    .trend-down {
      background: #dcfce7;
      color: #16a34a;
    }

    .trend-neutral {
      background: #e5e7eb;
      color: #6b7280;
    }

    /* ==================== éŸ¿æ‡‰å¼è¨­è¨ˆ (RWD) ==================== */

    /* å¤§è¢å¹• (æ¡Œæ©Ÿ) - 1200px ä»¥ä¸Š */
    @media (min-width: 1200px) {
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .stats {
        grid-template-columns: repeat(3, 1fr);
      }

      .dashboard {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* ä¸­ç­‰è¢å¹• (å¹³æ¿æ©«å‘) - 768px åˆ° 1199px */
    @media (min-width: 768px) and (max-width: 1199px) {
      .container {
        padding: 30px;
      }

      .stats {
        grid-template-columns: repeat(3, 1fr);
      }

      .dashboard {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-section {
        padding: 25px;
      }
    }

    /* å°è¢å¹• (å¹³æ¿ç›´å‘) - 600px åˆ° 767px */
    @media (min-width: 600px) and (max-width: 767px) {
      .container {
        padding: 25px;
      }

      h1 {
        font-size: 1.8em;
      }

      .stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .stat-card:last-child {
        grid-column: 1 / -1;
      }

      .dashboard {
        grid-template-columns: 1fr;
      }

      .quick-btn {
        flex: 1 1 calc(33.333% - 8px);
        min-width: 100px;
      }
    }

    /* æ‰‹æ©Ÿ - 600px ä»¥ä¸‹ */
    @media (max-width: 599px) {
      .container {
        padding: 15px;
      }

      h1 {
        font-size: 1.3em;
      }

      h2 {
        font-size: 1.1em;
      }

      .subtitle {
        font-size: 0.85em;
      }

      /* çµ±è¨ˆå¡ç‰‡ - å‚ç›´æ’åˆ— */
      .stats {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 15px;
      }

      .stat-value {
        font-size: 1.5em;
      }

      /* å„€è¡¨æ¿ - å‚ç›´æ’åˆ— */
      .dashboard {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .dashboard-card {
        padding: 15px;
      }

      /* è¡¨å–® */
      .form-section {
        padding: 20px;
      }

      .form-group label {
        font-size: 0.9em;
      }

      .form-group input,
      .form-group select {
        font-size: 0.95em;
      }

      /* å¿«é€Ÿè¨˜å¸³æŒ‰éˆ• - æ¯è¡Œ 2 å€‹ */
      .quick-btn {
        flex: 1 1 calc(50% - 4px);
        min-width: 0;
        font-size: 0.85em;
        padding: 10px;
      }

      /* æ”¯å‡ºè¨˜éŒ„ */
      .expense-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .expense-item > div:last-child {
        width: 100%;
        justify-content: space-between;
      }

      .expense-amount {
        font-size: 1.1em;
      }

      .delete-btn {
        padding: 6px 12px;
        font-size: 0.85em;
      }

      /* Toast é€šçŸ¥ */
      .toast {
        left: 15px;
        right: 15px;
        max-width: none;
        font-size: 0.9em;
      }

      /* ä½¿ç”¨è€…è³‡è¨Š */
      .user-name {
        display: none;
      }

      .user-email {
        font-size: 0.75em;
      }

      .user-avatar {
        width: 32px;
        height: 32px;
      }

      /* Modal */
      .modal-content {
        width: 95%;
        max-width: none;
        padding: 20px;
      }

      /* æŒ‰éˆ• */
      .btn {
        font-size: 0.95em;
      }

      .members-btn,
      .logout-btn {
        padding: 8px 12px;
        font-size: 0.85em;
      }
    }

    /* æ¥µå°è¢å¹• - 400px ä»¥ä¸‹ */
    @media (max-width: 400px) {
      .container {
        padding: 10px;
      }

      h1 {
        font-size: 1.2em;
      }

      .quick-btn {
        font-size: 0.8em;
        padding: 8px;
      }

      .stat-icon {
        font-size: 1.5em;
      }

      .stat-label {
        font-size: 0.8em;
      }

      .stat-value {
        font-size: 1.3em;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <h1 style="margin: 0;">ğŸ’‘ å…±åŒè¨˜å¸³</h1>
      <div id="userInfo" style="display: flex; align-items: center; gap: 12px;">
        <div style="font-size: 0.9em; color: #999;">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
    <div class="subtitle">è®“éŒ¢çš„äº‹è®Šç°¡å–®</div>

    <!-- æ–°å¢æ”¯å‡ºè¡¨å–® - ç§»åˆ°æœ€ä¸Šæ–¹æ–¹ä¾¿å¿«é€Ÿè¨˜å¸³ -->
    <div class="form-section">
      <h2 style="margin-bottom: 15px;">ğŸ’° æ–°å¢æ”¯å‡º</h2>

      <!-- å¿«é€Ÿè¨˜è´¦æŒ‰é’® -->
      <div style="margin-bottom: 20px;">
        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px; font-weight: 500;">âš¡ å¿«é€Ÿè¨˜å¸³</div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          <button class="quick-btn" onclick="quickExpense('æ—©é¤', 50, 'é£²é£Ÿ')">ğŸ³ æ—©é¤ $50</button>
          <button class="quick-btn" onclick="quickExpense('åˆé¤', 100, 'é£²é£Ÿ')">ğŸ± åˆé¤ $100</button>
          <button class="quick-btn" onclick="quickExpense('æ™šé¤', 150, 'é£²é£Ÿ')">ğŸ½ï¸ æ™šé¤ $150</button>
          <button class="quick-btn" onclick="quickExpense('å’–å•¡', 60, 'é£²é£Ÿ')">â˜• å’–å•¡ $60</button>
          <button class="quick-btn" onclick="quickExpense('äº¤é€š', 20, 'äº¤é€š')">ğŸš‡ äº¤é€š $20</button>
          <button class="quick-btn" onclick="quickExpense('åœè»Š', 50, 'äº¤é€š')">ğŸ…¿ï¸ åœè»Š $50</button>
          <button class="quick-btn" onclick="quickExpense('é»å¿ƒ', 80, 'é£²é£Ÿ')">ğŸ° é»å¿ƒ $80</button>
          <button class="quick-btn" onclick="quickExpense('é£²æ–™', 50, 'é£²é£Ÿ')">ğŸ§‹ é£²æ–™ $50</button>
        </div>
      </div>

      <div class="form-group">
        <label>é …ç›®</label>
        <input type="text" id="item" placeholder="ä¾‹å¦‚ï¼šè²·èœã€å¤–é£Ÿ">
      </div>

      <div class="form-group">
        <label>é‡‘é¡</label>
        <input type="number" id="amount" placeholder="0">
      </div>

      <div class="form-group">
        <label>ä»˜æ¬¾æ–¹å¼</label>
        <select id="splitType" onchange="updatePayerOptions()">
          <option value="single">å–®äººä»˜æ¬¾</option>
          <option value="equal">å¹³åˆ†</option>
          <option value="custom">è‡ªè¨‚åˆ†å¸³</option>
        </select>
      </div>

      <div class="form-group" id="payerGroup">
        <label>èª°ä»˜çš„</label>
        <select id="payer">
          <option value="ä½ ">ä½ </option>
          <option value="å°æ–¹">å°æ–¹</option>
        </select>
      </div>

      <div class="form-group hidden" id="customSplit">
        <label>è‡ªè¨‚åˆ†å¸³é‡‘é¡</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div>
            <input type="number" id="yourPart" placeholder="ä½ çš„éƒ¨åˆ†">
          </div>
          <div>
            <input type="number" id="partnerPart" placeholder="å°æ–¹çš„éƒ¨åˆ†">
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>åˆ†é¡</label>
        <select id="category">
          <option value="é£²é£Ÿ">ğŸœ é£²é£Ÿ</option>
          <option value="å±…ä½">ğŸ  å±…ä½</option>
          <option value="äº¤é€š">ğŸš— äº¤é€š</option>
          <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
          <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
        </select>
      </div>

      <button class="btn btn-primary" onclick="addExpense()">æ–°å¢æ”¯å‡º</button>
    </div>

    <div class="stats" id="stats">
      <div class="stat-card you">
        <div class="stat-icon">ğŸ‘¤</div>
        <div class="stat-label">ä½ ä»˜äº†</div>
        <div class="stat-value" id="yourTotal">$0</div>
      </div>
      <div class="stat-card partner">
        <div class="stat-icon">ğŸ‘¤</div>
        <div class="stat-label">å°æ–¹ä»˜äº†</div>
        <div class="stat-value" id="partnerTotal">$0</div>
      </div>
      <div class="stat-card balance">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-label">çµç®—</div>
        <div class="stat-value" id="balance">å·²çµæ¸…</div>
      </div>
    </div>

    <!-- ä»ªè¡¨æ¿ -->
    <div style="margin-bottom: 10px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h2 style="margin: 0; font-size: 1.1em; color: #374151;">ğŸ“Š æ•¸æ“šåˆ†æ</h2>
        <select id="dashboardPeriod" onchange="changeDashboardPeriod()" style="padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.9em; cursor: pointer; background: white; color: #374151; font-weight: 500;">
          <option value="currentMonth">æœ¬æœˆ</option>
          <option value="lastMonth">ä¸Šæœˆ</option>
          <option value="last7days">æœ€è¿‘ 7 å¤©</option>
          <option value="last30days">æœ€è¿‘ 30 å¤©</option>
          <option value="comparison">æœ¬æœˆ vs ä¸Šæœˆ</option>
        </select>
      </div>
    </div>

    <div class="dashboard">
      <div class="dashboard-card">
        <div class="dashboard-header">
          <span class="dashboard-icon" id="dashboardIcon1">ğŸ“…</span>
          <span class="dashboard-title" id="dashboardTitle1">æœ¬æœˆæ¦‚æ³</span>
        </div>
        <div class="dashboard-content">
          <div class="dashboard-row">
            <span class="dashboard-label" id="label1">ç¸½æ”¯å‡º</span>
            <span class="dashboard-value" id="value1">$0</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label" id="label2">è¨˜éŒ„æ•¸</span>
            <span class="dashboard-value" id="value2">0 ç­†</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label" id="label3">æ—¥å‡æ”¯å‡º</span>
            <span class="dashboard-value" id="value3">$0</span>
          </div>
        </div>
      </div>

      <div class="dashboard-card">
        <div class="dashboard-header">
          <span class="dashboard-icon">ğŸ†</span>
          <span class="dashboard-title" id="dashboardTitle2">æ’è¡Œæ¦œ</span>
        </div>
        <div class="dashboard-content">
          <div class="dashboard-row">
            <span class="dashboard-label">æœ€å¤šæ”¯å‡º</span>
            <span class="dashboard-value" id="topCategory">é£²é£Ÿ</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label">æœ€å¤§å–®ç­†</span>
            <span class="dashboard-value" id="maxExpense">$0</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label">æœ€å¸¸è¨˜å¸³</span>
            <span class="dashboard-value" id="topPayer">ä½ </span>
          </div>
        </div>
      </div>

      <div class="dashboard-card" id="comparisonCard">
        <div class="dashboard-header">
          <span class="dashboard-icon">ğŸ“ˆ</span>
          <span class="dashboard-title" id="dashboardTitle3">è¶¨å‹¢</span>
        </div>
        <div class="dashboard-content" id="dashboardContent3">
          <div class="dashboard-row">
            <span class="dashboard-label" id="label4">ç¸½æ”¯å‡º</span>
            <span class="dashboard-value" id="value4">$0</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label" id="label5">æ—¥å‡æ”¯å‡º</span>
            <span class="dashboard-value" id="value5">$0</span>
          </div>
          <div class="dashboard-row">
            <span class="dashboard-label" id="label6">è¨˜å¸³æ¬¡æ•¸</span>
            <span class="dashboard-value" id="value6">0 ç­†</span>
          </div>
        </div>
      </div>
    </div>

    <div class="filter-section">
      <h2 style="margin-bottom: 15px;">ğŸ“‹ æ”¯å‡ºè¨˜éŒ„</h2>

      <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹é …ç›®..." style="width: 100%;">
        </div>
        <div style="flex: 1; min-width: 150px;">
          <select id="filterCategory" style="width: 100%;">
            <option value="">å…¨éƒ¨åˆ†é¡</option>
            <option value="é£²é£Ÿ">ğŸœ é£²é£Ÿ</option>
            <option value="å±…ä½">ğŸ  å±…ä½</option>
            <option value="äº¤é€š">ğŸš— äº¤é€š</option>
            <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
            <option value="å…¶ä»–">ğŸ“¦ å…¶ä»–</option>
          </select>
        </div>
        <div style="flex: 1; min-width: 150px;">
          <select id="filterPayer" style="width: 100%;">
            <option value="">å…¨éƒ¨ä»˜æ¬¾äºº</option>
            <option value="ä½ ">ä½ ä»˜çš„</option>
            <option value="å°æ–¹">å°æ–¹ä»˜çš„</option>
            <option value="å…©äºº">å…±åŒä»˜çš„</option>
          </select>
        </div>
      </div>

      <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
        <label style="margin: 0; white-space: nowrap;">æ—¥æœŸç¯„åœï¼š</label>
        <input type="date" id="startDate" style="flex: 1;">
        <span>ï½</span>
        <input type="date" id="endDate" style="flex: 1;">
        <button onclick="applyFilters()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">ç¯©é¸</button>
        <button onclick="clearFilters()" style="padding: 10px 20px; background: #e5e7eb; color: #333; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap;">æ¸…é™¤</button>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span style="color: #999; font-size: 0.9em;" id="recordCount">å…± 0 ç­†è¨˜éŒ„</span>
        <div style="display: flex; gap: 8px;">
          <button onclick="showCharts()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">ğŸ“Š åœ–è¡¨</button>
          <button onclick="exportData()" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9em;">ğŸ’¾ åŒ¯å‡º</button>
        </div>
      </div>
    </div>

    <div class="expenses-list">
      <div id="expensesList" class="loading">è¼‰å…¥ä¸­...</div>
    </div>

    <!-- åœ–è¡¨ Modal -->
    <div id="chartModal" class="modal hidden">
      <div class="modal-content" style="max-width: 900px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">ğŸ“Š æ”¯å‡ºåˆ†æ</h2>
          <button onclick="closeChartModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">Ã—</button>
        </div>

        <!-- åœ–è¡¨æ¨™ç±¤åˆ‡æ› -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0;">
          <button id="chartTab1" class="chart-tab active" onclick="switchChartTab(1)">ğŸ“Š åˆ†é¡åˆ†æ</button>
          <button id="chartTab2" class="chart-tab" onclick="switchChartTab(2)">ğŸ“ˆ è¶¨å‹¢åœ–è¡¨</button>
          <button id="chartTab3" class="chart-tab" onclick="switchChartTab(3)">ğŸ‘¥ ä»˜æ¬¾åˆ†æ</button>
        </div>

        <!-- åœ–è¡¨å…§å®¹å®¹å™¨ -->
        <div id="chartTabContent1" class="chart-tab-content">
          <div id="categoryPieChart" style="width: 100%; height: 400px;"></div>
          <div id="categoryBarChart" style="margin-top: 20px;"></div>
        </div>

        <div id="chartTabContent2" class="chart-tab-content hidden">
          <div id="trendLineChart" style="width: 100%; height: 400px;"></div>
          <div id="monthlyBarChart" style="width: 100%; height: 300px; margin-top: 20px;"></div>
        </div>

        <div id="chartTabContent3" class="chart-tab-content hidden">
          <div id="payerPieChart" style="width: 100%; height: 400px;"></div>
          <div id="payerBarChart" style="margin-top: 20px;"></div>
        </div>
      </div>
    </div>

    <!-- æˆå“¡ç®¡ç† Modal -->
    <div id="membersModal" class="modal hidden">
      <div class="modal-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2 style="margin: 0;">ğŸ‘¥ æˆå“¡ç®¡ç†</h2>
          <button id="closeMembersBtn" class="close-modal-btn" onclick="closeMembersModal(); return false;" style="background: none; border: none; font-size: 1.8em; cursor: pointer; color: #999; padding: 5px 10px; line-height: 1; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#999'">Ã—</button>
        </div>

        <!-- é‚€è«‹æ–°æˆå“¡ -->
        <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <h3 style="margin-bottom: 15px; color: #667eea;">âœ‰ï¸ é‚€è«‹æ–°æˆå“¡</h3>
          <div style="display: flex; gap: 10px;">
            <input type="email" id="inviteEmail" placeholder="è¼¸å…¥ Email åœ°å€" style="flex: 1; padding: 12px; border: 2px solid #d1d5db; border-radius: 8px;">
            <button onclick="inviteMemberAction()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; font-weight: 600;">ç™¼é€é‚€è«‹</button>
          </div>
          <p style="font-size: 0.85em; color: #999; margin-top: 10px;">
            ğŸ’¡ å—é‚€è€…å°‡æ”¶åˆ°é‚€è«‹éƒµä»¶ï¼Œä¸¦å¯ä½¿ç”¨è©² Email ç™»å…¥ç³»çµ±
          </p>
        </div>

        <!-- æˆå“¡åˆ—è¡¨ -->
        <div>
          <h3 style="margin-bottom: 15px; color: #667eea;">ğŸ“‹ ç›®å‰æˆå“¡</h3>
          <div id="membersList" style="display: flex; flex-direction: column; gap: 10px;">
            <div style="text-align: center; padding: 20px; color: #999;">è¼‰å…¥ä¸­...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€è®Šæ•¸
    let allExpenses = [];
    let filteredExpenses = [];

    // ==================== å®‰å…¨æ€§å‡½æ•¸ ====================

    /**
     * HTML è½‰ç¾©é˜²æ­¢ XSS
     */
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /**
     * é©—è­‰è¼¸å…¥
     */
    function validateInput(value, type, min, max) {
      if (type === 'text') {
        return value && value.trim().length > 0 && value.length <= (max || 100);
      }
      if (type === 'number') {
        const num = parseFloat(value);
        return !isNaN(num) && num >= (min || 0) && num <= (max || 9999999);
      }
      if (type === 'email') {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value);
      }
      return false;
    }

    /**
     * é©—è­‰åœ–ç‰‡ URLï¼ˆé˜²æ­¢ javascript: å”è­°ï¼‰
     */
    function validateImageUrl(url) {
      if (!url) return '';
      // åªå…è¨± http å’Œ https å”è­°
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return escapeHtml(url);
      }
      // æ‹’çµ• javascript:, data: ç­‰å±éšªå”è­°
      return '';
    }

    // Toast é€šçŸ¥ç³»çµ±
    function showToast(message, type = 'success') {
      const existingToast = document.querySelector('.toast');
      if (existingToast) {
        existingToast.remove();
      }

      const toast = document.createElement('div');
      toast.className = 'toast ' + type;

      const icon = type === 'success' ? 'âœ“' : 'âœ•';
      // ä½¿ç”¨ textContent é˜²æ­¢ XSS
      const iconDiv = document.createElement('div');
      iconDiv.className = 'toast-icon';
      iconDiv.textContent = icon;

      const messageDiv = document.createElement('div');
      messageDiv.className = 'toast-message';
      messageDiv.textContent = message; // å®‰å…¨çš„æ–‡æœ¬æ’å…¥

      toast.appendChild(iconDiv);
      toast.appendChild(messageDiv);

      document.body.appendChild(toast);

      setTimeout(function() {
        toast.style.animation = 'slideInRight 0.3s ease-out reverse';
        setTimeout(function() {
          toast.remove();
        }, 300);
      }, 3000);
    }

    function loadData() {
      google.script.run
        .withSuccessHandler(function(expenses) {
          allExpenses = expenses;
          filteredExpenses = expenses;
          updateUI(expenses);
        })
        .withFailureHandler(showError)
        .getExpenses();
    }

    // è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Š
    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(user) {
          displayUserInfo(user);
        })
        .withFailureHandler(function(error) {
          console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', error);
          document.getElementById('userInfo').innerHTML = '<div style="font-size: 0.9em; color: #999;">æœªç™»å…¥</div>';
        })
        .getCurrentUser();
    }

    // é¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Š
    function displayUserInfo(user) {
      const userInfoEl = document.getElementById('userInfo');

      // å„²å­˜ä½¿ç”¨è€…è³‡è¨Šåˆ°å…¨å±€è®Šæ•¸
      window.currentUser = user;

      // é©—è­‰ä¸¦è½‰ç¾©æ‰€æœ‰ç”¨æˆ¶æ•¸æ“š
      const safePhotoUrl = validateImageUrl(user.photoUrl);
      const safeName = escapeHtml(user.name);
      const safeEmail = escapeHtml(user.email);

      userInfoEl.innerHTML =
        '<img src="' + safePhotoUrl + '" alt="ç”¨æˆ¶é ­åƒ" class="user-avatar" title="' + safeEmail + '">' +
        '<div style="text-align: right;">' +
          '<div class="user-name">' + safeName + '</div>' +
          '<div class="user-email">' + safeEmail + '</div>' +
        '</div>' +
        '<button class="members-btn" onclick="openMembersModal()">æˆå“¡</button>' +
        '<button class="logout-btn" onclick="logout()">ç™»å‡º</button>';
    }

    // ç™»å‡ºåŠŸèƒ½
    function logout() {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        // æ¸…é™¤æœ¬åœ°æ•¸æ“š
        allExpenses = [];
        filteredExpenses = [];
        window.currentUser = null;

        // æ¸…é™¤ç·©å­˜
        if (typeof(Storage) !== "undefined") {
          try {
            sessionStorage.clear();
            localStorage.clear();
          } catch (e) {
            console.log('æ¸…é™¤ç·©å­˜å¤±æ•—:', e);
          }
        }

        // è·³è½‰åˆ° Google ç™»å‡º
        window.location.href = 'https://accounts.google.com/Logout';
      }
    }

    // ç¯©é¸åŠŸèƒ½
    function applyFilters() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const filterCategory = document.getElementById('filterCategory').value;
      const filterPayer = document.getElementById('filterPayer').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;

      filteredExpenses = allExpenses.filter(function(exp) {
        // æœå°‹æ–‡å­—
        if (searchText && !exp.item.toLowerCase().includes(searchText)) {
          return false;
        }

        // åˆ†é¡ç¯©é¸
        if (filterCategory && exp.category !== filterCategory) {
          return false;
        }

        // ä»˜æ¬¾äººç¯©é¸
        if (filterPayer && exp.payer !== filterPayer) {
          return false;
        }

        // æ—¥æœŸç¯©é¸
        if (startDate && exp.date < startDate) {
          return false;
        }
        if (endDate && exp.date > endDate) {
          return false;
        }

        return true;
      });

      updateUI(filteredExpenses);
      showToast('å·²å¥—ç”¨ç¯©é¸æ¢ä»¶', 'success');
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterPayer').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';

      filteredExpenses = allExpenses;
      updateUI(allExpenses);
      showToast('å·²æ¸…é™¤ç¯©é¸', 'success');
    }

    // å³æ™‚æœå°‹
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('searchInput').addEventListener('input', function() {
        applyFilters();
      });
      document.getElementById('filterCategory').addEventListener('change', applyFilters);
      document.getElementById('filterPayer').addEventListener('change', applyFilters);
    });

    function updateUI(expenses) {
      let yourTotal = 0;
      let partnerTotal = 0;

      // è¨ˆç®—ç¸½è¨ˆï¼ˆä½¿ç”¨å…¨éƒ¨è³‡æ–™ï¼‰
      allExpenses.forEach(function(exp) {
        yourTotal += Number(exp.yourPart) || 0;
        partnerTotal += Number(exp.partnerPart) || 0;
      });

      const difference = yourTotal - partnerTotal;

      document.getElementById('yourTotal').textContent = '$' + yourTotal.toLocaleString();
      document.getElementById('partnerTotal').textContent = '$' + partnerTotal.toLocaleString();

      const balanceEl = document.getElementById('balance');
      if (difference === 0) {
        balanceEl.textContent = 'å·²çµæ¸… âœ¨';
      } else if (difference > 0) {
        balanceEl.textContent = 'å°æ–¹æ¬  $' + Math.abs(difference).toLocaleString();
      } else {
        balanceEl.textContent = 'ä½ æ¬  $' + Math.abs(difference).toLocaleString();
      }

      // æ›´æ–°è¨˜éŒ„æ•¸é‡
      document.getElementById('recordCount').textContent = 'å…± ' + expenses.length + ' ç­†è¨˜éŒ„';

      // æ›´æ–°å„€è¡¨æ¿
      updateDashboard(allExpenses);

      const listEl = document.getElementById('expensesList');
      if (expenses.length === 0) {
        listEl.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“</div><p>æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„</p><p style="font-size: 0.9em; margin-top: 8px;">è©¦è©¦èª¿æ•´ç¯©é¸æ¢ä»¶</p></div>';
        return;
      }

      const html = expenses.slice().reverse().map(function(exp) {
        const className = exp.payer === 'ä½ ' ? 'you' : exp.payer === 'å°æ–¹' ? 'partner' : 'both';
        const splitInfo = exp.payer === 'å…©äºº' ? '<br><small>(ä½ : $' + Number(exp.yourPart).toLocaleString() + ' / å°æ–¹: $' + Number(exp.partnerPart).toLocaleString() + ')</small>' : '';

        const categoryIcons = {
          'é£²é£Ÿ': 'ğŸœ',
          'å±…ä½': 'ğŸ ',
          'äº¤é€š': 'ğŸš—',
          'å¨›æ¨‚': 'ğŸ®',
          'å…¶ä»–': 'ğŸ“¦'
        };
        const icon = categoryIcons[exp.category] || 'ğŸ“¦';

        // ä½¿ç”¨å®‰å…¨çš„ HTML è½‰ç¾©
        const safeItem = escapeHtml(exp.item);
        const safeCategory = escapeHtml(exp.category);
        const safePayer = escapeHtml(exp.payer);
        const safeDate = escapeHtml(exp.date);

        return '<div class="expense-item ' + className + '">' +
          '<div class="expense-info">' +
            '<strong>' + icon + ' ' + safeItem + '</strong>' +
            '<div style="font-size: 0.85em; color: #666; margin-top: 4px;">' +
              safeDate + ' Â· ' + safeCategory + ' Â· ' + safePayer +
              splitInfo +
            '</div>' +
          '</div>' +
          '<div style="display: flex; align-items: center;">' +
            '<div class="expense-amount">$' + Number(exp.amount).toLocaleString() + '</div>' +
            '<button class="delete-btn" onclick="deleteExpense(\'' + exp.id + '\')">åˆªé™¤</button>' +
          '</div>' +
        '</div>';
      }).join('');

      listEl.innerHTML = html;
    }

    // åˆªé™¤è¨˜éŒ„
    function deleteExpense(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          showToast('åˆªé™¤æˆåŠŸï¼', 'success');
          loadData();
        })
        .withFailureHandler(showError)
        .deleteExpenseById(id);
    }

    // ==================== å„€è¡¨æ¿åŠŸèƒ½ ====================

    let currentDashboardPeriod = 'currentMonth';

    function changeDashboardPeriod() {
      currentDashboardPeriod = document.getElementById('dashboardPeriod').value;
      updateDashboard(allExpenses);
    }

    function updateDashboard(expenses) {
      const period = currentDashboardPeriod;

      if (period === 'comparison') {
        updateComparisonDashboard(expenses);
      } else {
        updateSinglePeriodDashboard(expenses, period);
      }
    }

    function updateSinglePeriodDashboard(expenses, period) {
      const now = new Date();
      let periodExpenses, periodName, icon, daysCount;

      // æ ¹æ“šé¸æ“‡çš„æ™‚é–“ç¯„åœç¯©é¸æ•¸æ“š
      if (period === 'currentMonth') {
        periodName = 'æœ¬æœˆ';
        icon = 'ğŸ“…';
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
        });
        daysCount = now.getDate();
      } else if (period === 'lastMonth') {
        periodName = 'ä¸Šæœˆ';
        icon = 'ğŸ“…';
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate.getMonth() === lastMonth.getMonth() && expDate.getFullYear() === lastMonth.getFullYear();
        });
        daysCount = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0).getDate();
      } else if (period === 'last7days') {
        periodName = 'æœ€è¿‘ 7 å¤©';
        icon = 'ğŸ“Š';
        const sevenDaysAgo = new Date(now);
        sevenDaysAgo.setDate(now.getDate() - 7);
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate >= sevenDaysAgo;
        });
        daysCount = 7;
      } else if (period === 'last30days') {
        periodName = 'æœ€è¿‘ 30 å¤©';
        icon = 'ğŸ“Š';
        const thirtyDaysAgo = new Date(now);
        thirtyDaysAgo.setDate(now.getDate() - 30);
        periodExpenses = expenses.filter(function(exp) {
          const expDate = new Date(exp.date);
          return expDate >= thirtyDaysAgo;
        });
        daysCount = 30;
      }

      // è¨ˆç®—çµ±è¨ˆæ•¸æ“š
      const total = periodExpenses.reduce(function(sum, exp) {
        return sum + Number(exp.amount);
      }, 0);
      const count = periodExpenses.length;
      const dailyAvg = daysCount > 0 ? total / daysCount : 0;

      // æ›´æ–°ç¬¬ä¸€å¼µå¡ç‰‡
      document.getElementById('dashboardIcon1').textContent = icon;
      document.getElementById('dashboardTitle1').textContent = periodName + 'æ¦‚æ³';
      document.getElementById('label1').textContent = 'ç¸½æ”¯å‡º';
      document.getElementById('value1').textContent = '$' + total.toLocaleString();
      document.getElementById('label2').textContent = 'è¨˜éŒ„æ•¸';
      document.getElementById('value2').textContent = count + ' ç­†';
      document.getElementById('label3').textContent = 'æ—¥å‡æ”¯å‡º';
      document.getElementById('value3').textContent = '$' + Math.round(dailyAvg).toLocaleString();

      // è¨ˆç®—æ’è¡Œ
      const categoryStats = {};
      periodExpenses.forEach(function(exp) {
        if (!categoryStats[exp.category]) {
          categoryStats[exp.category] = 0;
        }
        categoryStats[exp.category] += Number(exp.amount);
      });

      let topCategory = 'é£²é£Ÿ';
      let maxCategoryAmount = 0;
      for (const cat in categoryStats) {
        if (categoryStats[cat] > maxCategoryAmount) {
          maxCategoryAmount = categoryStats[cat];
          topCategory = cat;
        }
      }

      const maxExpense = periodExpenses.length > 0 ? Math.max(...periodExpenses.map(function(exp) {
        return Number(exp.amount);
      })) : 0;

      const payerStats = {};
      periodExpenses.forEach(function(exp) {
        if (!payerStats[exp.payer]) {
          payerStats[exp.payer] = 0;
        }
        payerStats[exp.payer]++;
      });

      let topPayer = 'ä½ ';
      let maxPayerCount = 0;
      for (const payer in payerStats) {
        if (payerStats[payer] > maxPayerCount) {
          maxPayerCount = payerStats[payer];
          topPayer = payer;
        }
      }

      // æ›´æ–°ç¬¬äºŒå¼µå¡ç‰‡
      document.getElementById('dashboardTitle2').textContent = periodName + 'æ’è¡Œ';
      document.getElementById('topCategory').textContent = topCategory + ' $' + maxCategoryAmount.toLocaleString();
      document.getElementById('maxExpense').textContent = '$' + maxExpense.toLocaleString();
      document.getElementById('topPayer').textContent = topPayer + ' (' + maxPayerCount + 'æ¬¡)';

      // æ›´æ–°ç¬¬ä¸‰å¼µå¡ç‰‡ï¼ˆè¶¨å‹¢ï¼‰
      document.getElementById('dashboardTitle3').textContent = periodName + 'è¶¨å‹¢';
      document.getElementById('label4').textContent = 'ç¸½æ”¯å‡º';
      document.getElementById('value4').textContent = '$' + total.toLocaleString();
      document.getElementById('label5').textContent = 'æ—¥å‡æ”¯å‡º';
      document.getElementById('value5').textContent = '$' + Math.round(dailyAvg).toLocaleString();
      document.getElementById('label6').textContent = 'è¨˜å¸³æ¬¡æ•¸';
      document.getElementById('value6').textContent = count + ' ç­†';
    }

    function updateComparisonDashboard(expenses) {
      const now = new Date();
      const currentMonth = now.getMonth();
      const currentYear = now.getFullYear();

      // æœ¬æœˆæ•¸æ“š
      const currentMonthExpenses = expenses.filter(function(exp) {
        const expDate = new Date(exp.date);
        return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
      });

      // ä¸Šæœˆæ•¸æ“š
      const lastMonth = new Date(currentYear, currentMonth - 1, 1);
      const lastMonthExpenses = expenses.filter(function(exp) {
        const expDate = new Date(exp.date);
        return expDate.getMonth() === lastMonth.getMonth() && expDate.getFullYear() === lastMonth.getFullYear();
      });

      // è¨ˆç®—æœ¬æœˆçµ±è¨ˆ
      const currentTotal = currentMonthExpenses.reduce(function(sum, exp) {
        return sum + Number(exp.amount);
      }, 0);
      const currentCount = currentMonthExpenses.length;
      const currentDays = now.getDate();
      const currentDailyAvg = currentDays > 0 ? currentTotal / currentDays : 0;

      // è¨ˆç®—ä¸Šæœˆçµ±è¨ˆ
      const lastTotal = lastMonthExpenses.reduce(function(sum, exp) {
        return sum + Number(exp.amount);
      }, 0);
      const lastCount = lastMonthExpenses.length;
      const lastMonthDays = new Date(lastMonth.getFullYear(), lastMonth.getMonth() + 1, 0).getDate();
      const lastDailyAvg = lastMonthDays > 0 ? lastTotal / lastMonthDays : 0;

      // è¨ˆç®—å¢æ¸›ç™¾åˆ†æ¯”
      function calculateChange(current, last) {
        if (last === 0) return current > 0 ? 100 : 0;
        return ((current - last) / last * 100).toFixed(1);
      }

      function getTrendHTML(change) {
        const changeNum = parseFloat(change);
        if (changeNum > 0) {
          return '<span class="trend-indicator trend-up">â†‘ ' + Math.abs(changeNum) + '%</span>';
        } else if (changeNum < 0) {
          return '<span class="trend-indicator trend-down">â†“ ' + Math.abs(changeNum) + '%</span>';
        } else {
          return '<span class="trend-indicator trend-neutral">â”€ 0%</span>';
        }
      }

      const totalChange = calculateChange(currentTotal, lastTotal);
      const countChange = calculateChange(currentCount, lastCount);
      const avgChange = calculateChange(currentDailyAvg, lastDailyAvg);

      // æ›´æ–°ç¬¬ä¸€å¼µå¡ç‰‡ï¼ˆæœ¬æœˆï¼‰
      document.getElementById('dashboardIcon1').textContent = 'ğŸ“…';
      document.getElementById('dashboardTitle1').textContent = 'æœ¬æœˆæ•¸æ“š';
      document.getElementById('label1').textContent = 'ç¸½æ”¯å‡º';
      document.getElementById('value1').innerHTML = '$' + currentTotal.toLocaleString() + getTrendHTML(totalChange);
      document.getElementById('label2').textContent = 'è¨˜éŒ„æ•¸';
      document.getElementById('value2').innerHTML = currentCount + ' ç­†' + getTrendHTML(countChange);
      document.getElementById('label3').textContent = 'æ—¥å‡æ”¯å‡º';
      document.getElementById('value3').innerHTML = '$' + Math.round(currentDailyAvg).toLocaleString() + getTrendHTML(avgChange);

      // æ›´æ–°ç¬¬äºŒå¼µå¡ç‰‡ï¼ˆä¸Šæœˆï¼‰
      document.getElementById('dashboardTitle2').textContent = 'ä¸Šæœˆæ•¸æ“š';
      document.getElementById('topCategory').textContent = 'ç¸½æ”¯å‡º $' + lastTotal.toLocaleString();
      document.getElementById('maxExpense').textContent = 'è¨˜éŒ„æ•¸ ' + lastCount + ' ç­†';
      document.getElementById('topPayer').textContent = 'æ—¥å‡ $' + Math.round(lastDailyAvg).toLocaleString();

      // è¨ˆç®—æ’è¡Œï¼ˆä½¿ç”¨æœ¬æœˆæ•¸æ“šï¼‰
      const categoryStats = {};
      currentMonthExpenses.forEach(function(exp) {
        if (!categoryStats[exp.category]) {
          categoryStats[exp.category] = 0;
        }
        categoryStats[exp.category] += Number(exp.amount);
      });

      let topCategory = 'é£²é£Ÿ';
      let maxCategoryAmount = 0;
      for (const cat in categoryStats) {
        if (categoryStats[cat] > maxCategoryAmount) {
          maxCategoryAmount = categoryStats[cat];
          topCategory = cat;
        }
      }

      // æ›´æ–°ç¬¬ä¸‰å¼µå¡ç‰‡ï¼ˆè¶¨å‹¢åˆ†æï¼‰
      document.getElementById('dashboardTitle3').textContent = 'è¶¨å‹¢åˆ†æ';

      let analysis = '';
      if (parseFloat(totalChange) > 10) {
        analysis = 'âš ï¸ æ”¯å‡ºæ˜é¡¯å¢åŠ ';
      } else if (parseFloat(totalChange) < -10) {
        analysis = 'âœ… æ”¯å‡ºæ˜é¡¯æ¸›å°‘';
      } else {
        analysis = 'ğŸ“Š æ”¯å‡ºç›¸å°ç©©å®š';
      }

      document.getElementById('label4').textContent = 'æœˆåº¦è®ŠåŒ–';
      document.getElementById('value4').textContent = analysis;
      document.getElementById('label5').textContent = 'æœ¬æœˆæœ€å¤š';
      document.getElementById('value5').textContent = topCategory + ' $' + maxCategoryAmount.toLocaleString();
      document.getElementById('label6').textContent = 'è¨˜å¸³æ¬¡æ•¸';
      document.getElementById('value6').textContent = currentCount + ' vs ' + lastCount;
    }

    // ==================== å¿«é€Ÿè¨˜å¸³åŠŸèƒ½ ====================

    function quickExpense(item, amount, category) {
      // è‡ªå‹•å¡«å…¥è¡¨å–®
      document.getElementById('item').value = item;
      document.getElementById('amount').value = amount;
      document.getElementById('category').value = category;

      // æ»¾å‹•åˆ°é‡‘é¡è¼¸å…¥æ¡†
      document.getElementById('amount').focus();
      document.getElementById('amount').select();

      // é¡¯ç¤ºæç¤º
      showToast('å·²å¡«å…¥ã€Œ' + item + ' $' + amount + 'ã€ï¼Œå¯ä¿®æ”¹é‡‘é¡å¾Œé€å‡º', 'success');
    }

    function addExpense() {
      const item = document.getElementById('item').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const splitType = document.getElementById('splitType').value;
      const payer = document.getElementById('payer').value;
      const category = document.getElementById('category').value;

      // å‰ç«¯é©—è­‰
      if (!validateInput(item, 'text', 1, 100)) {
        showToast('é …ç›®åç¨±å¿…é ˆæ˜¯ 1-100 å­—å…ƒ', 'error');
        return;
      }

      if (!validateInput(amount, 'number', 0.01, 9999999)) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ï¼ˆ0.01 åˆ° 9,999,999ï¼‰', 'error');
        return;
      }

      let yourPart = 0, partnerPart = 0, displayPayer = '';

      if (splitType === 'single') {
        if (payer === 'ä½ ') {
          yourPart = amount;
          displayPayer = 'ä½ ';
        } else {
          partnerPart = amount;
          displayPayer = 'å°æ–¹';
        }
      } else if (splitType === 'equal') {
        yourPart = partnerPart = amount / 2;
        displayPayer = 'å…©äºº';
      } else {
        yourPart = parseFloat(document.getElementById('yourPart').value) || 0;
        partnerPart = parseFloat(document.getElementById('partnerPart').value) || 0;
        if (Math.abs(yourPart + partnerPart - amount) > 0.01) {
          showToast('è‡ªè¨‚åˆ†å¸³é‡‘é¡ç¸½å’Œå¿…é ˆç­‰æ–¼ç¸½é‡‘é¡', 'error');
          return;
        }
        displayPayer = 'å…©äºº';
      }

      const expenseData = {
        item: item,
        amount: amount,
        payer: displayPayer,
        yourPart: yourPart,
        partnerPart: partnerPart,
        category: category,
        isRecurring: false,
        recurringDay: ''
      };

      // æŒ‰éˆ• Loading ç‹€æ…‹
      const btn = document.querySelector('.btn-primary');
      btn.disabled = true;
      btn.classList.add('btn-loading');

      google.script.run
        .withSuccessHandler(function() {
          showToast('æ–°å¢æˆåŠŸï¼ ğŸ‰', 'success');
          document.getElementById('item').value = '';
          document.getElementById('amount').value = '';
          document.getElementById('yourPart').value = '';
          document.getElementById('partnerPart').value = '';
          btn.disabled = false;
          btn.classList.remove('btn-loading');
          loadData();
        })
        .withFailureHandler(function(error) {
          showError(error);
          btn.disabled = false;
          btn.classList.remove('btn-loading');
        })
        .addExpenseFromWeb(expenseData);
    }

    function updatePayerOptions() {
      const splitType = document.getElementById('splitType').value;
      const payerGroup = document.getElementById('payerGroup');
      const customSplit = document.getElementById('customSplit');

      if (splitType === 'single') {
        payerGroup.classList.remove('hidden');
        customSplit.classList.add('hidden');
      } else if (splitType === 'equal') {
        payerGroup.classList.add('hidden');
        customSplit.classList.add('hidden');
      } else {
        payerGroup.classList.add('hidden');
        customSplit.classList.remove('hidden');
      }
    }

    function showError(error) {
      showToast('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message, 'error');
      console.error(error);
    }

    // åœ–è¡¨åŠŸèƒ½
    // ==================== åœ–è¡¨åŠŸèƒ½å¢å¼· ====================

    let currentChartData = null;

    function showCharts() {
      // æº–å‚™æ•¸æ“š
      currentChartData = prepareChartData(filteredExpenses);

      // æ‰“é–‹ Modal
      document.getElementById('chartModal').classList.remove('hidden');

      // ç¹ªè£½é»˜èªæ¨™ç±¤é çš„åœ–è¡¨
      switchChartTab(1);
    }

    function prepareChartData(expenses) {
      const categoryStats = {};
      const payerStats = { 'ä½ ': 0, 'å°æ–¹': 0 };
      const monthlyStats = {};
      const dailyStats = {};

      expenses.forEach(function(exp) {
        const amount = Number(exp.amount);

        // åˆ†é¡çµ±è¨ˆ
        if (!categoryStats[exp.category]) {
          categoryStats[exp.category] = 0;
        }
        categoryStats[exp.category] += amount;

        // ä»˜æ¬¾äººçµ±è¨ˆï¼ˆåˆä½µå…©äººåˆ°å„è‡ªï¼‰
        if (exp.payer === 'ä½ ') {
          payerStats['ä½ '] += amount;
        } else if (exp.payer === 'å°æ–¹') {
          payerStats['å°æ–¹'] += amount;
        } else if (exp.payer === 'å…©äºº') {
          payerStats['ä½ '] += Number(exp.yourPart || 0);
          payerStats['å°æ–¹'] += Number(exp.partnerPart || 0);
        }

        // æœˆåº¦çµ±è¨ˆ
        const expDate = new Date(exp.date);
        const monthKey = expDate.getFullYear() + '-' + String(expDate.getMonth() + 1).padStart(2, '0');
        if (!monthlyStats[monthKey]) {
          monthlyStats[monthKey] = 0;
        }
        monthlyStats[monthKey] += amount;

        // æ¯æ—¥çµ±è¨ˆï¼ˆæœ€è¿‘ 30 å¤©ï¼‰
        const dayKey = exp.date;
        if (!dailyStats[dayKey]) {
          dailyStats[dayKey] = 0;
        }
        dailyStats[dayKey] += amount;
      });

      return {
        categoryStats: categoryStats,
        payerStats: payerStats,
        monthlyStats: monthlyStats,
        dailyStats: dailyStats
      };
    }

    function switchChartTab(tabNum) {
      // æ›´æ–°æ¨™ç±¤æ¨£å¼
      for (let i = 1; i <= 3; i++) {
        const tab = document.getElementById('chartTab' + i);
        const content = document.getElementById('chartTabContent' + i);
        if (i === tabNum) {
          tab.classList.add('active');
          content.classList.remove('hidden');
        } else {
          tab.classList.remove('active');
          content.classList.add('hidden');
        }
      }

      // ç¹ªè£½å°æ‡‰çš„åœ–è¡¨
      if (!currentChartData) return;

      if (tabNum === 1) {
        drawCategoryCharts(currentChartData.categoryStats);
      } else if (tabNum === 2) {
        drawTrendCharts(currentChartData.dailyStats, currentChartData.monthlyStats);
      } else if (tabNum === 3) {
        drawPayerCharts(currentChartData.payerStats);
      }
    }

    function drawCategoryCharts(categoryStats) {
      google.charts.setOnLoadCallback(function() {
        // åœ“é¤…åœ–
        const pieData = new google.visualization.DataTable();
        pieData.addColumn('string', 'åˆ†é¡');
        pieData.addColumn('number', 'é‡‘é¡');

        const categoryIcons = {
          'é£²é£Ÿ': 'ğŸœ',
          'å±…ä½': 'ğŸ ',
          'äº¤é€š': 'ğŸš—',
          'å¨›æ¨‚': 'ğŸ®',
          'è³¼ç‰©': 'ğŸ›ï¸',
          'å…¶ä»–': 'ğŸ“¦'
        };

        for (const [category, amount] of Object.entries(categoryStats)) {
          const icon = categoryIcons[category] || 'ğŸ“¦';
          pieData.addRow([icon + ' ' + category, amount]);
        }

        const pieOptions = {
          title: 'æ”¯å‡ºåˆ†é¡ä½”æ¯”',
          pieHole: 0.4,
          colors: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'],
          chartArea: { width: '90%', height: '80%' },
          legend: { position: 'right', textStyle: { fontSize: 13 } },
          pieSliceText: 'percentage',
          tooltip: { text: 'both' }
        };

        const pieChart = new google.visualization.PieChart(document.getElementById('categoryPieChart'));
        pieChart.draw(pieData, pieOptions);

        // é•·æ¢åœ–ï¼ˆä½¿ç”¨å‚³çµ±æ¨£å¼ï¼‰
        const maxAmount = Math.max(...Object.values(categoryStats));
        let barHTML = '<div class="chart-container">';
        barHTML += '<h3 style="margin-bottom: 20px;">ğŸ“Š åˆ†é¡è©³ç´°é‡‘é¡</h3>';

        for (const [category, amount] of Object.entries(categoryStats)) {
          const percentage = (amount / maxAmount) * 100;
          const icon = categoryIcons[category] || 'ğŸ“¦';
          barHTML += '<div class="chart-bar">' +
            '<div class="chart-label">' + icon + ' ' + category + '</div>' +
            '<div class="chart-bar-bg">' +
              '<div class="chart-bar-fill" style="width: ' + percentage + '%">$' + amount.toLocaleString() + '</div>' +
            '</div>' +
          '</div>';
        }
        barHTML += '</div>';
        document.getElementById('categoryBarChart').innerHTML = barHTML;
      });
    }

    function drawTrendCharts(dailyStats, monthlyStats) {
      google.charts.setOnLoadCallback(function() {
        // æ¯æ—¥è¶¨å‹¢ç·šåœ–ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰
        const lineData = new google.visualization.DataTable();
        lineData.addColumn('string', 'æ—¥æœŸ');
        lineData.addColumn('number', 'æ”¯å‡º');

        const sortedDays = Object.keys(dailyStats).sort().slice(-30);
        sortedDays.forEach(function(day) {
          const shortDate = day.substring(5); // MM-DD
          lineData.addRow([shortDate, dailyStats[day]]);
        });

        const lineOptions = {
          title: 'æ¯æ—¥æ”¯å‡ºè¶¨å‹¢ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰',
          curveType: 'function',
          colors: ['#667eea'],
          chartArea: { width: '85%', height: '70%' },
          legend: { position: 'none' },
          hAxis: {
            title: 'æ—¥æœŸ',
            slantedText: true,
            slantedTextAngle: 45
          },
          vAxis: {
            title: 'é‡‘é¡ (NT$)',
            format: '$#,###'
          }
        };

        const lineChart = new google.visualization.LineChart(document.getElementById('trendLineChart'));
        lineChart.draw(lineData, lineOptions);

        // æœˆåº¦æŸ±ç‹€åœ–
        const barData = new google.visualization.DataTable();
        barData.addColumn('string', 'æœˆä»½');
        barData.addColumn('number', 'æ”¯å‡º');

        const sortedMonths = Object.keys(monthlyStats).sort().slice(-6);
        sortedMonths.forEach(function(month) {
          const monthLabel = month.substring(5) + 'æœˆ'; // MMæœˆ
          barData.addRow([monthLabel, monthlyStats[month]]);
        });

        const barOptions = {
          title: 'æœˆåº¦æ”¯å‡ºæ¯”è¼ƒï¼ˆæœ€è¿‘ 6 å€‹æœˆï¼‰',
          colors: ['#764ba2'],
          chartArea: { width: '80%', height: '70%' },
          legend: { position: 'none' },
          hAxis: { title: 'æœˆä»½' },
          vAxis: {
            title: 'é‡‘é¡ (NT$)',
            format: '$#,###'
          },
          bar: { groupWidth: '70%' }
        };

        const barChart = new google.visualization.ColumnChart(document.getElementById('monthlyBarChart'));
        barChart.draw(barData, barOptions);
      });
    }

    function drawPayerCharts(payerStats) {
      google.charts.setOnLoadCallback(function() {
        // åœ“é¤…åœ–
        const pieData = new google.visualization.DataTable();
        pieData.addColumn('string', 'ä»˜æ¬¾äºº');
        pieData.addColumn('number', 'é‡‘é¡');

        for (const [payer, amount] of Object.entries(payerStats)) {
          if (amount > 0) {
            pieData.addRow([payer, amount]);
          }
        }

        const pieOptions = {
          title: 'ä»˜æ¬¾äººä½”æ¯”',
          pieHole: 0.4,
          colors: ['#667eea', '#764ba2'],
          chartArea: { width: '90%', height: '80%' },
          legend: { position: 'right', textStyle: { fontSize: 14 } },
          pieSliceText: 'percentage',
          tooltip: { text: 'both' }
        };

        const pieChart = new google.visualization.PieChart(document.getElementById('payerPieChart'));
        pieChart.draw(pieData, pieOptions);

        // é•·æ¢åœ–
        const maxPayer = Math.max(...Object.values(payerStats));
        let barHTML = '<div class="chart-container">';
        barHTML += '<h3 style="margin-bottom: 20px;">ğŸ‘¥ ä»˜æ¬¾è©³ç´°é‡‘é¡</h3>';

        for (const [payer, amount] of Object.entries(payerStats)) {
          if (amount === 0) continue;
          const percentage = (amount / maxPayer) * 100;
          barHTML += '<div class="chart-bar">' +
            '<div class="chart-label">' + payer + '</div>' +
            '<div class="chart-bar-bg">' +
              '<div class="chart-bar-fill" style="width: ' + percentage + '%">$' + amount.toLocaleString() + '</div>' +
            '</div>' +
          '</div>';
        }
        barHTML += '</div>';
        document.getElementById('payerBarChart').innerHTML = barHTML;
      });
    }

    function closeChartModal() {
      document.getElementById('chartModal').classList.add('hidden');
    }

    // ==================== æˆå“¡ç®¡ç†åŠŸèƒ½ ====================

    // é–‹å•Ÿæˆå“¡ç®¡ç† Modal
    function openMembersModal() {
      document.getElementById('membersModal').classList.remove('hidden');
      loadMembers();
    }

    // é—œé–‰æˆå“¡ç®¡ç† Modal
    function closeMembersModal() {
      const modal = document.getElementById('membersModal');
      if (modal) {
        modal.classList.add('hidden');
      }
    }

    // è¼‰å…¥æˆå“¡åˆ—è¡¨
    function loadMembers() {
      document.getElementById('membersList').innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">è¼‰å…¥ä¸­...</div>';

      google.script.run
        .withSuccessHandler(function(members) {
          displayMembers(members);
        })
        .withFailureHandler(function(error) {
          showToast('è¼‰å…¥æˆå“¡åˆ—è¡¨å¤±æ•—ï¼š' + error.message, 'error');
          document.getElementById('membersList').innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">è¼‰å…¥å¤±æ•—</div>';
        })
        .getMembers();
    }

    // é¡¯ç¤ºæˆå“¡åˆ—è¡¨
    function displayMembers(members) {
      const membersListEl = document.getElementById('membersList');

      if (members.length === 0) {
        membersListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ç›®å‰æ²’æœ‰æˆå“¡</div>';
        return;
      }

      const html = members.map(function(member) {
        const ownerClass = member.isOwner ? 'owner' : '';
        const ownerBadge = member.isOwner ? '<span class="member-badge">ç®¡ç†å“¡</span>' : '';
        const removeBtn = !member.isOwner ? '<button class="remove-member-btn" onclick="removeMemberAction(\'' + escapeHtml(member.email) + '\')">ç§»é™¤</button>' : '';

        // ä½¿ç”¨å®‰å…¨çš„ HTML è½‰ç¾©
        const safeName = escapeHtml(member.name);
        const safeEmail = escapeHtml(member.email);

        return '<div class="member-card ' + ownerClass + '">' +
          '<div class="member-info">' +
            '<div>' +
              '<div style="font-weight: 600; color: #333;">' + safeName + '</div>' +
              '<div style="font-size: 0.85em; color: #999;">' + safeEmail + '</div>' +
            '</div>' +
            ownerBadge +
          '</div>' +
          removeBtn +
        '</div>';
      }).join('');

      membersListEl.innerHTML = html;
    }

    // é‚€è«‹æˆå“¡
    function inviteMemberAction() {
      const emailInput = document.getElementById('inviteEmail');
      const email = emailInput.value.trim();

      // å‰ç«¯é©—è­‰
      if (!validateInput(email, 'email')) {
        showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Email åœ°å€', 'error');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          showToast(result.message, 'success');
          emailInput.value = '';
          loadMembers();
        })
        .withFailureHandler(function(error) {
          showToast('é‚€è«‹å¤±æ•—ï¼š' + error.message, 'error');
        })
        .inviteMember(email);
    }

    // ç§»é™¤æˆå“¡
    function removeMemberAction(email) {
      if (!confirm('ç¢ºå®šè¦ç§»é™¤ ' + email + ' å—ï¼Ÿ')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          showToast(result.message, 'success');
          loadMembers();
        })
        .withFailureHandler(function(error) {
          showToast('ç§»é™¤å¤±æ•—ï¼š' + error.message, 'error');
        })
        .removeMember(email);
    }

    // åŒ¯å‡ºåŠŸèƒ½
    function exportData() {
      let csv = 'æ—¥æœŸ,é …ç›®,é‡‘é¡,ä»˜æ¬¾äºº,ä½ çš„éƒ¨åˆ†,å°æ–¹çš„éƒ¨åˆ†,åˆ†é¡\n';

      filteredExpenses.forEach(function(exp) {
        csv += exp.date + ',' +
          exp.item + ',' +
          exp.amount + ',' +
          exp.payer + ',' +
          exp.yourPart + ',' +
          exp.partnerPart + ',' +
          exp.category + '\n';
      });

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      link.setAttribute('href', url);
      link.setAttribute('download', 'æ”¯å‡ºè¨˜éŒ„_' + new Date().toISOString().slice(0, 10) + '.csv');
      link.style.visibility = 'hidden';

      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast('åŒ¯å‡ºæˆåŠŸï¼', 'success');
    }

    // éµç›¤å¿«æ·éµå’Œäº‹ä»¶ç›£è½
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('item').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('amount').focus();
        }
      });

      document.getElementById('amount').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          addExpense();
        }
      });

      // Modal é»æ“Šå¤–éƒ¨é—œé–‰
      document.getElementById('chartModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeChartModal();
        }
      });

      document.getElementById('membersModal').addEventListener('click', function(e) {
        if (e.target === this) {
          closeMembersModal();
        }
      });

      // æˆå“¡ç®¡ç† Modal é—œé–‰æŒ‰éˆ•
      const closeMembersBtn = document.getElementById('closeMembersBtn');
      if (closeMembersBtn) {
        closeMembersBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          closeMembersModal();
        });
      }

      // ESC éµé—œé–‰æ‰€æœ‰ Modal
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeChartModal();
          closeMembersModal();
        }
      });

      // Enter éµç™¼é€é‚€è«‹
      document.getElementById('inviteEmail').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          inviteMemberAction();
        }
      });
    });

    window.onload = function() {
      loadData();
      loadUserInfo();
    };
  </script>
</body>
</html>
