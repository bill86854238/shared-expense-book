# 🔒 資安功能說明

## 已實現的資安防護

### 1. 🛡️ 輸入驗證（Input Validation）

#### 後端驗證 (Code.gs)
所有用戶輸入都經過嚴格驗證：

**文字輸入**
- ✅ 長度限制：1-100 字元
- ✅ 空值檢查
- ✅ 類型檢查

**數字輸入**
- ✅ 數值範圍：0.01 - 9,999,999
- ✅ NaN 檢查
- ✅ 負數防護

**Email 驗證**
- ✅ 格式驗證（正則表達式）
- ✅ 重複檢查
- ✅ 大小寫標準化

**金額驗證**
- ✅ 分帳總和必須等於總金額
- ✅ 浮點數精度處理（誤差容忍 0.01）

#### 前端驗證 (index.html)
- ✅ 即時輸入驗證
- ✅ 友善的錯誤提示
- ✅ 防止提交無效數據

---

### 2. 🚫 XSS 防護（Cross-Site Scripting）

#### HTML 轉義
所有用戶輸入在顯示前都經過 HTML 轉義：

**後端（Code.gs）**
```javascript
function escapeHtml(text) {
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}
```

**前端（index.html）**
```javascript
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
```

**保護的位置：**
- ✅ 支出項目名稱
- ✅ 分類名稱
- ✅ 成員名稱和 Email
- ✅ 所有用戶可輸入的文字

---

### 3. 🚦 頻率限制（Rate Limiting）

#### 防止濫用攻擊
使用 Google Apps Script 的 CacheService 實現：

**限制規則：**
- 每個使用者每分鐘最多 50 次操作
- 適用於：
  - ✅ 新增支出
  - ✅ 刪除支出
  - ✅ 邀請成員
  - ✅ 移除成員

**實現方式：**
```javascript
function checkRateLimit(action) {
  const userCache = CacheService.getUserCache();
  const key = 'ratelimit_' + action;
  const count = userCache.get(key);

  if (count && Number(count) > 50) {
    throw new Error('操作過於頻繁，請稍後再試');
  }

  userCache.put(key, Number(count || 0) + 1, 60);
}
```

---

### 4. 📝 操作日誌（Audit Logging）

#### 完整的操作追踪
自動記錄所有重要操作：

**日誌內容：**
- ⏰ 時間戳記
- 👤 操作者 Email
- 🎯 操作類型
- 📄 詳細資訊
- 🔑 裝置識別

**記錄的操作：**
1. ✅ 新增支出 - 記錄項目、金額、付款人
2. ✅ 刪除支出 - 記錄被刪除的項目資訊
3. ✅ 邀請成員 - 記錄被邀請者 Email
4. ✅ 移除成員 - 記錄被移除者 Email
5. ✅ 權限違規嘗試 - 記錄未授權操作

**查看日誌：**
1. 打開 Google 試算表
2. 找到「操作日誌」工作表
3. 查看完整操作歷史

---

### 5. 🔐 權限控制（Access Control）

#### 多層級權限驗證

**Google 帳號驗證**
- ✅ 基於 Google OAuth 2.0
- ✅ 自動獲取使用者身份
- ✅ Session 管理

**白名單機制**
- ✅ 只有授權的 Email 可以訪問
- ✅ 自動檢查每次請求
- ✅ 未授權者顯示友善錯誤頁面

**角色權限**
- **管理員（擁有者）**
  - ✅ 邀請新成員
  - ✅ 移除成員
  - ✅ 查看操作日誌
  - ✅ 所有記帳功能

- **普通成員**
  - ✅ 新增支出
  - ✅ 刪除自己的支出
  - ✅ 查看所有記錄
  - ❌ 無法邀請/移除成員

---

### 6. 🔒 資料保護

#### 敏感資訊處理

**Email 顯示**
- 完整 Email 僅在必要時顯示
- 成員列表中顯示完整 Email（方便管理）
- 可考慮未來加入遮罩功能

**數據存儲**
- ✅ 數據存儲在 Google 試算表
- ✅ 繼承 Google 的安全機制
- ✅ 支援試算表層級的權限控制

**通訊安全**
- ✅ 強制 HTTPS 連線
- ✅ Google Apps Script 自動加密

---

## 🚨 安全建議

### 給管理員的建議

1. **定期檢查成員列表**
   - 移除不再需要訪問的成員
   - 確認所有成員都是可信任的人

2. **查看操作日誌**
   - 定期檢查「操作日誌」工作表
   - 注意異常的操作模式
   - 發現問題立即移除相關成員

3. **備份資料**
   - 定期下載試算表備份
   - 使用 Google 試算表的版本歷史功能
   - 考慮設定自動備份

4. **保護擁有者帳號**
   - 使用強密碼
   - 啟用兩步驟驗證（2FA）
   - 不要分享 Google 帳號密碼

5. **謹慎邀請**
   - 只邀請信任的人
   - 確認 Email 地址正確
   - 邀請前與對方確認

### 給所有使用者的建議

1. **保護自己的帳號**
   - 使用強密碼
   - 啟用 Google 兩步驟驗證
   - 不要在公共電腦上保持登入

2. **謹慎輸入**
   - 確認金額和項目無誤
   - 刪除前再次確認
   - 發現錯誤立即修正

3. **登出習慣**
   - 使用完畢後登出
   - 特別是在共用裝置上
   - 點擊右上角「登出」按鈕

4. **異常通報**
   - 發現異常記錄立即通知管理員
   - 懷疑帳號被盜立即變更密碼
   - 收到可疑邀請不要點擊

---

## 🔍 已知限制

### 1. Session 管理
- Google Apps Script 的 Session 由 Google 管理
- 無法自定義 Session 過期時間
- 依賴 Google 的 OAuth 機制

### 2. IP 記錄
- 無法直接獲取使用者 IP 地址
- 使用 `Session.getTemporaryActiveUserKey()` 作為裝置識別
- 這是簡化的識別方式

### 3. 密碼策略
- 依賴 Google 帳號安全
- 無法強制要求特定密碼強度
- 建議使用者自行啟用 2FA

### 4. 數據加密
- 數據存儲在 Google 試算表
- 明文存儲（但受 Google 保護）
- 適合一般記帳用途
- 不建議存儲極度敏感資訊

---

## ✅ 安全檢查清單

### 部署前
- [ ] 已啟用 People API
- [ ] 已設定正確的執行權限
- [ ] 已測試邀請功能
- [ ] 已確認日誌功能正常

### 部署後
- [ ] 只邀請信任的成員
- [ ] 設定工作表中已填寫允許的使用者
- [ ] 已測試登入和登出
- [ ] 已確認所有功能正常運作

### 定期維護
- [ ] 每月檢查成員列表
- [ ] 每月查看操作日誌
- [ ] 每季備份數據
- [ ] 發現問題立即處理

---

## 🆘 安全事件處理

### 發現未授權訪問

1. **立即行動**
   - 移除可疑成員
   - 變更 Google 帳號密碼
   - 啟用兩步驟驗證

2. **檢查日誌**
   - 查看「操作日誌」
   - 確認可疑操作
   - 記錄證據

3. **修復數據**
   - 檢查被修改的記錄
   - 使用試算表版本歷史恢復
   - 必要時重新輸入

4. **加強防護**
   - 更新成員白名單
   - 通知所有成員
   - 考慮重新部署

### 發現數據錯誤

1. **停止使用**
   - 暫時不要新增記錄
   - 通知所有成員

2. **找出問題**
   - 檢查操作日誌
   - 確認錯誤來源
   - 確定影響範圍

3. **恢復數據**
   - 使用 Google 試算表版本歷史
   - 手動修正錯誤記錄
   - 驗證數據正確性

4. **預防再次發生**
   - 分析問題原因
   - 加強使用者教育
   - 必要時調整權限

---

## 🔮 未來可能的增強功能

### 資安相關

1. **增強的身份驗證**
   - [ ] 強制兩步驟驗證
   - [ ] 登入通知
   - [ ] 裝置管理

2. **更詳細的日誌**
   - [ ] 記錄修改前後的值
   - [ ] IP 地址記錄（如可行）
   - [ ] 地理位置記錄

3. **數據加密**
   - [ ] 敏感欄位加密
   - [ ] 備份加密
   - [ ] 傳輸加密增強

4. **權限細化**
   - [ ] 只讀成員角色
   - [ ] 部分功能限制
   - [ ] 時間段訪問控制

5. **異常偵測**
   - [ ] 異常金額警告
   - [ ] 異常操作頻率警告
   - [ ] 自動封鎖機制

---

## 📞 技術支援

如有安全疑慮或發現漏洞，請：

1. **不要公開討論**
   - 避免在公開場合透露細節
   - 保護其他使用者

2. **聯絡管理員**
   - 通知試算表擁有者
   - 提供詳細資訊

3. **暫時停用**
   - 如果嚴重，暫時停用應用
   - 移除所有成員
   - 待修復後重新啟用

---

## 📊 資安評級

根據 OWASP Top 10 和一般資安最佳實踐：

| 項目 | 評級 | 說明 |
|------|------|------|
| 注入攻擊防護 | ⭐⭐⭐⭐⭐ | 完整的輸入驗證和 HTML 轉義 |
| 身份驗證 | ⭐⭐⭐⭐☆ | 使用 Google OAuth，建議啟用 2FA |
| 敏感資料保護 | ⭐⭐⭐☆☆ | 依賴 Google 安全，明文儲存 |
| 訪問控制 | ⭐⭐⭐⭐☆ | 白名單機制和角色權限 |
| 安全配置 | ⭐⭐⭐⭐☆ | 使用 Google 預設安全配置 |
| XSS 防護 | ⭐⭐⭐⭐⭐ | 前後端雙重 HTML 轉義 |
| 日誌與監控 | ⭐⭐⭐⭐☆ | 完整操作日誌 |

**總體評價：** ⭐⭐⭐⭐☆ (4/5)

**適用場景：**
- ✅ 情侶或家人記帳
- ✅ 小型團隊費用追蹤
- ✅ 一般日常開銷記錄

**不適用場景：**
- ❌ 企業財務系統
- ❌ 需要審計合規的場景
- ❌ 處理極度敏感的財務資訊

---

最後更新：2024
版本：v2.0 (含資安增強)
