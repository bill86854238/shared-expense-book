# 💑 共同記帳系統

> 基於 Google Apps Script 的免費記帳系統，適合情侶、室友、家庭使用

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Google Apps Script](https://img.shields.io/badge/Google%20Apps%20Script-v8-blue.svg)](https://developers.google.com/apps-script)
[![Version](https://img.shields.io/badge/Version-v2.56-blue.svg)](https://github.com/bill86854238/shared-expense-book/releases/tag/v2.56)
[![Security: 5/5](https://img.shields.io/badge/Security-⭐⭐⭐⭐⭐-brightgreen.svg)](./最終安全報告.md)

## ✨ 特色

- 💰 **完全免費** - 基於 Google Apps Script，無需付費伺服器
- 🔒 **安全可靠** - 5 星安全等級，完整的 XSS、注入攻擊防護
- ☁️ **雲端同步** - 數據存在您自己的 Google 試算表
- 📱 **響應式設計** - 支援手機、平板、電腦
- 🎭 **雙模式記帳** - 個人記帳 / 共同記帳一鍵切換
- 💵 **個人記帳** - 收入+支出記錄，自動計算淨收入
- 💑 **共同記帳** - 支援不等額墊付、自動結算
- 📥 **資料匯入** - 支援 SettleUp、AndroMoney 匯入
- 🎨 **個人化介面** - 4種配色主題，設定自動記憶
- 📊 **豐富圖表** - Google Charts 專業視覺化
- 👥 **成員管理** - 支援 Google 登入、邀請成員、權限控制
- ⚡ **快速記帳** - 一鍵快速記帳按鈕（可帶入分類）
- 📈 **儀表板分析** - 支援多時間範圍切換（本月、上月、最近 7/30 天、月度比較）
- 🏷️ **彈性分類** - 主分類+子分類階層式管理，支援自訂

## 🎯 適用場景

✅ 情侶共同記帳
✅ 室友分攤費用
✅ 朋友旅遊分帳
✅ 家庭日常開銷
✅ 小型團隊費用追蹤
✅ 個人財務管理

## 📸 主要功能

### 💰 記帳功能

**共同記帳模式**：
- ✅ 新增支出記錄
  - **靈活付款人選項**：我、對方、各付各的
  - **彈性分帳系統**：
    - 🔹 自動均分（預設）
    - 🔹 金額分帳（自訂各成員金額）
    - 🔹 比例分帳（依百分比分配）
  - **不等額墊付**：記錄誰實際付錢 vs 誰該負擔費用
- ✅ 智能結算（自動計算換誰付款）
- ✅ 週期性支出（房租、訂閱等自動記帳）

**個人記帳模式**：
- ✅ 新增收入記錄（薪水、獎金、投資收益等 9 種分類）
- ✅ 新增支出記錄
- ✅ 收入/支出分開統計
- ✅ 自動計算淨收入（收入 - 支出）

**通用功能**：
- ✅ 編輯/刪除記錄
- ✅ 查詢與篩選（日期、分類、付款人）
- ✅ CSV 匯出
- ✅ 資料匯入
  - **SettleUp 匯入**：從拆帳軟體匯入歷史記錄
  - **AndroMoney 匯入**：從記帳軟體匯入個人帳本

### 👥 成員管理
- ✅ Google 帳號登入
- ✅ 顯示用戶頭像和名稱
- ✅ 邀請成員（Email 邀請函）
- ✅ 成員列表管理
- ✅ 移除成員
- ✅ 權限控制（白名單機制）

### 📊 數據分析

**共同記帳模式**：
- ✅ **儀表板**（可切換時間範圍）
  - 總支出、記錄數、分類占比
  - 本月、上月、最近 7/30 天
  - 本月 vs 上月比較（含增減趨勢）
- ✅ **圖表分析**（三個標籤頁）
  - 分類分析（圓餅圖 + 長條圖）
  - 趨勢圖表（每日趨勢線圖 + 月度柱狀圖）
  - 付款分析（圓餅圖 + 長條圖）

**個人記帳模式**：
- ✅ **儀表板統計**
  - 總收入、總支出、淨收入（綠色/紅色標示）
  - 收入次數、支出次數、總記錄數
  - 支出分類占比
- ✅ **圖表分析**
  - 收支趨勢圖
  - 分類分析圖

### ⚡ 快速功能
- ✅ 快速記帳按鈕（早餐、午餐、晚餐、咖啡、飲料、交通、購物等）
- ✅ 週期性支出自動執行
- ✅ 每日觸發器

### 🛡️ 安全防護
- ✅ 輸入驗證（前後端雙重驗證）
- ✅ XSS 防護（HTML 轉義）
- ✅ 頻率限制（防濫用，每分鐘 50 次）
- ✅ 操作日誌（完整記錄，自動保護）
- ✅ 權限控制（白名單機制）
- ✅ HTTPS 驗證

> 📋 詳細功能清單請參考：[完整功能清單.md](./完整功能清單.md)

## 🚀 快速開始

### 前置需求

- Google 帳號
- 5-10 分鐘的時間

### ⚠️ 重要提醒

**請務必按照順序操作：**

```
✅ 正確流程：
1. 先建立 Google 試算表
2. 在試算表中開啟 Apps Script（工具 → Apps Script）
3. 複製代碼

❌ 錯誤流程：
不要直接去 script.google.com 建立獨立腳本
（這樣腳本不會綁定試算表，會很麻煩！）
```

---

### 部署步驟

#### 步驟 1：建立 Google 試算表 📊

1. 開啟 [Google 試算表](https://sheets.google.com)
2. 點擊左上角「空白」建立新試算表
3. 將試算表命名為「共同記帳」（或任何您喜歡的名稱）

> 💡 **重要**：記住這個試算表，所有數據都會存在這裡！

#### 步驟 2：開啟 Apps Script 編輯器 📝

1. 在**剛剛建立的試算表**中
2. 點擊上方選單 **工具** → **Apps Script**
3. Apps Script 編輯器會在新分頁開啟

> 💡 這樣 Apps Script 會自動綁定這個試算表！

#### 步驟 3：複製代碼 📋

**3.1 複製後端代碼**
1. 刪除編輯器中預設的 `function myFunction() {...}`
2. 從 GitHub 複製 [`Code.gs`](./Code.gs) 的完整內容
3. 貼上到編輯器中
4. 按 `Ctrl+S` 儲存（或點擊磁碟圖示）

**3.2 複製前端代碼（兩個檔案）**

**index.html（主界面）**
1. 點擊左側 **+** 號 → 選擇 **HTML**
2. 檔名輸入 `index`（不需要 .html 副檔名）
3. 從 GitHub 複製 [`index.html`](./index.html) 的完整內容
4. 貼上到 index.html 中
5. 按 `Ctrl+S` 儲存

**nameSelector.html（名稱選擇器）**
1. 再次點擊左側 **+** 號 → 選擇 **HTML**
2. 檔名輸入 `nameSelector`
3. 從 GitHub 複製 [`nameSelector.html`](./nameSelector.html) 的完整內容
4. 貼上並儲存

> 💡 總共需要 **3 個檔案**：Code.gs、index.html、nameSelector.html

#### 步驟 4：啟用 People API 🔧

1. 點擊左側 **服務**（齒輪圖示旁）
2. 搜尋「**Google People API**」
3. 選擇版本 **v1**
4. 點擊 **新增**

> 💡 這個 API 用來顯示使用者頭像

#### 步驟 5：部署為 Web 應用 🌐

1. 點擊右上角 **部署** → **新部署**
2. 點擊「選擇類型」齒輪圖示 → 選擇 **網頁應用程式**
3. 填寫設定：
   - **說明**：`初始版本` 或 `v1.0`
   - **執行身分**：選擇 **我**
   - **具有存取權的使用者**：選擇 **任何人**
4. 點擊 **部署**
5. 第一次會要求授權：
   - 點擊「授權存取」
   - 選擇您的 Google 帳號
   - 點擊「進階」→「前往 XXX（不安全）」
   - 允許所需權限
6. **複製部署 URL**（非常重要！這就是您的記帳系統網址）

#### 步驟 6：初始化系統 🚀

1. 回到 **Google 試算表**（重新整理頁面 F5）
2. 會看到新選單 **📊 記帳系統**
3. 點擊 **📊 記帳系統** → **🚀 初始化系統**
4. 等待 3-5 秒，系統會自動建立工作表：
   - ✅ 支出記錄
   - ✅ 週期設定
   - ✅ 設定

#### 步驟 7：設定白名單（權限控制）🔐

1. 在試算表中，打開 **設定** 工作表
2. 找到 **B5** 欄位「允許存取的使用者」
3. 填入允許使用的 Email（用逗號分隔）：
   ```
   your-email@gmail.com, partner-email@gmail.com
   ```
4. 試算表擁有者（就是您）會自動有權限

#### 步驟 8：開始使用！🎉

1. 在瀏覽器開啟剛剛複製的 **部署 URL**
2. 用 Google 帳號登入
3. 開始記帳！

---

### 🎬 快速演示

```
試算表 → 工具 → Apps Script → 複製代碼 → 部署 → 初始化 → 完成！
```

> 📖 **遇到問題？** 查看詳細教學：[最終部署指南.md](./最終部署指南.md)
> ❓ **常見問題？** 查看 [FAQ.md](./FAQ.md)（38 個常見問題解答）

## 📚 文檔

| 文檔 | 說明 |
|------|------|
| [最終部署指南.md](./最終部署指南.md) | 完整的部署和使用指南（含故障排除） |
| [最終安全報告.md](./最終安全報告.md) | 安全性分析報告（14個漏洞修復記錄） |
| [FAQ.md](./FAQ.md) | 常見問題解答 |
| [成員管理說明.md](./成員管理說明.md) | 成員管理功能詳解 |
| [完整功能清單.md](./完整功能清單.md) | 30+ 功能總覽 |

## 🎯 系統架構

```
使用者瀏覽器
    ↓
Google Apps Script Web App
    ├─ Google OAuth 認證
    ├─ People API（用戶頭像）
    └─ MailApp（邀請郵件）
    ↓
Google 試算表（數據儲存）
    ├─ 支出記錄
    ├─ 週期設定
    ├─ 設定（白名單）
    └─ 操作日誌（自動保護）
```

**重要特點**：
- ✅ **完全分散式架構** - 每個使用者部署獨立系統
- ✅ **數據自主** - 數據存在各自的 Google 試算表
- ✅ **零維護成本** - 不需要外部伺服器或資料庫
- ✅ **隱私保護** - 您的數據只有您能看到

## 🔧 技術棧

| 類別 | 技術 |
|------|------|
| 後端 | Google Apps Script (JavaScript) |
| 前端 | HTML5 + CSS3 + Vanilla JavaScript |
| 數據庫 | Google Sheets |
| 認證 | Google OAuth 2.0 |
| 圖表 | Google Charts |
| API | Google People API v1、MailApp |

## 📊 系統限制

| 項目 | 限制 |
|------|------|
| 最大記錄數 | 10,000+ 筆 |
| 建議成員數 | 2-5 人 |
| 頁面載入時間 | < 2 秒 |
| 操作響應時間 | < 1 秒 |
| 每日郵件配額 | 100 封/天 |
| 頻率限制 | 50 次/分鐘 |

## 🛡️ 安全性

本系統經過完整的安全審查，修復了 14 個安全漏洞：

### 已修復的高危漏洞 (HIGH)
- ✅ Toast 消息 XSS 攻擊
- ✅ 用戶頭像 URL XSS 攻擊
- ✅ 郵件模板 XSS 攻擊
- ✅ Web App 連結 XSS 攻擊

### 已修復的中危漏洞 (MEDIUM)
- ✅ getExpenses 缺少權限檢查
- ✅ deleteExpenseById 水平權限提升
- ✅ 登出機制不完整
- ✅ 點擊劫持風險 (Clickjacking)

### 安全等級：⭐⭐⭐⭐⭐ (5/5)

> 📋 詳細安全報告：[最終安全報告.md](./最終安全報告.md)

## 💡 使用範例

### 情境 1：外食平分
```
項目：晚餐
金額：600
誰付錢：我
幫誰付款：☑我 ☑對方
分帳方式：自動均分
結果：你 $300，對方 $300
```

### 情境 2：我先墊付，但對方要全額負擔
```
項目：對方的藥品
金額：500
誰付錢：我
幫誰付款：☑對方（不勾我）
結果：你 $0，對方 $500（我先墊付，之後對方要還）
```

### 情境 3：不等額分帳（比例分配）
```
項目：租屋押金
金額：30000
誰付錢：我
幫誰付款：☑我 ☑對方
分帳方式：比例分帳
你的比例：60%，對方的比例：40%
結果：你 $18000，對方 $12000
```

### 情境 4：不等額分帳（指定金額）
```
項目：網路費
金額：500
誰付錢：對方
幫誰付款：☑我 ☑對方
分帳方式：金額分帳
你的部分：$300，對方的部分：$200
結果：你 $300，對方 $200
```

### 情境 5：設定房租週期
```
在「週期設定」工作表：
項目：房租
金額：15000
付款人：你
每月執行日：1
→ 每月 1 號早上 9:00 自動記帳
```

### 情境 6：邀請室友加入
```
1. 點擊右上角「成員」按鈕
2. 輸入室友的 Gmail
3. 點擊「發送邀請」
4. 室友收到郵件，點擊連結即可使用
```

### 情境 7：個人記帳 - 新增收入
```
切換到「個人記帳」模式
點擊「新增收入」
項目：公司薪水
金額：50000
收入分類：💼 薪水
結果：儀表板顯示總收入 $50000
```

### 情境 8：個人記帳 - 查看淨收入
```
本月收入：60000（薪水 50000 + 獎金 10000）
本月支出：35000（各項生活開銷）
儀表板自動計算：
淨收入：+$25000（綠色顯示）
```

### 情境 9：匯入 SettleUp/AndroMoney
```
1. 匯出 CSV 檔案
2. 將 CSV 匯入 Google Sheets
3. 在試算表選單：📊 記帳系統 → 📥 匯入資料
4. 選擇 SettleUp 或 AndroMoney
5. 系統自動轉換分類和金額
```

## ❓ 常見問題

### Q: 如何分享給別人使用？
**A:** 有三種方式：
1. **邀請成員**（推薦）- 使用界面的「成員」功能發送邀請
2. **手動添加** - 在「設定」工作表的白名單中添加 Email
3. **分享連結** - 先添加白名單，再分享部署 URL

### Q: 別人部署後會連到我的試算表嗎？
**A:** 不會！每個人部署的是完全獨立的系統，數據存在各自的 Google 試算表。

### Q: 需要付費嗎？
**A:** 完全免費！基於 Google Apps Script，沒有任何費用。

### Q: 數據安全嗎？
**A:** 非常安全！
- 數據存在您自己的 Google 試算表
- 經過完整的安全審查（5星安全等級）
- 只有白名單內的人能訪問

### Q: 如何從舊版本升級到 v2.56？
**A:** 非常簡單！
1. 更新 Code.gs、index.html、nameSelector.html 三個檔案
2. 重新部署（部署 → 管理部署 → 編輯 → 版本：新版本）
3. 在試算表選單執行：📊 記帳系統 → 🔄 升級到最新版本
4. 所有舊記錄都會保留！資料結構向後相容

### Q: v2.56 有哪些新功能？
**A:** 主要更新：
- ✅ 個人記帳新增收入記錄功能
- ✅ 儀表板顯示總收入、總支出、淨收入
- ✅ 獨立的收入分類系統
- ✅ 快速記帳支援帶入分類
- ✅ 修復模式同步問題

> 📋 更多問題請參考：[FAQ.md](./FAQ.md)

## 🤝 貢獻

歡迎提交 Issue 或 Pull Request！

如果您有任何建議或發現問題，請隨時告訴我。

## ⚠️ 免責聲明

- 這是個人免費分享的專案
- 數據存在您自己的 Google 試算表，由您完全掌控
- 提供基本部署教學，進階問題不一定能回答
- 使用本系統產生的任何問題，作者不負責任

## 📝 授權

本專案採用 [MIT License](./LICENSE) 授權

您可以自由：
- ✅ 使用
- ✅ 修改
- ✅ 分發
- ✅ 商業使用

唯一要求：保留原作者版權聲明

## 🌟 致謝

感謝所有使用和支持這個專案的朋友！

如果這個專案對您有幫助，歡迎：
- ⭐ 給個 Star
- 📢 分享給需要的朋友
- 💬 提供反饋和建議

---

**讓錢的事變簡單！** 💑💰✨

---

**最後更新**：2025-01-25
**版本**：v2.56
**狀態**：✅ 穩定版本

### 🆕 最新更新 (v2.56)

- 💵 **個人記帳增強** - 新增收入記錄功能，收支分開統計
- 📊 **儀表板優化** - 個人模式顯示總收入、總支出、淨收入（綠色/紅色標示）
- 🏷️ **收入分類系統** - 獨立的收入分類（薪水、獎金、投資收益等 9 種）
- ⚡ **快速記帳優化** - 支援帶入分類（如「飲食>早餐」）
- 🔄 **穩定性修復** - 修復個人/共同模式前後端同步問題
- 🎯 **精簡核心** - 移除多幣別、付款帳戶、專案管理功能

> 🚀 **未來計畫**：正在開發新架構版本，將支援更多進階功能

### 📜 版本歷史

**v2.56** (2025-01)
- 個人記帳增加收入功能
- 儀表板顯示淨收入
- 修復模式同步問題

**v2.21** (2024)
- 個人/共同記帳雙模式
- 4種配色主題
- 階層式分類系統
